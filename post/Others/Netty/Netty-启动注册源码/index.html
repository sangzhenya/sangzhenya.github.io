<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Netty 源码 | 新月的博客</title>
    <meta property="og:title" content="Netty 源码 - 新月的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-03-21T09:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-03-21T09:00:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Netty 源码">
        
    <meta name="author" content="新月">
    <meta property="og:url" content="https://sangzhenya.github.io/post/Others/Netty/Netty-%E5%90%AF%E5%8A%A8%E6%B3%A8%E5%86%8C%E6%BA%90%E7%A0%81/">
    <link rel="shortcut icon" href="https://sangzhenya.github.io/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='https://sangzhenya.github.io/css/normalize.css'>
    <link rel="stylesheet" href='https://sangzhenya.github.io/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://sangzhenya.github.io/">
                        新月的博客
                    </a>
                
                <p class="description">晚来天欲雪，能饮一杯无？</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://sangzhenya.github.io/">首页</a>
                    
                    <a  href="https://sangzhenya.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://sangzhenya.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Netty 源码</h1>
        </header>
        <date class="post-meta meta-date">
            2019年3月21日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='https://sangzhenya.github.io/categories/Netty'>Netty</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>一个 Server 端的 Sample Code 如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">EchoServer</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">boolean</span> SSL <span style="color:#000;font-weight:bold">=</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ssl&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">int</span> PORT <span style="color:#000;font-weight:bold">=</span> Integer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseInt</span><span style="color:#000;font-weight:bold">(</span>System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;port&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;8007&#34;</span><span style="color:#000;font-weight:bold">));</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 配置 SSL 的信息
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">final</span> SslContext sslCtx<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>SSL<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            SelfSignedCertificate ssc <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SelfSignedCertificate<span style="color:#000;font-weight:bold">();</span>
            sslCtx <span style="color:#000;font-weight:bold">=</span> SslContextBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forServer</span><span style="color:#000;font-weight:bold">(</span>ssc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">certificate</span><span style="color:#000;font-weight:bold">(),</span> ssc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">privateKey</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            sslCtx <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#998;font-style:italic">// 配置 Server 的信息
</span><span style="color:#998;font-style:italic"></span>        EventLoopGroup bossGroup <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> NioEventLoopGroup<span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
        EventLoopGroup workerGroup <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> NioEventLoopGroup<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">final</span> EchoServerHandler serverHandler <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> EchoServerHandler<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            ServerBootstrap b <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ServerBootstrap<span style="color:#000;font-weight:bold">();</span>
            b<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">group</span><span style="color:#000;font-weight:bold">(</span>bossGroup<span style="color:#000;font-weight:bold">,</span> workerGroup<span style="color:#000;font-weight:bold">)</span>
             <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">channel</span><span style="color:#000;font-weight:bold">(</span>NioServerSocketChannel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
             <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">option</span><span style="color:#000;font-weight:bold">(</span>ChannelOption<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SO_BACKLOG</span><span style="color:#000;font-weight:bold">,</span> 100<span style="color:#000;font-weight:bold">)</span>
              <span style="color:#998;font-style:italic">// ServerSocketChannel Handler
</span><span style="color:#998;font-style:italic"></span>             <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> LoggingHandler<span style="color:#000;font-weight:bold">(</span>LogLevel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INFO</span><span style="color:#000;font-weight:bold">))</span>
              <span style="color:#998;font-style:italic">// SocketChannel Handler
</span><span style="color:#998;font-style:italic"></span>             <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">childHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ChannelInitializer<span style="color:#000;font-weight:bold">&lt;</span>SocketChannel<span style="color:#000;font-weight:bold">&gt;()</span> <span style="color:#000;font-weight:bold">{</span>
                 <span style="color:#3c5d5d;font-weight:bold">@Override</span>
                 <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">initChannel</span><span style="color:#000;font-weight:bold">(</span>SocketChannel ch<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                     ChannelPipeline p <span style="color:#000;font-weight:bold">=</span> ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">pipeline</span><span style="color:#000;font-weight:bold">();</span>
                     <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>sslCtx <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                         p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addLast</span><span style="color:#000;font-weight:bold">(</span>sslCtx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newHandler</span><span style="color:#000;font-weight:bold">(</span>ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">alloc</span><span style="color:#000;font-weight:bold">()));</span>
                     <span style="color:#000;font-weight:bold">}</span>
                     <span style="color:#998;font-style:italic">//p.addLast(new LoggingHandler(LogLevel.INFO));
</span><span style="color:#998;font-style:italic"></span>                     p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addLast</span><span style="color:#000;font-weight:bold">(</span>serverHandler<span style="color:#000;font-weight:bold">);</span>
                 <span style="color:#000;font-weight:bold">}</span>
             <span style="color:#000;font-weight:bold">});</span>

            <span style="color:#998;font-style:italic">// 绑定端口并等待完成
</span><span style="color:#998;font-style:italic"></span>            ChannelFuture f <span style="color:#000;font-weight:bold">=</span> b<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>PORT<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">sync</span><span style="color:#000;font-weight:bold">();</span>

            <span style="color:#998;font-style:italic">// 等待 Channel 关闭
</span><span style="color:#998;font-style:italic"></span>            f<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">channel</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">closeFuture</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">sync</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// Shut down all event loops to terminate all threads.
</span><span style="color:#998;font-style:italic"></span>            bossGroup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">shutdownGracefully</span><span style="color:#000;font-weight:bold">();</span>
            workerGroup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">shutdownGracefully</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在配置 Server 中两个是 EventLoopGroup 是核心对象，其中 bossGroup 用于接收 TCP 请求，然后转发给 workerGroup，workerGroup 会获取到真正的连接并和连接进行通讯，例如读写解编码。其中 EventLoopGroup 是事件循环组即线程组，含有多个 EventLoop，可以注册 Channel，用于在事件循环中进行选择。如下图所示：</p>
<p><img src="http://img.programya.com/image-20200122005440647.png" alt=""></p>
<p>EventLoopGroup 创建的时候其父类 MultithreadEventLoopGroup 中的构造方法，如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#900;font-weight:bold">MultithreadEventLoopGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> nThreads<span style="color:#000;font-weight:bold">,</span> Executor executor<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">...</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 这里可以看出如果未收到设置线程数量，则默认使用 DEFAULT_EVENT_LOOP_THREADS 的值
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 而 DEFAULT_EVENT_LOOP_THREADS 的值取值逻辑是 Math.max(1, SystemPropertyUtil.getInt(&#34;io.netty.eventLoopThreads&#34;, 
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// NettyRuntime.availableProcessors() * 2)); 即 CPU 核心数量的 * 2
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span>nThreads <span style="color:#000;font-weight:bold">==</span> 0 <span style="color:#000;font-weight:bold">?</span> DEFAULT_EVENT_LOOP_THREADS <span style="color:#000;font-weight:bold">:</span> nThreads<span style="color:#000;font-weight:bold">,</span> executor<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后上面会继续调用父类 MultithreadEventExecutorGroup  的构造方法如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#900;font-weight:bold">MultithreadEventExecutorGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> nThreads<span style="color:#000;font-weight:bold">,</span> Executor executor<span style="color:#000;font-weight:bold">,</span>
                                            EventExecutorChooserFactory chooserFactory<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">...</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 确保线程数大于 0
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>nThreads <span style="color:#000;font-weight:bold">&lt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;nThreads: %d (expected: &gt; 0)&#34;</span><span style="color:#000;font-weight:bold">,</span> nThreads<span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 使用默认的线程工厂创建一个 ThreadPerTaskExecutor
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>executor <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    executor <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ThreadPerTaskExecutor<span style="color:#000;font-weight:bold">(</span>newDefaultThreadFactory<span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 根据线程数创建一个固定大小的 EventExecutor ，EventLoop 是其实现类
</span><span style="color:#998;font-style:italic"></span>  children <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> EventExecutor<span style="color:#000;font-weight:bold">[</span>nThreads<span style="color:#000;font-weight:bold">];</span>

  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> nThreads<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">boolean</span> success <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 使用 executor 和 args 创建一个 EventLoop 对象作为 Child
</span><span style="color:#998;font-style:italic"></span>      children<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> newChild<span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
      success <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// TODO: Think about if this is a good exception type
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;failed to create a child event loop&#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 如果任何一个 Child 创建失败则关闭所有已经成功创建的 Child
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>success<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> j <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> j <span style="color:#000;font-weight:bold">&lt;</span> i<span style="color:#000;font-weight:bold">;</span> j <span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
          children<span style="color:#000;font-weight:bold">[</span>j<span style="color:#000;font-weight:bold">].</span><span style="color:#008080">shutdownGracefully</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> j <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> j <span style="color:#000;font-weight:bold">&lt;</span> i<span style="color:#000;font-weight:bold">;</span> j <span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
          EventExecutor e <span style="color:#000;font-weight:bold">=</span> children<span style="color:#000;font-weight:bold">[</span>j<span style="color:#000;font-weight:bold">];</span>
          <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(!</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isTerminated</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
              e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">awaitTermination</span><span style="color:#000;font-weight:bold">(</span>Integer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MAX_VALUE</span><span style="color:#000;font-weight:bold">,</span> TimeUnit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SECONDS</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException interrupted<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// Let the caller handle the interruption.
</span><span style="color:#998;font-style:italic"></span>            Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentThread</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">interrupt</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 根据 children 的数量选择一个 chooser
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// Default implementation which uses simple round-robin to choose next
</span><span style="color:#998;font-style:italic"></span>  chooser <span style="color:#000;font-weight:bold">=</span> chooserFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newChooser</span><span style="color:#000;font-weight:bold">(</span>children<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 创建 terminationListener 并逐个设置到 Children 上
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> FutureListener<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> terminationListener <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> FutureListener<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">operationComplete</span><span style="color:#000;font-weight:bold">(</span>Future<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> future<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>terminatedChildren<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">incrementAndGet</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> children<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        terminationFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSuccess</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>EventExecutor e<span style="color:#000;font-weight:bold">:</span> children<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">terminationFuture</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">addListener</span><span style="color:#000;font-weight:bold">(</span>terminationListener<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 将 Children 放到链表中并设置为只读
</span><span style="color:#998;font-style:italic"></span>  Set<span style="color:#000;font-weight:bold">&lt;</span>EventExecutor<span style="color:#000;font-weight:bold">&gt;</span> childrenSet <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> LinkedHashSet<span style="color:#000;font-weight:bold">&lt;</span>EventExecutor<span style="color:#000;font-weight:bold">&gt;(</span>children<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">);</span>
  Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAll</span><span style="color:#000;font-weight:bold">(</span>childrenSet<span style="color:#000;font-weight:bold">,</span> children<span style="color:#000;font-weight:bold">);</span>
  readonlyChildren <span style="color:#000;font-weight:bold">=</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unmodifiableSet</span><span style="color:#000;font-weight:bold">(</span>childrenSet<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Child 的创建方法如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">protected</span> EventLoop <span style="color:#900;font-weight:bold">newChild</span><span style="color:#000;font-weight:bold">(</span>Executor executor<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">...</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
    EventLoopTaskQueueFactory queueFactory <span style="color:#000;font-weight:bold">=</span> args<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 4 <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">(</span>EventLoopTaskQueueFactory<span style="color:#000;font-weight:bold">)</span> args<span style="color:#000;font-weight:bold">[</span>3<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  	<span style="color:#998;font-style:italic">// 创建一个 NioEventLoop，基本上就是将传入的参数设置成为其全局属性值
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> NioEventLoop<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> executor<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>SelectorProvider<span style="color:#000;font-weight:bold">)</span> args<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">],</span>
        <span style="color:#000;font-weight:bold">((</span>SelectStrategyFactory<span style="color:#000;font-weight:bold">)</span> args<span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]).</span><span style="color:#008080">newSelectStrategy</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">(</span>RejectedExecutionHandler<span style="color:#000;font-weight:bold">)</span> args<span style="color:#000;font-weight:bold">[</span>2<span style="color:#000;font-weight:bold">],</span> queueFactory<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>NioEventLoop 和 NioEventLoopGroup 的类继承关系如下：</p>
<p><img src="http://img.programya.com/image-20200122011533509.png" alt=""></p>
<p>除了两个 EventLoopGroup 外还有一个 ServerBootstrap 对象，其是一个引导类，用于启动服务器和引导整个程序的初始化，其和 ServerChannel 关联，ServerChannel 是 Channel 的子接口。</p>
<p>然后调用其 group 方法，传入两个 EventLoopGroup，第一个是 parentGroup 即 acceptor，第二个是 childGroup 即 client，都使用用于处理 ServerChannel 的事件和 IO。</p>
<p>然后调用 channel 方法设置需要初始化 Channel 实例的时候使用的子类：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> B <span style="color:#900;font-weight:bold">channel</span><span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> C<span style="color:#000;font-weight:bold">&gt;</span> channelClass<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> channelFactory<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ReflectiveChannelFactory<span style="color:#000;font-weight:bold">&lt;</span>C<span style="color:#000;font-weight:bold">&gt;(</span>
            ObjectUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkNotNull</span><span style="color:#000;font-weight:bold">(</span>channelClass<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;channelClass&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后调用 option 方法设置一些属性相关的信息：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> B <span style="color:#900;font-weight:bold">option</span><span style="color:#000;font-weight:bold">(</span>ChannelOption<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> option<span style="color:#000;font-weight:bold">,</span> T value<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  ObjectUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkNotNull</span><span style="color:#000;font-weight:bold">(</span>option<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;option&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    options<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>option<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    options<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>option<span style="color:#000;font-weight:bold">,</span> value<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> self<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后调用 handler 方法设置用于处理 request 的 handler 信息：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> B <span style="color:#900;font-weight:bold">handler</span><span style="color:#000;font-weight:bold">(</span>ChannelHandler handler<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">handler</span> <span style="color:#000;font-weight:bold">=</span> ObjectUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkNotNull</span><span style="color:#000;font-weight:bold">(</span>handler<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;handler&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> self<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后调用 childHandler 方法设置用于处理 Channel 的request 的类。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> ServerBootstrap <span style="color:#900;font-weight:bold">childHandler</span><span style="color:#000;font-weight:bold">(</span>ChannelHandler childHandler<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">childHandler</span> <span style="color:#000;font-weight:bold">=</span> ObjectUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkNotNull</span><span style="color:#000;font-weight:bold">(</span>childHandler<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;childHandler&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>build 完成之后就可以调用 ServerBootstrap 的 bind 方法绑定一个端口了，绑定方法返回的是一个 ChannelFuture 对象。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> ChannelFuture <span style="color:#900;font-weight:bold">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> inetPort<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 基于端口的信息创建一个 InetSocketAddress，用于 Netty 端口的绑定
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> bind<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> InetSocketAddress<span style="color:#000;font-weight:bold">(</span>inetPort<span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>具体的绑定逻辑在 doBind 方法中</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> ChannelFuture <span style="color:#900;font-weight:bold">doBind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> SocketAddress localAddress<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 首先是初始化及注册
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">final</span> ChannelFuture regFuture <span style="color:#000;font-weight:bold">=</span> initAndRegister<span style="color:#000;font-weight:bold">();</span>
  	<span style="color:#998;font-style:italic">// 获取注册的 Channel
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">final</span> Channel channel <span style="color:#000;font-weight:bold">=</span> regFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">channel</span><span style="color:#000;font-weight:bold">();</span>
  	<span style="color:#998;font-style:italic">// 如果异常则直接返回
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>regFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cause</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> regFuture<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>regFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isDone</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 如果成功则继续处理
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// At this point we know that the registration was complete and successful.
</span><span style="color:#998;font-style:italic"></span>        ChannelPromise promise <span style="color:#000;font-weight:bold">=</span> channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newPromise</span><span style="color:#000;font-weight:bold">();</span>
        doBind0<span style="color:#000;font-weight:bold">(</span>regFuture<span style="color:#000;font-weight:bold">,</span> channel<span style="color:#000;font-weight:bold">,</span> localAddress<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">return</span> promise<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      	<span style="color:#998;font-style:italic">// 如果还没有处理完，则添加一个 listener 等处理完之后继续进行 bind 操作
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// Registration future is almost always fulfilled already, but just in case it&#39;s not.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">final</span> PendingRegistrationPromise promise <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> PendingRegistrationPromise<span style="color:#000;font-weight:bold">(</span>channel<span style="color:#000;font-weight:bold">);</span>
        regFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ChannelFutureListener<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#3c5d5d;font-weight:bold">@Override</span>
            <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">operationComplete</span><span style="color:#000;font-weight:bold">(</span>ChannelFuture future<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
                Throwable cause <span style="color:#000;font-weight:bold">=</span> future<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cause</span><span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cause <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#998;font-style:italic">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#998;font-style:italic">// IllegalStateException once we try to access the EventLoop of the Channel.
</span><span style="color:#998;font-style:italic"></span>                    promise<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setFailure</span><span style="color:#000;font-weight:bold">(</span>cause<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#998;font-style:italic">// Registration was successful, so set the correct executor to use.
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#998;font-style:italic">// See https://github.com/netty/netty/issues/2586
</span><span style="color:#998;font-style:italic"></span>                    promise<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registered</span><span style="color:#000;font-weight:bold">();</span>

                    doBind0<span style="color:#000;font-weight:bold">(</span>regFuture<span style="color:#000;font-weight:bold">,</span> channel<span style="color:#000;font-weight:bold">,</span> localAddress<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">});</span>
        <span style="color:#000;font-weight:bold">return</span> promise<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">final</span> ChannelFuture <span style="color:#900;font-weight:bold">initAndRegister</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  Channel channel <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 使用 ChannelFactory(基于 Channel 方法设置获取的工厂) 创建一个 Channel
</span><span style="color:#998;font-style:italic"></span>    channel <span style="color:#000;font-weight:bold">=</span> channelFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newChannel</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 初始化 Channel
</span><span style="color:#998;font-style:italic"></span>    init<span style="color:#000;font-weight:bold">(</span>channel<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>channel <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// channel can be null if newChannel crashed (eg SocketException(&#34;too many open files&#34;))
</span><span style="color:#998;font-style:italic"></span>      channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unsafe</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">closeForcibly</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#998;font-style:italic">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DefaultChannelPromise<span style="color:#000;font-weight:bold">(</span>channel<span style="color:#000;font-weight:bold">,</span> GlobalEventExecutor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INSTANCE</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">setFailure</span><span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DefaultChannelPromise<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> FailedChannel<span style="color:#000;font-weight:bold">(),</span> GlobalEventExecutor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INSTANCE</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">setFailure</span><span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 将 Channel 注册到一个 EventLoop 上，返回一个 channelPromise 是 ChannelFuture 的子接口
</span><span style="color:#998;font-style:italic"></span>  ChannelFuture regFuture <span style="color:#000;font-weight:bold">=</span> config<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">group</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>channel<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 如果注册失败了则关闭 Channel
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>regFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cause</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isRegistered</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">close</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unsafe</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">closeForcibly</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// If we are here and the promise is not failed, it&#39;s one of the following cases:
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 1) If we attempted registration from the event loop, the registration has been completed at this point.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//    i.e. It&#39;s safe to attempt bind() or connect() now because the channel has been registered.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 2) If we attempted registration from the other thread, the registration request has been successfully
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//    added to the event loop&#39;s task queue for later execution.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//    i.e. It&#39;s safe to attempt bind() or connect() now:
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//         because bind() or connect() will be executed *after* the scheduled registration task is executed
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//         because register(), bind(), and connect() are all bound to the same thread.
</span><span style="color:#998;font-style:italic"></span>
  <span style="color:#000;font-weight:bold">return</span> regFuture<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">init</span><span style="color:#000;font-weight:bold">(</span>Channel channel<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
 	 <span style="color:#998;font-style:italic">// 设置 Channel 的一些配置信息
</span><span style="color:#998;font-style:italic"></span>    setChannelOptions<span style="color:#000;font-weight:bold">(</span>channel<span style="color:#000;font-weight:bold">,</span> options0<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">entrySet</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toArray</span><span style="color:#000;font-weight:bold">(</span>EMPTY_OPTION_ARRAY<span style="color:#000;font-weight:bold">),</span> logger<span style="color:#000;font-weight:bold">);</span>
    setAttributes<span style="color:#000;font-weight:bold">(</span>channel<span style="color:#000;font-weight:bold">,</span> attrs0<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">entrySet</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toArray</span><span style="color:#000;font-weight:bold">(</span>EMPTY_ATTRIBUTE_ARRAY<span style="color:#000;font-weight:bold">));</span>
		<span style="color:#998;font-style:italic">// 获取 Channel 对应的 pipeline
</span><span style="color:#998;font-style:italic"></span>    ChannelPipeline p <span style="color:#000;font-weight:bold">=</span> channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">pipeline</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">// 获取当前的 childGroup 和 childHandler 以及为 childChannel 设置的属性信息
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">final</span> EventLoopGroup currentChildGroup <span style="color:#000;font-weight:bold">=</span> childGroup<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">final</span> ChannelHandler currentChildHandler <span style="color:#000;font-weight:bold">=</span> childHandler<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">final</span> Entry<span style="color:#000;font-weight:bold">&lt;</span>ChannelOption<span style="color:#000;font-weight:bold">&lt;?&gt;,</span> Object<span style="color:#000;font-weight:bold">&gt;[]</span> currentChildOptions <span style="color:#000;font-weight:bold">=</span>
            childOptions<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">entrySet</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toArray</span><span style="color:#000;font-weight:bold">(</span>EMPTY_OPTION_ARRAY<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">final</span> Entry<span style="color:#000;font-weight:bold">&lt;</span>AttributeKey<span style="color:#000;font-weight:bold">&lt;?&gt;,</span> Object<span style="color:#000;font-weight:bold">&gt;[]</span> currentChildAttrs <span style="color:#000;font-weight:bold">=</span> childAttrs<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">entrySet</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toArray</span><span style="color:#000;font-weight:bold">(</span>EMPTY_ATTRIBUTE_ARRAY<span style="color:#000;font-weight:bold">);</span>

  	<span style="color:#998;font-style:italic">// 在 pipeline 上注册 handler
</span><span style="color:#998;font-style:italic"></span>    p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addLast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ChannelInitializer<span style="color:#000;font-weight:bold">&lt;</span>Channel<span style="color:#000;font-weight:bold">&gt;()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#3c5d5d;font-weight:bold">@Override</span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">initChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> Channel ch<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// 获取 Channel 对应的 pipeline 并将 config 中配置的 handler 添加到 pipeline 上
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">final</span> ChannelPipeline pipeline <span style="color:#000;font-weight:bold">=</span> ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">pipeline</span><span style="color:#000;font-weight:bold">();</span>
            ChannelHandler handler <span style="color:#000;font-weight:bold">=</span> config<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">handler</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>handler <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addLast</span><span style="color:#000;font-weight:bold">(</span>handler<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>

          	<span style="color:#998;font-style:italic">// 根据 Channel， currentChildGroup，currentChildHandler 创建一个 ServerBootstrapAcceptor 
</span><span style="color:#998;font-style:italic"></span>          	<span style="color:#998;font-style:italic">// 并将其添加到 pipeline 上。ServerBootstrapAcceptor 用于接收连接并将相关的事件注册到 childEventLoopGroup 中
</span><span style="color:#998;font-style:italic"></span>            ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">eventLoop</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Runnable<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#3c5d5d;font-weight:bold">@Override</span>
                <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                    pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addLast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ServerBootstrapAcceptor<span style="color:#000;font-weight:bold">(</span>
                            ch<span style="color:#000;font-weight:bold">,</span> currentChildGroup<span style="color:#000;font-weight:bold">,</span> currentChildHandler<span style="color:#000;font-weight:bold">,</span> currentChildOptions<span style="color:#000;font-weight:bold">,</span> currentChildAttrs<span style="color:#000;font-weight:bold">));</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">});</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doBind0</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">final</span> ChannelFuture regFuture<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">final</span> Channel channel<span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">final</span> SocketAddress localAddress<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">final</span> ChannelPromise promise<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>

  <span style="color:#998;font-style:italic">// 调用 Channel 的 bind 方法
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// the pipeline in its channelRegistered() implementation.
</span><span style="color:#998;font-style:italic"></span>  channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">eventLoop</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Runnable<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>regFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isSuccess</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        channel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>localAddress<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">addListener</span><span style="color:#000;font-weight:bold">(</span>ChannelFutureListener<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CLOSE_ON_FAILURE</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        promise<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setFailure</span><span style="color:#000;font-weight:bold">(</span>regFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cause</span><span style="color:#000;font-weight:bold">());</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最终会调用到 AbstractChannelHandlerContext 中的 bind 方法：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> ChannelFuture <span style="color:#900;font-weight:bold">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> SocketAddress localAddress<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">final</span> ChannelPromise promise<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  ObjectUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkNotNull</span><span style="color:#000;font-weight:bold">(</span>localAddress<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;localAddress&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isNotValidPromise<span style="color:#000;font-weight:bold">(</span>promise<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// cancelled
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> promise<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">final</span> AbstractChannelHandlerContext next <span style="color:#000;font-weight:bold">=</span> findContextOutbound<span style="color:#000;font-weight:bold">(</span>MASK_BIND<span style="color:#000;font-weight:bold">);</span>
 	<span style="color:#998;font-style:italic">// 获取 executor
</span><span style="color:#998;font-style:italic"></span>  EventExecutor executor <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executor</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">inEventLoop</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// invoke bind 方法
</span><span style="color:#998;font-style:italic"></span>    next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokeBind</span><span style="color:#000;font-weight:bold">(</span>localAddress<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    safeExecute<span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> Runnable<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#3c5d5d;font-weight:bold">@Override</span>
      <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokeBind</span><span style="color:#000;font-weight:bold">(</span>localAddress<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">},</span> promise<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> promise<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">invokeBind</span><span style="color:#000;font-weight:bold">(</span>SocketAddress localAddress<span style="color:#000;font-weight:bold">,</span> ChannelPromise promise<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invokeHandler<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 调用 ChannelOutboundHandler 的 bind 方法
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">((</span>ChannelOutboundHandler<span style="color:#000;font-weight:bold">)</span> handler<span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> localAddress<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      notifyOutboundHandlerException<span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    bind<span style="color:#000;font-weight:bold">(</span>localAddress<span style="color:#000;font-weight:bold">,</span> promise<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> ServerSocketChannel <span style="color:#900;font-weight:bold">bind</span><span style="color:#000;font-weight:bold">(</span>SocketAddress local<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> backlog<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span>stateLock<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    ensureOpen<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>localAddress <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> AlreadyBoundException<span style="color:#000;font-weight:bold">();</span>
    InetSocketAddress isa <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>local <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">new</span> InetSocketAddress<span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">:</span> Net<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkAddress</span><span style="color:#000;font-weight:bold">(</span>local<span style="color:#000;font-weight:bold">);</span>
    SecurityManager sm <span style="color:#000;font-weight:bold">=</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSecurityManager</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>sm <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
      sm<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkListen</span><span style="color:#000;font-weight:bold">(</span>isa<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPort</span><span style="color:#000;font-weight:bold">());</span>
    NetHooks<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">beforeTcpBind</span><span style="color:#000;font-weight:bold">(</span>fd<span style="color:#000;font-weight:bold">,</span> isa<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">(),</span> isa<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPort</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#998;font-style:italic">// 绑定地址
</span><span style="color:#998;font-style:italic"></span>    Net<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>fd<span style="color:#000;font-weight:bold">,</span> isa<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">(),</span> isa<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPort</span><span style="color:#000;font-weight:bold">());</span>
    Net<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">listen</span><span style="color:#000;font-weight:bold">(</span>fd<span style="color:#000;font-weight:bold">,</span> backlog <span style="color:#000;font-weight:bold">&lt;</span> 1 <span style="color:#000;font-weight:bold">?</span> 50 <span style="color:#000;font-weight:bold">:</span> backlog<span style="color:#000;font-weight:bold">);</span>
    localAddress <span style="color:#000;font-weight:bold">=</span> Net<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">localAddress</span><span style="color:#000;font-weight:bold">(</span>fd<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>initAndRegister 中新建 Channel 的主要流程是通过 NIO 的 SelectorProvider 和 openServerSocketChannel 方法得到 JDK 的 Channel，Netty 会包装 JDK 的Channel。创建一个唯一的 ChannelId，创建一个 NioMessageUnsafe 用于操作消息，创建了一个 DefaultChannelPipeline 管道，是一个双向链表，用于过滤所有进出的消息。创建一个 NioServerSocketChannelConfig 对象，用于对外展示一些配置。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> ServerSocketChannel <span style="color:#900;font-weight:bold">newSocket</span><span style="color:#000;font-weight:bold">(</span>SelectorProvider provider<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 通过 SelectorProvider 开启一个 ServerSocketChannel
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> provider<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">openServerSocketChannel</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ChannelException<span style="color:#000;font-weight:bold">(</span>
      <span style="color:#d14">&#34;Failed to open a server socket.&#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> ServerSocketChannel <span style="color:#900;font-weight:bold">openServerSocketChannel</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
 	<span style="color:#998;font-style:italic">// 创建 ServerSocketChannel
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> ServerSocketChannelImpl<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#900;font-weight:bold">AbstractChannel</span><span style="color:#000;font-weight:bold">(</span>Channel parent<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parent</span> <span style="color:#000;font-weight:bold">=</span> parent<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 创建 ID
</span><span style="color:#998;font-style:italic"></span>  id <span style="color:#000;font-weight:bold">=</span> newId<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 创建 NioMessageUnsafe
</span><span style="color:#998;font-style:italic"></span>  unsafe <span style="color:#000;font-weight:bold">=</span> newUnsafe<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 创建 DefaultChannelPipeline
</span><span style="color:#998;font-style:italic"></span>  pipeline <span style="color:#000;font-weight:bold">=</span> newChannelPipeline<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">NioServerSocketChannel</span><span style="color:#000;font-weight:bold">(</span>ServerSocketChannel channel<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> channel<span style="color:#000;font-weight:bold">,</span> SelectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OP_ACCEPT</span><span style="color:#000;font-weight:bold">);</span>
  	<span style="color:#998;font-style:italic">// 创建 NioServerSocketChannelConfig
</span><span style="color:#998;font-style:italic"></span>    config <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> NioServerSocketChannelConfig<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> javaChannel<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">socket</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>EventLoop 的 run 方法如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">int</span> selectCnt <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#458;font-weight:bold">int</span> strategy<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 计算需要使用的处理策略，如果当前没有 Task 则返回 Select 策略 
</span><span style="color:#998;font-style:italic"></span>                strategy <span style="color:#000;font-weight:bold">=</span> selectStrategy<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">calculateStrategy</span><span style="color:#000;font-weight:bold">(</span>selectNowSupplier<span style="color:#000;font-weight:bold">,</span> hasTasks<span style="color:#000;font-weight:bold">());</span>
                <span style="color:#000;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span>strategy<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">case</span> SelectStrategy<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CONTINUE</span><span style="color:#000;font-weight:bold">:</span>
                    <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">case</span> SelectStrategy<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">BUSY_WAIT</span><span style="color:#000;font-weight:bold">:</span>
                <span style="color:#000;font-weight:bold">case</span> SelectStrategy<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SELECT</span><span style="color:#000;font-weight:bold">:</span>
                    <span style="color:#998;font-style:italic">// 计算截止时间
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#458;font-weight:bold">long</span> curDeadlineNanos <span style="color:#000;font-weight:bold">=</span> nextScheduledTaskDeadlineNanos<span style="color:#000;font-weight:bold">();</span>
                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>curDeadlineNanos <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">-</span>1L<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        curDeadlineNanos <span style="color:#000;font-weight:bold">=</span> NONE<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// nothing on the calendar
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#998;font-style:italic">// 设置标志位
</span><span style="color:#998;font-style:italic"></span>                    nextWakeupNanos<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span>curDeadlineNanos<span style="color:#000;font-weight:bold">);</span>
                    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>hasTasks<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                          <span style="color:#998;font-style:italic">// 如果没有 task 则调用 select 方法
</span><span style="color:#998;font-style:italic"></span>                          <span style="color:#998;font-style:italic">// 如果没有截止时间则会一直阻塞在这边
</span><span style="color:#998;font-style:italic"></span>                            strategy <span style="color:#000;font-weight:bold">=</span> select<span style="color:#000;font-weight:bold">(</span>curDeadlineNanos<span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#998;font-style:italic">// This update is just to help block unnecessary selector wakeups
</span><span style="color:#998;font-style:italic"></span>                        <span style="color:#998;font-style:italic">// so use of lazySet is ok (no race condition)
</span><span style="color:#998;font-style:italic"></span>                        nextWakeupNanos<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">lazySet</span><span style="color:#000;font-weight:bold">(</span>AWAKE<span style="color:#000;font-weight:bold">);</span>
                    <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#998;font-style:italic">// fall through
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// If we receive an IOException here its because the Selector is messed up. Let&#39;s rebuild
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#998;font-style:italic">// the selector and retry. https://github.com/netty/netty/issues/8566
</span><span style="color:#998;font-style:italic"></span>                rebuildSelector0<span style="color:#000;font-weight:bold">();</span>
                selectCnt <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
                handleLoopException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>

          	<span style="color:#998;font-style:italic">// 更新 select 的数量
</span><span style="color:#998;font-style:italic"></span>            selectCnt<span style="color:#000;font-weight:bold">++;</span>
            cancelledKeys <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
            needsToSelectAgain <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#998;font-style:italic">// 获取 io 事件的比率（0-100 ，值越小表明花费在非 IO 事件的 Task 可以越多
</span><span style="color:#998;font-style:italic"></span>          <span style="color:#998;font-style:italic">// 默认是 50，如果设置为 100 则 EventLoop 不会尝试平衡 IO 事件 Task 和 非 IO 事件 Task 比例
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">int</span> ioRatio <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ioRatio</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#458;font-weight:bold">boolean</span> ranTasks<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ioRatio <span style="color:#000;font-weight:bold">==</span> 100<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>strategy <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                      <span style="color:#998;font-style:italic">// 处理  SelectKeys
</span><span style="color:#998;font-style:italic"></span>                        processSelectedKeys<span style="color:#000;font-weight:bold">();</span>
                    <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#998;font-style:italic">// 确保会执行所有的 Task
</span><span style="color:#998;font-style:italic"></span>                    ranTasks <span style="color:#000;font-weight:bold">=</span> runAllTasks<span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>strategy <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">long</span> ioStartTime <span style="color:#000;font-weight:bold">=</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nanoTime</span><span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
                    processSelectedKeys<span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#998;font-style:italic">// Ensure we always run tasks.
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">long</span> ioTime <span style="color:#000;font-weight:bold">=</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nanoTime</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">-</span> ioStartTime<span style="color:#000;font-weight:bold">;</span>
                    ranTasks <span style="color:#000;font-weight:bold">=</span> runAllTasks<span style="color:#000;font-weight:bold">(</span>ioTime <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span>100 <span style="color:#000;font-weight:bold">-</span> ioRatio<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">/</span> ioRatio<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                ranTasks <span style="color:#000;font-weight:bold">=</span> runAllTasks<span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// This will run the minimum number of tasks
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">}</span>

          <span style="color:#998;font-style:italic">// 重置 Select Count
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ranTasks <span style="color:#000;font-weight:bold">||</span> strategy <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>selectCnt <span style="color:#000;font-weight:bold">&gt;</span> MIN_PREMATURE_SELECTOR_RETURNS <span style="color:#000;font-weight:bold">&amp;&amp;</span> logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isDebugEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Selector.select() returned prematurely {} times in a row for Selector {}.&#34;</span><span style="color:#000;font-weight:bold">,</span>
                            selectCnt <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">,</span> selector<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
                selectCnt <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>unexpectedSelectorWakeup<span style="color:#000;font-weight:bold">(</span>selectCnt<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// Unexpected wakeup (unusual case)
</span><span style="color:#998;font-style:italic"></span>                selectCnt <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>CancelledKeyException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// Harmless exception - log anyway
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isDebugEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">debug</span><span style="color:#000;font-weight:bold">(</span>CancelledKeyException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSimpleName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; raised by a Selector {} - JDK bug?&#34;</span><span style="color:#000;font-weight:bold">,</span>
                        selector<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            handleLoopException<span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// Always handle shutdown even if the loop processing threw an exception.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isShuttingDown<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                closeAll<span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>confirmShutdown<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            handleLoopException<span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>里面包含了一个死循环，重要的方法有两个：processSelectedKeys  和 runAllTasks</p>
<p>其中 processSelectedKeys 如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">processSelectedKeys</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>selectedKeys <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
   	<span style="color:#998;font-style:italic">// 处理 selectkeys
</span><span style="color:#998;font-style:italic"></span>    processSelectedKeysOptimized<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    processSelectedKeysPlain<span style="color:#000;font-weight:bold">(</span>selector<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectedKeys</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">processSelectedKeysOptimized</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 遍历 Select keys 并逐个处理
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> selectedKeys<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000;font-weight:bold">++</span>i<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">final</span> SelectionKey k <span style="color:#000;font-weight:bold">=</span> selectedKeys<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">keys</span><span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">];</span>
    selectedKeys<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">keys</span><span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">// 获取当前的附加信息
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">final</span> Object a <span style="color:#000;font-weight:bold">=</span> k<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attachment</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>a <span style="color:#000;font-weight:bold">instanceof</span> AbstractNioChannel<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      processSelectedKey<span style="color:#000;font-weight:bold">(</span>k<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>AbstractNioChannel<span style="color:#000;font-weight:bold">)</span> a<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#3c5d5d;font-weight:bold">@SuppressWarnings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;unchecked&#34;</span><span style="color:#000;font-weight:bold">)</span>
      NioTask<span style="color:#000;font-weight:bold">&lt;</span>SelectableChannel<span style="color:#000;font-weight:bold">&gt;</span> task <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>NioTask<span style="color:#000;font-weight:bold">&lt;</span>SelectableChannel<span style="color:#000;font-weight:bold">&gt;)</span> a<span style="color:#000;font-weight:bold">;</span>
      processSelectedKey<span style="color:#000;font-weight:bold">(</span>k<span style="color:#000;font-weight:bold">,</span> task<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>needsToSelectAgain<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      selectedKeys<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">reset</span><span style="color:#000;font-weight:bold">(</span>i <span style="color:#000;font-weight:bold">+</span> 1<span style="color:#000;font-weight:bold">);</span>

      selectAgain<span style="color:#000;font-weight:bold">();</span>
      i <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">processSelectedKey</span><span style="color:#000;font-weight:bold">(</span>SelectionKey k<span style="color:#000;font-weight:bold">,</span> AbstractNioChannel ch<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">final</span> AbstractNioChannel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NioUnsafe</span> unsafe <span style="color:#000;font-weight:bold">=</span> ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unsafe</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>k<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isValid</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">final</span> EventLoop eventLoop<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 通过 Channel 获取当前的 EventLoop
</span><span style="color:#998;font-style:italic"></span>      eventLoop <span style="color:#000;font-weight:bold">=</span> ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">eventLoop</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable ignored<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// If the channel implementation throws an exception because there is no event loop, we ignore this
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// because we are only trying to determine if ch is registered to this event loop and thus has authority
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// to close ch.
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// still healthy and should not be closed.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// See https://github.com/netty/netty/issues/5125
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>eventLoop <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// close the channel if the key is not valid anymore
</span><span style="color:#998;font-style:italic"></span>      unsafe<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">close</span><span style="color:#000;font-weight:bold">(</span>unsafe<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">voidPromise</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 获取 read 的 option
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">int</span> readyOps <span style="color:#000;font-weight:bold">=</span> k<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readyOps</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// the NIO JDK channel implementation may throw a NotYetConnectedException.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>readyOps <span style="color:#000;font-weight:bold">&amp;</span> SelectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OP_CONNECT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// See https://github.com/netty/netty/issues/924
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#458;font-weight:bold">int</span> ops <span style="color:#000;font-weight:bold">=</span> k<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">interestOps</span><span style="color:#000;font-weight:bold">();</span>
      ops <span style="color:#000;font-weight:bold">&amp;=</span> <span style="color:#000;font-weight:bold">~</span>SelectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OP_CONNECT</span><span style="color:#000;font-weight:bold">;</span>
      k<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">interestOps</span><span style="color:#000;font-weight:bold">(</span>ops<span style="color:#000;font-weight:bold">);</span>

      unsafe<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">finishConnect</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>readyOps <span style="color:#000;font-weight:bold">&amp;</span> SelectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OP_WRITE</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write
</span><span style="color:#998;font-style:italic"></span>      ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unsafe</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">forceFlush</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// to a spin loop
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>readyOps <span style="color:#000;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">(</span>SelectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OP_READ</span> <span style="color:#000;font-weight:bold">|</span> SelectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OP_ACCEPT</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> 0 <span style="color:#000;font-weight:bold">||</span> readyOps <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// OP_ACCEPT 事件，通过 unsafe 执行读操作
</span><span style="color:#998;font-style:italic"></span>      unsafe<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">read</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>CancelledKeyException ignored<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    unsafe<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">close</span><span style="color:#000;font-weight:bold">(</span>unsafe<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">voidPromise</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">read</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 判断是当前的 EventLoop
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">assert</span> eventLoop<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">inEventLoop</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 获取 config、pipeline 等
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> ChannelConfig config <span style="color:#000;font-weight:bold">=</span> config<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">final</span> ChannelPipeline pipeline <span style="color:#000;font-weight:bold">=</span> pipeline<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">final</span> RecvByteBufAllocator<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Handle</span> allocHandle <span style="color:#000;font-weight:bold">=</span> unsafe<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">recvBufAllocHandle</span><span style="color:#000;font-weight:bold">();</span>
  allocHandle<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">reset</span><span style="color:#000;font-weight:bold">(</span>config<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#458;font-weight:bold">boolean</span> closed <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
  Throwable exception <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 执行去获取 Message
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#458;font-weight:bold">int</span> localRead <span style="color:#000;font-weight:bold">=</span> doReadMessages<span style="color:#000;font-weight:bold">(</span>readBuf<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>localRead <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>localRead <span style="color:#000;font-weight:bold">&lt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          closed <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#998;font-style:italic">// Increment the number of messages that have been read for the current read loop.
</span><span style="color:#998;font-style:italic"></span>        allocHandle<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">incMessagesRead</span><span style="color:#000;font-weight:bold">(</span>localRead<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>allocHandle<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">continueReading</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      exception <span style="color:#000;font-weight:bold">=</span> t<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">// 获取读取到的大小
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">int</span> size <span style="color:#000;font-weight:bold">=</span> readBuf<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> size<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
      readPending <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#998;font-style:italic">// 循环调用 pipeline 触发 Channel read 的方法
</span><span style="color:#998;font-style:italic"></span>      pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fireChannelRead</span><span style="color:#000;font-weight:bold">(</span>readBuf<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>i<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>
    readBuf<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">clear</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 读取完毕
</span><span style="color:#998;font-style:italic"></span>    allocHandle<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">readComplete</span><span style="color:#000;font-weight:bold">();</span>
    pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fireChannelReadComplete</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>exception <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      closed <span style="color:#000;font-weight:bold">=</span> closeOnReadError<span style="color:#000;font-weight:bold">(</span>exception<span style="color:#000;font-weight:bold">);</span>
      pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fireExceptionCaught</span><span style="color:#000;font-weight:bold">(</span>exception<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>closed<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      inputShutdown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isOpen<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        close<span style="color:#000;font-weight:bold">(</span>voidPromise<span style="color:#000;font-weight:bold">());</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Check if there is a readPending which was not processed yet.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// This could be for two reasons:
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// See https://github.com/netty/netty/issues/2254
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>readPending <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>config<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isAutoRead</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      removeReadOp<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">doReadMessages</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> buf<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 内部调用 ServerSocketChannel 的 accept 方法，获取一个 JDK 的SocketChannel
</span><span style="color:#998;font-style:italic"></span>  SocketChannel ch <span style="color:#000;font-weight:bold">=</span> SocketUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">accept</span><span style="color:#000;font-weight:bold">(</span>javaChannel<span style="color:#000;font-weight:bold">());</span>

  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ch <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 将 JDK 的 SocketChannel 封装成 NIOSocketChannel 然后添加到容器中
</span><span style="color:#998;font-style:italic"></span>      buf<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> NioSocketChannel<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> ch<span style="color:#000;font-weight:bold">));</span>
      <span style="color:#000;font-weight:bold">return</span> 1<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to create a new channel from an accepted socket.&#34;</span><span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">);</span>

    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">close</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t2<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to close a socket.&#34;</span><span style="color:#000;font-weight:bold">,</span> t2<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">invokeChannelRead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> AbstractChannelHandlerContext next<span style="color:#000;font-weight:bold">,</span> Object msg<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取 msg
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> Object m <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">pipeline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">touch</span><span style="color:#000;font-weight:bold">(</span>ObjectUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkNotNull</span><span style="color:#000;font-weight:bold">(</span>msg<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;msg&#34;</span><span style="color:#000;font-weight:bold">),</span> next<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 获取当前 handler 的执行器
</span><span style="color:#998;font-style:italic"></span>  EventExecutor executor <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executor</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">inEventLoop</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 调用 handler 的 invokeChannelRead（从 header 开始处理）
</span><span style="color:#998;font-style:italic"></span>    next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokeChannelRead</span><span style="color:#000;font-weight:bold">(</span>m<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    executor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Runnable<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#3c5d5d;font-weight:bold">@Override</span>
      <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokeChannelRead</span><span style="color:#000;font-weight:bold">(</span>m<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">invokeChannelRead</span><span style="color:#000;font-weight:bold">(</span>Object msg<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invokeHandler<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 调用 handler 的 ChannelRead 方法
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">((</span>ChannelInboundHandler<span style="color:#000;font-weight:bold">)</span> handler<span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">channelRead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> msg<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      notifyHandlerException<span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    fireChannelRead<span style="color:#000;font-weight:bold">(</span>msg<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">channelRead</span><span style="color:#000;font-weight:bold">(</span>ChannelHandlerContext ctx<span style="color:#000;font-weight:bold">,</span> Object msg<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 读取
</span><span style="color:#998;font-style:italic"></span>  ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fireChannelRead</span><span style="color:#000;font-weight:bold">(</span>msg<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 触发 ChannelRead 在其中会获取下一个 ctx 并开始读取 Channel 中的内容并做相应的处理
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> ChannelHandlerContext <span style="color:#900;font-weight:bold">fireChannelRead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> Object msg<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 找到下一个 ctx 并开始读取
</span><span style="color:#998;font-style:italic"></span>  invokeChannelRead<span style="color:#000;font-weight:bold">(</span>findContextInbound<span style="color:#000;font-weight:bold">(</span>MASK_CHANNEL_READ<span style="color:#000;font-weight:bold">),</span> msg<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> AbstractChannelHandlerContext <span style="color:#900;font-weight:bold">findContextInbound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> mask<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  AbstractChannelHandlerContext ctx <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
    ctx <span style="color:#000;font-weight:bold">=</span> ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span>ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executionMask</span> <span style="color:#000;font-weight:bold">&amp;</span> mask<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> ctx<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 具体读的方法
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">channelRead</span><span style="color:#000;font-weight:bold">(</span>ChannelHandlerContext ctx<span style="color:#000;font-weight:bold">,</span> Object msg<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEnabled</span><span style="color:#000;font-weight:bold">(</span>internalLevel<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">log</span><span style="color:#000;font-weight:bold">(</span>internalLevel<span style="color:#000;font-weight:bold">,</span> format<span style="color:#000;font-weight:bold">(</span>ctx<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;READ&#34;</span><span style="color:#000;font-weight:bold">,</span> msg<span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span>
  ctx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fireChannelRead</span><span style="color:#000;font-weight:bold">(</span>msg<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ServerBootstrap.ServerBootstrapAcceptor#channelRead
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">channelRead</span><span style="color:#000;font-weight:bold">(</span>ChannelHandlerContext ctx<span style="color:#000;font-weight:bold">,</span> Object msg<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">final</span> Channel child <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Channel<span style="color:#000;font-weight:bold">)</span> msg<span style="color:#000;font-weight:bold">;</span>

  <span style="color:#998;font-style:italic">// 在客户端的 pipeline 上添加 child 的 hanlder 
</span><span style="color:#998;font-style:italic"></span>  child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">pipeline</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">addLast</span><span style="color:#000;font-weight:bold">(</span>childHandler<span style="color:#000;font-weight:bold">);</span>
	<span style="color:#998;font-style:italic">// 设置属性信息
</span><span style="color:#998;font-style:italic"></span>  setChannelOptions<span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">,</span> childOptions<span style="color:#000;font-weight:bold">,</span> logger<span style="color:#000;font-weight:bold">);</span>
  setAttributes<span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">,</span> childAttrs<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 将客户端注册到 worker 线程池上
</span><span style="color:#998;font-style:italic"></span>    childGroup<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">addListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ChannelFutureListener<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#3c5d5d;font-weight:bold">@Override</span>
      <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">operationComplete</span><span style="color:#000;font-weight:bold">(</span>ChannelFuture future<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>future<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isSuccess</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
          forceClose<span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">,</span> future<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cause</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    forceClose<span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">register</span><span style="color:#000;font-weight:bold">(</span>EventLoop eventLoop<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">final</span> ChannelPromise promise<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 一些校验判断
</span><span style="color:#998;font-style:italic"></span>  ObjectUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkNotNull</span><span style="color:#000;font-weight:bold">(</span>eventLoop<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;eventLoop&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isRegistered<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    promise<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setFailure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;registered to an event loop already&#34;</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>isCompatible<span style="color:#000;font-weight:bold">(</span>eventLoop<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    promise<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setFailure</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;incompatible event loop type: &#34;</span> <span style="color:#000;font-weight:bold">+</span> eventLoop<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClass</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()));</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 设置当前的 EventLoop 
</span><span style="color:#998;font-style:italic"></span>  AbstractChannel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">eventLoop</span> <span style="color:#000;font-weight:bold">=</span> eventLoop<span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>eventLoop<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">inEventLoop</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 执行注册
</span><span style="color:#998;font-style:italic"></span>    register0<span style="color:#000;font-weight:bold">(</span>promise<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      eventLoop<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> Runnable<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#3c5d5d;font-weight:bold">@Override</span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#998;font-style:italic">// 异步的执行注册
</span><span style="color:#998;font-style:italic"></span>          register0<span style="color:#000;font-weight:bold">(</span>promise<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#d14">&#34;Force-closing a channel whose registration task was not accepted by an event loop: {}&#34;</span><span style="color:#000;font-weight:bold">,</span>
        AbstractChannel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">this</span><span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">);</span>
      closeForcibly<span style="color:#000;font-weight:bold">();</span>
      closeFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setClosed</span><span style="color:#000;font-weight:bold">();</span>
      safeSetFailure<span style="color:#000;font-weight:bold">(</span>promise<span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">register0</span><span style="color:#000;font-weight:bold">(</span>ChannelPromise promise<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// check if the channel is still open as it could be closed in the mean time when the register
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// call was outside of the eventLoop
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>promise<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUncancellable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span>ensureOpen<span style="color:#000;font-weight:bold">(</span>promise<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#458;font-weight:bold">boolean</span> firstRegistration <span style="color:#000;font-weight:bold">=</span> neverRegistered<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 执行 Register
</span><span style="color:#998;font-style:italic"></span>    doRegister<span style="color:#000;font-weight:bold">();</span>
    neverRegistered <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
    registered <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">// 通知 pipeline 中所有的 handler 有新的客户端连接
</span><span style="color:#998;font-style:italic"></span>    pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokeHandlerAddedIfNeeded</span><span style="color:#000;font-weight:bold">();</span>
    safeSetSuccess<span style="color:#000;font-weight:bold">(</span>promise<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 通知pipeline 中所有的 handler 有 Channel 注册了
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 和 read 的逻辑相似
</span><span style="color:#998;font-style:italic"></span>    pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fireChannelRegistered</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// Only fire a channelActive if the channel has never been registered. This prevents firing
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// multiple channel actives if the channel is deregistered and re-registered.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isActive<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>firstRegistration<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 通知pipeline 中所有的 handler 有 Channel 活动了
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// 和 read 的逻辑相似
</span><span style="color:#998;font-style:italic"></span>        pipeline<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fireChannelActive</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>config<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isAutoRead</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// This channel was registered before and autoRead() is set. This means we need to begin read
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// again so that we process inbound data.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">//
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// See https://github.com/netty/netty/issues/4805
</span><span style="color:#998;font-style:italic"></span>        beginRead<span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Close the channel directly to avoid FD leak.
</span><span style="color:#998;font-style:italic"></span>    closeForcibly<span style="color:#000;font-weight:bold">();</span>
    closeFuture<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setClosed</span><span style="color:#000;font-weight:bold">();</span>
    safeSetFailure<span style="color:#000;font-weight:bold">(</span>promise<span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doRegister</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#458;font-weight:bold">boolean</span> selected <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 调用 JDK SelectableChannel 的注册方法
</span><span style="color:#998;font-style:italic"></span>      selectionKey <span style="color:#000;font-weight:bold">=</span> javaChannel<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>eventLoop<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">unwrappedSelector</span><span style="color:#000;font-weight:bold">(),</span> 0<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>CancelledKeyException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>selected<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// Force the Selector to select now as the &#34;canceled&#34; SelectionKey may still be
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// cached and not removed because no Select.select(..) operation was called yet.
</span><span style="color:#998;font-style:italic"></span>        eventLoop<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">selectNow</span><span style="color:#000;font-weight:bold">();</span>
        selected <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// We forced a select operation on the selector before but the SelectionKey is still cached
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// for whatever reason. JDK bug ?
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">throw</span> e<span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 readComplete 后的 pipeline 的 fireChannelReadComplete 方法中最终会调用到</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doBeginRead</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// Channel.read() or ChannelHandlerContext.read() was called
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> SelectionKey selectionKey <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectionKey</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>selectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isValid</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  readPending <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">int</span> interestOps <span style="color:#000;font-weight:bold">=</span> selectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">interestOps</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>interestOps <span style="color:#000;font-weight:bold">&amp;</span> readInterestOp<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    selectionKey<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">interestOps</span><span style="color:#000;font-weight:bold">(</span>interestOps <span style="color:#000;font-weight:bold">|</span> readInterestOp<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中  runAllTasks 方法如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">runAllTasks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">long</span> timeoutNanos<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取 task
</span><span style="color:#998;font-style:italic"></span>  fetchFromScheduledTaskQueue<span style="color:#000;font-weight:bold">();</span>
  Runnable task <span style="color:#000;font-weight:bold">=</span> pollTask<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>task <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    afterRunningAllTasks<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">long</span> deadline <span style="color:#000;font-weight:bold">=</span> timeoutNanos <span style="color:#000;font-weight:bold">&gt;</span> 0 <span style="color:#000;font-weight:bold">?</span> ScheduledFutureTask<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nanoTime</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> timeoutNanos <span style="color:#000;font-weight:bold">:</span> 0<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#458;font-weight:bold">long</span> runTasks <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#458;font-weight:bold">long</span> lastExecutionTime<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 执行 task
</span><span style="color:#998;font-style:italic"></span>    safeExecute<span style="color:#000;font-weight:bold">(</span>task<span style="color:#000;font-weight:bold">);</span>

    runTasks <span style="color:#000;font-weight:bold">++;</span>

   	<span style="color:#998;font-style:italic">// 避免超时
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>runTasks <span style="color:#000;font-weight:bold">&amp;</span> 0x3F<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      lastExecutionTime <span style="color:#000;font-weight:bold">=</span> ScheduledFutureTask<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nanoTime</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>lastExecutionTime <span style="color:#000;font-weight:bold">&gt;=</span> deadline<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    task <span style="color:#000;font-weight:bold">=</span> pollTask<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>task <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      lastExecutionTime <span style="color:#000;font-weight:bold">=</span> ScheduledFutureTask<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">nanoTime</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  afterRunningAllTasks<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">lastExecutionTime</span> <span style="color:#000;font-weight:bold">=</span> lastExecutionTime<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div>
        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="https://sangzhenya.github.io/post/Others/Netty/Netty-%E6%A0%B8%E5%BF%83/">Netty 核心</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Others/Netty/Netty-%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/">Netty 线程模型</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Spring/Spring-Core/Spring-Awired-%E5%8E%9F%E7%90%86/">Spring Awired 原理</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Spring/Spring-Core/Spring-AOP%E5%8E%9F%E7%90%86/">Spring AOP 原理</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Spring/Spring-Core/Spring-%E6%BA%90%E7%A0%81/">Spring 源码分析</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='https://sangzhenya.github.io/tags/Netty'>Netty</a></li>
                
                <li><a href='https://sangzhenya.github.io/tags/%E6%BA%90%E7%A0%81'>源码</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://sangzhenya.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-JNDI/" title="Java JNDI">Java JNDI</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-JVM/" title="Java JVM">Java JVM</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-HotSpot-GC-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" title="Java HotSpot GC 算法实现">Java HotSpot GC 算法实现</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-GC-2/" title="Java GC 2">Java GC 2</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-GC-1/" title="Java GC 1">Java GC 1</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="Java 虚拟机内存模型">Java 虚拟机内存模型</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/" title="Java 逃逸分析">Java 逃逸分析</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E5%9B%9B%E7%A7%8D%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" title="Java 四种引用类型">Java 四种引用类型</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/Dubbo-%E5%8E%9F%E7%90%86/" title="Dubbo 原理">Dubbo 原理</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/" title="Java 双亲委派模型">Java 双亲委派模型</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="https://sangzhenya.github.io/categories/Java/">Java (22)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/MQ/">MQ (3)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/MyBaits/">MyBaits (7)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/MySQL/">MySQL (4)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Netty/">Netty (10)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Nginx/">Nginx (2)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Redis/">Redis (2)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Spring/">Spring (36)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E5%85%B3%E4%BA%8E/">关于 (1)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E5%85%B6%E4%BB%96/">其他 (8)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 (11)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E7%AE%97%E6%B3%95/">算法 (3)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (7)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://sangzhenya.github.io/tags/Active-MQ/">Active MQ</a>
    
    <a href="https://sangzhenya.github.io/tags/Cookie/">Cookie</a>
    
    <a href="https://sangzhenya.github.io/tags/Debug/">Debug</a>
    
    <a href="https://sangzhenya.github.io/tags/Docker/">Docker</a>
    
    <a href="https://sangzhenya.github.io/tags/Dubbo/">Dubbo</a>
    
    <a href="https://sangzhenya.github.io/tags/Git/">Git</a>
    
    <a href="https://sangzhenya.github.io/tags/JDK8/">JDK8</a>
    
    <a href="https://sangzhenya.github.io/tags/JPA/">JPA</a>
    
    <a href="https://sangzhenya.github.io/tags/JUC/">JUC</a>
    
    <a href="https://sangzhenya.github.io/tags/JVM/">JVM</a>
    
    <a href="https://sangzhenya.github.io/tags/java/">java</a>
    
    <a href="https://sangzhenya.github.io/tags/Jenkins/">Jenkins</a>
    
    <a href="https://sangzhenya.github.io/tags/Kafka/">Kafka</a>
    
    <a href="https://sangzhenya.github.io/tags/Kubernetes/">Kubernetes</a>
    
    <a href="https://sangzhenya.github.io/tags/Linux/">Linux</a>
    
    <a href="https://sangzhenya.github.io/tags/Maven/">Maven</a>
    
    <a href="https://sangzhenya.github.io/tags/MyBaits/">MyBaits</a>
    
    <a href="https://sangzhenya.github.io/tags/MySQL/">MySQL</a>
    
    <a href="https://sangzhenya.github.io/tags/Netty/">Netty</a>
    
    <a href="https://sangzhenya.github.io/tags/Nginx/">Nginx</a>
    
    <a href="https://sangzhenya.github.io/tags/Rabbit-MQ/">Rabbit MQ</a>
    
    <a href="https://sangzhenya.github.io/tags/Redis/">Redis</a>
    
    <a href="https://sangzhenya.github.io/tags/Rocket-MQ/">Rocket MQ</a>
    
    <a href="https://sangzhenya.github.io/tags/Session/">Session</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring/">Spring</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Boot/">Spring Boot</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Cloud/">Spring Cloud</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Data/">Spring Data</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-MVC/">Spring MVC</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Security/">Spring Security</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-%E6%B3%A8%E8%A7%A3/">Spring 注解</a>
    
    <a href="https://sangzhenya.github.io/tags/Tmux/">Tmux</a>
    
    <a href="https://sangzhenya.github.io/tags/Zookeeper/">Zookeeper</a>
    
    <a href="https://sangzhenya.github.io/tags/java/">java</a>
    
    <a href="https://sangzhenya.github.io/tags/%E4%BB%A3%E7%A0%81/">代码</a>
    
    <a href="https://sangzhenya.github.io/tags/%E5%85%B3%E4%BA%8E/">关于</a>
    
    <a href="https://sangzhenya.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
    
    <a href="https://sangzhenya.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>
    
    <a href="https://sangzhenya.github.io/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
    <a href="https://sangzhenya.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
    
    <a href="https://sangzhenya.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
    
    <a href="https://sangzhenya.github.io/tags/%E9%9B%86%E5%90%88/">集合</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://sangzhenya.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="https://sangzhenya.github.io/">新月的博客 By 新月</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        Theme based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='https://sangzhenya.github.io/js/totop.js?v=0.0.0' async=""></script>






</body>

</html>