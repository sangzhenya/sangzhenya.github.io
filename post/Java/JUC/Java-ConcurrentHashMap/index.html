<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Java ConcurrentHashMap | 新月的博客</title>
    <meta property="og:title" content="Java ConcurrentHashMap - 新月的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-01-02T10:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-01-02T10:00:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Java ConcurrentHashMap">
        
    <meta name="author" content="新月">
    <meta property="og:url" content="https://sangzhenya.github.io/post/Java/JUC/Java-ConcurrentHashMap/">
    <link rel="shortcut icon" href="https://sangzhenya.github.io/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='https://sangzhenya.github.io/css/normalize.css'>
    <link rel="stylesheet" href='https://sangzhenya.github.io/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://sangzhenya.github.io/">
                        新月的博客
                    </a>
                
                <p class="description">晚来天欲雪，能饮一杯无？</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://sangzhenya.github.io/">首页</a>
                    
                    <a  href="https://sangzhenya.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://sangzhenya.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Java ConcurrentHashMap</h1>
        </header>
        <date class="post-meta meta-date">
            2019年1月2日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='https://sangzhenya.github.io/categories/Java'>Java</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <h3 id="jdk-8-中-concurrenthashmap-为什么放弃分段锁">JDK 8 中 ConcurrentHashMap 为什么放弃分段锁</h3>
<p>在 Java 8 中 <code>ConcurrentHashMap</code> 放弃了分段锁而是使用 <code>synchronized</code> 加 CAS 的来实现并发控制的。一方面是 JVM 对 <code>synchronized</code> 已经进行了大量的优化措施，例如锁粗化，锁消除，自适应自旋锁，偏向锁等等。另一方面使用分段锁浪费内存空间，且 map 放入时竞争同一个锁的概率很小，分段锁反而可能造成更新操作长时间等待，同时为了提高 GC 的效率。</p>
<h3 id="hashmap-并发情况下可能出现的-死循环">HashMap 并发情况下可能出现的 死循环</h3>
<p>在 JDK 1.7 版本中并发的情况下使用 HashMap 可能会出现死循环的情况，主要的是在 HashMap 扩容之后会通过 <code>transfer</code> 方法，把元素从老链表中转移到新的链表中。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">transfer</span><span style="color:#000;font-weight:bold">(</span>Entry<span style="color:#000;font-weight:bold">[]</span> newTable<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Entry<span style="color:#000;font-weight:bold">[]</span> src <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#458;font-weight:bold">int</span> newCapacity <span style="color:#000;font-weight:bold">=</span> newTable<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> j <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> j <span style="color:#000;font-weight:bold">&lt;</span> src<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">;</span> j<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
        Entry e <span style="color:#000;font-weight:bold">=</span> src<span style="color:#000;font-weight:bold">[</span>j<span style="color:#000;font-weight:bold">];</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>e <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            src<span style="color:#000;font-weight:bold">[</span>j<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
                Entry next <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> indexFor<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">,</span> newCapacity<span style="color:#000;font-weight:bold">);</span>
                e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span> <span style="color:#000;font-weight:bold">=</span> newTable<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">];</span>
                newTable<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">;</span>
                e <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>e <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>resize</code> 中出现的死锁的过程如下，如果一个 table 中某个 key 对应如下的链表：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">key <span style="color:#000;font-weight:bold">==&gt;</span> A <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> C
</code></pre></td></tr></table>
</div>
</div><p>正常的情况 <code>resize</code> 之后应该是</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">key <span style="color:#000;font-weight:bold">==&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> A
key1 <span style="color:#000;font-weight:bold">==&gt;</span> C
</code></pre></td></tr></table>
</div>
</div><p>多线程的时候 resize 过程可能如下（请结合上面 transfer 方法看）：</p>
<p>第一步：</p>
<p>开始前链表状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">A <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> C 
</code></pre></td></tr></table>
</div>
</div><p>线程1：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> A
next <span style="color:#000;font-weight:bold">=</span> B
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>线程2：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> A
next <span style="color:#000;font-weight:bold">=</span> B
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>第二步：</p>
<p>开始前链表状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">A <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> C 
</code></pre></td></tr></table>
</div>
</div><p>线程 1 （未被执行）</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> A
next <span style="color:#000;font-weight:bold">=</span> B
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>线程 2</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> B
next <span style="color:#000;font-weight:bold">=</span> C
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>第三步：</p>
<p>开始前链表状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">A <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
B <span style="color:#000;font-weight:bold">-&gt;</span> C <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>线程 1  （未被执行）</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> A
next <span style="color:#000;font-weight:bold">=</span> B
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>线程 2</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> C
next <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>第四步：</p>
<p>开始前链表状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">B <span style="color:#000;font-weight:bold">-&gt;</span> A <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
C <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>线程 1</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> B
next <span style="color:#000;font-weight:bold">=</span> A
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>线程 2 （未被执行）</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> C
next <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>第五步：</p>
<p>开始前链表状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">B <span style="color:#000;font-weight:bold">-&gt;</span> A <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
C <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>线程 1</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> A
next <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>线程 2 (未被执行)</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> C
next <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>第六步：</p>
<p>开始前链表状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">B <span style="color:#000;font-weight:bold">-&gt;</span> A <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
A <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>线程 1</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>
next <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">&lt;-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>线程 2 (未被执行)</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">e <span style="color:#000;font-weight:bold">=</span> C
next <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">---</span>
newTable<span style="color:#000;font-weight:bold">[</span>key<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">-&gt;</span> B <span style="color:#000;font-weight:bold">-&gt;</span> A
</code></pre></td></tr></table>
</div>
</div><p>结束的链表状态</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">B <span style="color:#000;font-weight:bold">&lt;-&gt;</span> A 
C <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">null</span>
</code></pre></td></tr></table>
</div>
</div><p>这个时候就发现在 key 的位置出现了循环链表了。</p>
<p>在  JDK 8 中对于 HashMap 的实现有了较大的改动，对于相同 Hash 值数据存储的方式也由以前的单纯的使用链表转变成了，在数量较少的时候使用链表，当链表长度大于 8 且总 HashMap 的长度大于等于 64 的时候会将链表转换成红黑树进行存储。链表的插入方式也从以前的头插法换成了尾插法（这一点就解决了上述可能出现循环链表的问题）。但是这并不意味着 JDK 8 中的 HashMap 是线程的安全的，在并发环境下 HashMap 还是可能出现缺失数据的问题。所以在并发环境下还是需要使用 ConcurrentHashMap 来保证数据的线程安全。</p>
<h3 id="主要成员变量">主要成员变量</h3>
<p>主要成员变量如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 存储元素的列表，在第一次插入的时候进行初始化，容量是 2 的幂
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">transient</span> <span style="color:#000;font-weight:bold">volatile</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> table<span style="color:#000;font-weight:bold">;</span>
<span style="color:#998;font-style:italic">// 扩容的时候使用到的
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">transient</span> <span style="color:#000;font-weight:bold">volatile</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> nextTable<span style="color:#000;font-weight:bold">;</span>
<span style="color:#998;font-style:italic">// 统计 Map 中存储数据的数量
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">transient</span> <span style="color:#000;font-weight:bold">volatile</span> <span style="color:#458;font-weight:bold">long</span> baseCount<span style="color:#000;font-weight:bold">;</span>
<span style="color:#998;font-style:italic">// 小于 0 表示 table 正在初始化或者扩容，-1 表示正常在初始化，-(1 + 扩容线程数) 表示正在扩容。
</span><span style="color:#998;font-style:italic">// 当 table 为 null 时为初始化时创立的 table 长度，默认值是 0、
</span><span style="color:#998;font-style:italic">// 初始化后记录下一个元素的值，根据这个值扩容数组，就是阈值
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">transient</span> <span style="color:#000;font-weight:bold">volatile</span> <span style="color:#458;font-weight:bold">int</span> sizeCtl<span style="color:#000;font-weight:bold">;</span>
<span style="color:#998;font-style:italic">// 1 表示 counterCells 正常创建， 0 表示其他状态
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">transient</span> <span style="color:#000;font-weight:bold">volatile</span> <span style="color:#458;font-weight:bold">int</span> cellsBusy<span style="color:#000;font-weight:bold">;</span>
<span style="color:#998;font-style:italic">// 递增 baseCount 出现竞争的时候根据 counterCells 中的值进行递增，最终 Map 中的数量是 baseCount 和该数组之和
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">transient</span> <span style="color:#000;font-weight:bold">volatile</span> CounterCell<span style="color:#000;font-weight:bold">[]</span> counterCells<span style="color:#000;font-weight:bold">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="put-操作">Put 操作</h3>
<p>测试方法如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Test</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">testConcurrentHashMap</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> testConcurrentHashMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ConcurrentHashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
    testConcurrentHashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Aa&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;demo&#34;</span><span style="color:#000;font-weight:bold">);</span>
    testConcurrentHashMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;BB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;demo&#34;</span><span style="color:#000;font-weight:bold">);</span>
    System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">println</span><span style="color:#000;font-weight:bold">(</span>testConcurrentHashMap<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>先调用 ConcurrentHashMap 的 put 方法</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> V <span style="color:#900;font-weight:bold">put</span><span style="color:#000;font-weight:bold">(</span>K key<span style="color:#000;font-weight:bold">,</span> V value<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> putVal<span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> value<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>继续调用 putVal 方法真的去存放数据</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">98
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">final</span> V <span style="color:#900;font-weight:bold">putVal</span><span style="color:#000;font-weight:bold">(</span>K key<span style="color:#000;font-weight:bold">,</span> V value<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">boolean</span> onlyIfAbsent<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 如果 key 或者 value 任意一个为空则抛出异常
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>key <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> value <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> NullPointerException<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 计算 hash 值
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">int</span> hash <span style="color:#000;font-weight:bold">=</span> spread<span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hashCode</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#458;font-weight:bold">int</span> binCount <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">;;)</span> <span style="color:#000;font-weight:bold">{</span>
        Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> f<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> n<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">,</span> fh<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#998;font-style:italic">// 如果 tab 为空则初始化 tab
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>tab <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">=</span> tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span>
            tab <span style="color:#000;font-weight:bold">=</span> initTable<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#998;font-style:italic">// (n - 1) &amp; hash 计算实际应该存储的位置，tabAt 获取当前位置的元素，如果为空则直接使用 CAS 设置值即可
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>f <span style="color:#000;font-weight:bold">=</span> tabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;</span> hash<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>casTabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
                         <span style="color:#000;font-weight:bold">new</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>hash<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> value<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)))</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>                   <span style="color:#998;font-style:italic">// no lock when adding to empty bin
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// 如果获取到元素的 hash 值为 MOVED 则当前线程协助扩容
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>fh <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> MOVED<span style="color:#000;font-weight:bold">)</span>
            tab <span style="color:#000;font-weight:bold">=</span> helpTransfer<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> f<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">// 哈希值冲突，把当前元素存放到链表或者红黑树中
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            V oldVal <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#998;font-style:italic">// 同步锁
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span>f<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 再次获取 i 位置的元素，判断是否等于刚才获取的元素，
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#998;font-style:italic">// 如果是则继续执行操作，否则重新走一遍 put 的流程
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>tabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> f<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#998;font-style:italic">// 存在元素的 hash 值大于 0
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>fh <span style="color:#000;font-weight:bold">&gt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#998;font-style:italic">// 记录链表长度
</span><span style="color:#998;font-style:italic"></span>                        binCount <span style="color:#000;font-weight:bold">=</span> 1<span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#998;font-style:italic">// 遍历链表
</span><span style="color:#998;font-style:italic"></span>                        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> e <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">;;</span> <span style="color:#000;font-weight:bold">++</span>binCount<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                            K ek<span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#998;font-style:italic">// 如果 key 值相等则更新value即可
</span><span style="color:#998;font-style:italic"></span>                            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span> <span style="color:#000;font-weight:bold">==</span> hash <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                                <span style="color:#000;font-weight:bold">((</span>ek <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> key <span style="color:#000;font-weight:bold">||</span>
                                 <span style="color:#000;font-weight:bold">(</span>ek <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> key<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>ek<span style="color:#000;font-weight:bold">))))</span> <span style="color:#000;font-weight:bold">{</span>
                                oldVal <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span><span style="color:#000;font-weight:bold">;</span>
                                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>onlyIfAbsent<span style="color:#000;font-weight:bold">)</span>
                                    e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span> <span style="color:#000;font-weight:bold">=</span> value<span style="color:#000;font-weight:bold">;</span>
                                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">}</span>
                            Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> pred <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#998;font-style:italic">// 插入到链表尾部
</span><span style="color:#998;font-style:italic"></span>                            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>e <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                                pred<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>hash<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span>
                                                          value<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
                                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#998;font-style:italic">// 或者 f 是一个 红黑树元素
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>f <span style="color:#000;font-weight:bold">instanceof</span> TreeBin<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> p<span style="color:#000;font-weight:bold">;</span>
                        binCount <span style="color:#000;font-weight:bold">=</span> 2<span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#998;font-style:italic">// 向红黑树中添加元素
</span><span style="color:#998;font-style:italic"></span>                        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>p <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span>TreeBin<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;)</span>f<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">putTreeVal</span><span style="color:#000;font-weight:bold">(</span>hash<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span>
                                                              value<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                            oldVal <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span><span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>onlyIfAbsent<span style="color:#000;font-weight:bold">)</span>
                                p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span> <span style="color:#000;font-weight:bold">=</span> value<span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#998;font-style:italic">// 如果元素 Count 不等于0 则表明已经放入了，可以终止循环了
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>binCount <span style="color:#000;font-weight:bold">!=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 对于链表如果元素数来大于 阈值 64 则尝试转换链表为红黑树
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>binCount <span style="color:#000;font-weight:bold">&gt;=</span> TREEIFY_THRESHOLD<span style="color:#000;font-weight:bold">)</span>
                    treeifyBin<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#998;font-style:italic">// 如果是覆盖则返回旧值
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>oldVal <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">return</span> oldVal<span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
    addCount<span style="color:#000;font-weight:bold">(</span>1L<span style="color:#000;font-weight:bold">,</span> binCount<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#998;font-style:italic">// 获取转换后的 Hash 值
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">spread</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> h<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span>h <span style="color:#000;font-weight:bold">^</span> <span style="color:#000;font-weight:bold">(</span>h <span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> 16<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">&amp;</span> HASH_BITS<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#998;font-style:italic">// 获取 i 位置的元素
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">tabAt</span><span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> i<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;)</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getObjectVolatile</span><span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#458;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span>i <span style="color:#000;font-weight:bold">&lt;&lt;</span> ASHIFT<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> ABASE<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#998;font-style:italic">// CAS 设置 i 位置元素的值
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">casTabAt</span><span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> i<span style="color:#000;font-weight:bold">,</span>
                                    Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> c<span style="color:#000;font-weight:bold">,</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> v<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapObject</span><span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#458;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span>i <span style="color:#000;font-weight:bold">&lt;&lt;</span> ASHIFT<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> ABASE<span style="color:#000;font-weight:bold">,</span> c<span style="color:#000;font-weight:bold">,</span> v<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 向 红黑树中 添加元素 
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">final</span> TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">putTreeVal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> h<span style="color:#000;font-weight:bold">,</span> K k<span style="color:#000;font-weight:bold">,</span> V v<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
     Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> kc <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
     <span style="color:#458;font-weight:bold">boolean</span> searched <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
     <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> p <span style="color:#000;font-weight:bold">=</span> root<span style="color:#000;font-weight:bold">;;)</span> <span style="color:#000;font-weight:bold">{</span>
         <span style="color:#458;font-weight:bold">int</span> dir<span style="color:#000;font-weight:bold">,</span> ph<span style="color:#000;font-weight:bold">;</span> K pk<span style="color:#000;font-weight:bold">;</span>
         <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>p <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
             first <span style="color:#000;font-weight:bold">=</span> root <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>h<span style="color:#000;font-weight:bold">,</span> k<span style="color:#000;font-weight:bold">,</span> v<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
             <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
         <span style="color:#000;font-weight:bold">}</span>
         <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>ph <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> h<span style="color:#000;font-weight:bold">)</span>
             dir <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">;</span>
         <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ph <span style="color:#000;font-weight:bold">&lt;</span> h<span style="color:#000;font-weight:bold">)</span>
             dir <span style="color:#000;font-weight:bold">=</span> 1<span style="color:#000;font-weight:bold">;</span>
         <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>pk <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> k <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>pk <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> k<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>pk<span style="color:#000;font-weight:bold">)))</span>
             <span style="color:#000;font-weight:bold">return</span> p<span style="color:#000;font-weight:bold">;</span>
         <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>kc <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                   <span style="color:#000;font-weight:bold">(</span>kc <span style="color:#000;font-weight:bold">=</span> comparableClassFor<span style="color:#000;font-weight:bold">(</span>k<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span>
                  <span style="color:#000;font-weight:bold">(</span>dir <span style="color:#000;font-weight:bold">=</span> compareComparables<span style="color:#000;font-weight:bold">(</span>kc<span style="color:#000;font-weight:bold">,</span> k<span style="color:#000;font-weight:bold">,</span> pk<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
             <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>searched<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                 TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> q<span style="color:#000;font-weight:bold">,</span> ch<span style="color:#000;font-weight:bold">;</span>
                 searched <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
                 <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(((</span>ch <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">left</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                      <span style="color:#000;font-weight:bold">(</span>q <span style="color:#000;font-weight:bold">=</span> ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findTreeNode</span><span style="color:#000;font-weight:bold">(</span>h<span style="color:#000;font-weight:bold">,</span> k<span style="color:#000;font-weight:bold">,</span> kc<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span>
                     <span style="color:#000;font-weight:bold">((</span>ch <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">right</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                      <span style="color:#000;font-weight:bold">(</span>q <span style="color:#000;font-weight:bold">=</span> ch<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findTreeNode</span><span style="color:#000;font-weight:bold">(</span>h<span style="color:#000;font-weight:bold">,</span> k<span style="color:#000;font-weight:bold">,</span> kc<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">))</span>
                     <span style="color:#000;font-weight:bold">return</span> q<span style="color:#000;font-weight:bold">;</span>
             <span style="color:#000;font-weight:bold">}</span>
             dir <span style="color:#000;font-weight:bold">=</span> tieBreakOrder<span style="color:#000;font-weight:bold">(</span>k<span style="color:#000;font-weight:bold">,</span> pk<span style="color:#000;font-weight:bold">);</span>
         <span style="color:#000;font-weight:bold">}</span>

         TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> xp <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
         <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>p <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>dir <span style="color:#000;font-weight:bold">&lt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">left</span> <span style="color:#000;font-weight:bold">:</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">right</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
             TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> x<span style="color:#000;font-weight:bold">,</span> f <span style="color:#000;font-weight:bold">=</span> first<span style="color:#000;font-weight:bold">;</span>
             first <span style="color:#000;font-weight:bold">=</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>h<span style="color:#000;font-weight:bold">,</span> k<span style="color:#000;font-weight:bold">,</span> v<span style="color:#000;font-weight:bold">,</span> f<span style="color:#000;font-weight:bold">,</span> xp<span style="color:#000;font-weight:bold">);</span>
             <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>f <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
                 f<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prev</span> <span style="color:#000;font-weight:bold">=</span> x<span style="color:#000;font-weight:bold">;</span>
             <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>dir <span style="color:#000;font-weight:bold">&lt;=</span> 0<span style="color:#000;font-weight:bold">)</span>
                 xp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">left</span> <span style="color:#000;font-weight:bold">=</span> x<span style="color:#000;font-weight:bold">;</span>
             <span style="color:#000;font-weight:bold">else</span>
                 xp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">right</span> <span style="color:#000;font-weight:bold">=</span> x<span style="color:#000;font-weight:bold">;</span>
             <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>xp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">red</span><span style="color:#000;font-weight:bold">)</span>
                 x<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">red</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
             <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                 lockRoot<span style="color:#000;font-weight:bold">();</span>
                 <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
                     root <span style="color:#000;font-weight:bold">=</span> balanceInsertion<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">,</span> x<span style="color:#000;font-weight:bold">);</span>
                 <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                     unlockRoot<span style="color:#000;font-weight:bold">();</span>
                 <span style="color:#000;font-weight:bold">}</span>
             <span style="color:#000;font-weight:bold">}</span>
             <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
         <span style="color:#000;font-weight:bold">}</span>
     <span style="color:#000;font-weight:bold">}</span>
     <span style="color:#000;font-weight:bold">assert</span> checkInvariants<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">);</span>
     <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
 <span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 尝试链表转红黑树  
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">treeifyBin</span><span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> index<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> b<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> n<span style="color:#000;font-weight:bold">,</span> sc<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 链表不为空
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>tab <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 判断 table 的长度是否小于 64 ，如果小于则进行扩容
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>n <span style="color:#000;font-weight:bold">=</span> tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> MIN_TREEIFY_CAPACITY<span style="color:#000;font-weight:bold">)</span>
            tryPresize<span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">&lt;&lt;</span> 1<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">// 如果 index 位置的元素不为空且 hash 大于 0
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>b <span style="color:#000;font-weight:bold">=</span> tabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> index<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> b<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span> <span style="color:#000;font-weight:bold">&gt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// 同步锁
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span>b<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 判断 index 位置的元素是否等于 刚才获取的元素
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>tabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> index<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> b<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                    TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> hd <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> tl <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
                    <span style="color:#998;font-style:italic">// 将 Node 转换为 TreeNode
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> e <span style="color:#000;font-weight:bold">=</span> b<span style="color:#000;font-weight:bold">;</span> e <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span> e <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> p <span style="color:#000;font-weight:bold">=</span>
                            <span style="color:#000;font-weight:bold">new</span> TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">key</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span><span style="color:#000;font-weight:bold">,</span>
                                              <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prev</span> <span style="color:#000;font-weight:bold">=</span> tl<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
                            hd <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">else</span>
                            tl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span> <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                        tl <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                    <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#998;font-style:italic">// 替换原本 index 位置为 TreeBin 元素，在 TreeBin 的构造方法中
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#998;font-style:italic">// 完成了链表到红黑树的转换
</span><span style="color:#998;font-style:italic"></span>                    setTabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> index<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> TreeBin<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>hd<span style="color:#000;font-weight:bold">));</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 修改当前存储值的数量，并检测是否需要扩容
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">addCount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">long</span> x<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">int</span> check<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    CounterCell<span style="color:#000;font-weight:bold">[]</span> as<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">long</span> b<span style="color:#000;font-weight:bold">,</span> s<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 更新 BaseCount
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// counterCells 数组中有可用的计数器，去尝试给计数器增加 x
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>as <span style="color:#000;font-weight:bold">=</span> counterCells<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span>
        <span style="color:#000;font-weight:bold">!</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapLong</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> BASECOUNT<span style="color:#000;font-weight:bold">,</span> b <span style="color:#000;font-weight:bold">=</span> baseCount<span style="color:#000;font-weight:bold">,</span> s <span style="color:#000;font-weight:bold">=</span> b <span style="color:#000;font-weight:bold">+</span> x<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        CounterCell a<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">long</span> v<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> m<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#458;font-weight:bold">boolean</span> uncontended <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#998;font-style:italic">// 如果 CAS 更新 baseCount 失败则进入 fullAddCount
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>as <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>m <span style="color:#000;font-weight:bold">=</span> as<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> 0 <span style="color:#000;font-weight:bold">||</span>
            <span style="color:#000;font-weight:bold">(</span>a <span style="color:#000;font-weight:bold">=</span> as<span style="color:#000;font-weight:bold">[</span>ThreadLocalRandom<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProbe</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;</span> m<span style="color:#000;font-weight:bold">])</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span>
            <span style="color:#000;font-weight:bold">!(</span>uncontended <span style="color:#000;font-weight:bold">=</span>
              U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapLong</span><span style="color:#000;font-weight:bold">(</span>a<span style="color:#000;font-weight:bold">,</span> CELLVALUE<span style="color:#000;font-weight:bold">,</span> v <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">value</span><span style="color:#000;font-weight:bold">,</span> v <span style="color:#000;font-weight:bold">+</span> x<span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
            fullAddCount<span style="color:#000;font-weight:bold">(</span>x<span style="color:#000;font-weight:bold">,</span> uncontended<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>check <span style="color:#000;font-weight:bold">&lt;=</span> 1<span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#998;font-style:italic">// 计算新的 baseCount 的值
</span><span style="color:#998;font-style:italic"></span>        s <span style="color:#000;font-weight:bold">=</span> sumCount<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 如果 check 大于 0 则检测是否需要扩容
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>check <span style="color:#000;font-weight:bold">&gt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">,</span> nt<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> n<span style="color:#000;font-weight:bold">,</span> sc<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#998;font-style:italic">// 大于阈值且 table 不为空的时候进行扩容
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>s <span style="color:#000;font-weight:bold">&gt;=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span>sc <span style="color:#000;font-weight:bold">=</span> sizeCtl<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>tab <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
               <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">=</span> tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> MAXIMUM_CAPACITY<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#458;font-weight:bold">int</span> rs <span style="color:#000;font-weight:bold">=</span> resizeStamp<span style="color:#000;font-weight:bold">(</span>n<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>sc <span style="color:#000;font-weight:bold">&lt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>sc <span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> RESIZE_STAMP_SHIFT<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> rs <span style="color:#000;font-weight:bold">||</span> sc <span style="color:#000;font-weight:bold">==</span> rs <span style="color:#000;font-weight:bold">+</span> 1 <span style="color:#000;font-weight:bold">||</span>
                    sc <span style="color:#000;font-weight:bold">==</span> rs <span style="color:#000;font-weight:bold">+</span> MAX_RESIZERS <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>nt <span style="color:#000;font-weight:bold">=</span> nextTable<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span>
                    transferIndex <span style="color:#000;font-weight:bold">&lt;=</span> 0<span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> SIZECTL<span style="color:#000;font-weight:bold">,</span> sc<span style="color:#000;font-weight:bold">,</span> sc <span style="color:#000;font-weight:bold">+</span> 1<span style="color:#000;font-weight:bold">))</span>
                    transfer<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> nt<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> SIZECTL<span style="color:#000;font-weight:bold">,</span> sc<span style="color:#000;font-weight:bold">,</span>
                                         <span style="color:#000;font-weight:bold">(</span>rs <span style="color:#000;font-weight:bold">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> 2<span style="color:#000;font-weight:bold">))</span>
                transfer<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
            s <span style="color:#000;font-weight:bold">=</span> sumCount<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// addCount 方法在 CAS 操作失败之后进入该方法。
</span><span style="color:#998;font-style:italic">// 在多个统计变量上做递增
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">fullAddCount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">long</span> x<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">boolean</span> wasUncontended<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">int</span> h<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>h <span style="color:#000;font-weight:bold">=</span> ThreadLocalRandom<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProbe</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        ThreadLocalRandom<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">localInit</span><span style="color:#000;font-weight:bold">();</span>      <span style="color:#998;font-style:italic">// force initialization
</span><span style="color:#998;font-style:italic"></span>        h <span style="color:#000;font-weight:bold">=</span> ThreadLocalRandom<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProbe</span><span style="color:#000;font-weight:bold">();</span>
        wasUncontended <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#458;font-weight:bold">boolean</span> collide <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>                <span style="color:#998;font-style:italic">// True if last slot nonempty
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;;)</span> <span style="color:#000;font-weight:bold">{</span>
        CounterCell<span style="color:#000;font-weight:bold">[]</span> as<span style="color:#000;font-weight:bold">;</span> CounterCell a<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> n<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">long</span> v<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>as <span style="color:#000;font-weight:bold">=</span> counterCells<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">=</span> as<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>a <span style="color:#000;font-weight:bold">=</span> as<span style="color:#000;font-weight:bold">[(</span>n <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;</span> h<span style="color:#000;font-weight:bold">])</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cellsBusy <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>            <span style="color:#998;font-style:italic">// Try to attach new Cell
</span><span style="color:#998;font-style:italic"></span>                    CounterCell r <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CounterCell<span style="color:#000;font-weight:bold">(</span>x<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// Optimistic create
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cellsBusy <span style="color:#000;font-weight:bold">==</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                        U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> CELLSBUSY<span style="color:#000;font-weight:bold">,</span> 0<span style="color:#000;font-weight:bold">,</span> 1<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#458;font-weight:bold">boolean</span> created <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>               <span style="color:#998;font-style:italic">// Recheck under lock
</span><span style="color:#998;font-style:italic"></span>                            CounterCell<span style="color:#000;font-weight:bold">[]</span> rs<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> m<span style="color:#000;font-weight:bold">,</span> j<span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>rs <span style="color:#000;font-weight:bold">=</span> counterCells<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                                <span style="color:#000;font-weight:bold">(</span>m <span style="color:#000;font-weight:bold">=</span> rs<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                                rs<span style="color:#000;font-weight:bold">[</span>j <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>m <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;</span> h<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                                rs<span style="color:#000;font-weight:bold">[</span>j<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> r<span style="color:#000;font-weight:bold">;</span>
                                created <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                            cellsBusy <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>created<span style="color:#000;font-weight:bold">)</span>
                            <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>           <span style="color:#998;font-style:italic">// Slot is now non-empty
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000;font-weight:bold">}</span>
                collide <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>wasUncontended<span style="color:#000;font-weight:bold">)</span>       <span style="color:#998;font-style:italic">// CAS already known to fail
</span><span style="color:#998;font-style:italic"></span>                wasUncontended <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#998;font-style:italic">// Continue after rehash
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapLong</span><span style="color:#000;font-weight:bold">(</span>a<span style="color:#000;font-weight:bold">,</span> CELLVALUE<span style="color:#000;font-weight:bold">,</span> v <span style="color:#000;font-weight:bold">=</span> a<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">value</span><span style="color:#000;font-weight:bold">,</span> v <span style="color:#000;font-weight:bold">+</span> x<span style="color:#000;font-weight:bold">))</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>counterCells <span style="color:#000;font-weight:bold">!=</span> as <span style="color:#000;font-weight:bold">||</span> n <span style="color:#000;font-weight:bold">&gt;=</span> NCPU<span style="color:#000;font-weight:bold">)</span>
                collide <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#998;font-style:italic">// At max size or stale
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>collide<span style="color:#000;font-weight:bold">)</span>
                collide <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cellsBusy <span style="color:#000;font-weight:bold">==</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                     U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> CELLSBUSY<span style="color:#000;font-weight:bold">,</span> 0<span style="color:#000;font-weight:bold">,</span> 1<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>counterCells <span style="color:#000;font-weight:bold">==</span> as<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#998;font-style:italic">// Expand table unless stale
</span><span style="color:#998;font-style:italic"></span>                        CounterCell<span style="color:#000;font-weight:bold">[]</span> rs <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CounterCell<span style="color:#000;font-weight:bold">[</span>n <span style="color:#000;font-weight:bold">&lt;&lt;</span> 1<span style="color:#000;font-weight:bold">];</span>
                        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> n<span style="color:#000;font-weight:bold">;</span> <span style="color:#000;font-weight:bold">++</span>i<span style="color:#000;font-weight:bold">)</span>
                            rs<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> as<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">];</span>
                        counterCells <span style="color:#000;font-weight:bold">=</span> rs<span style="color:#000;font-weight:bold">;</span>
                    <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                    cellsBusy <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">}</span>
                collide <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>                   <span style="color:#998;font-style:italic">// Retry with expanded table
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">}</span>
            h <span style="color:#000;font-weight:bold">=</span> ThreadLocalRandom<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">advanceProbe</span><span style="color:#000;font-weight:bold">(</span>h<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cellsBusy <span style="color:#000;font-weight:bold">==</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span> counterCells <span style="color:#000;font-weight:bold">==</span> as <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                 U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> CELLSBUSY<span style="color:#000;font-weight:bold">,</span> 0<span style="color:#000;font-weight:bold">,</span> 1<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#458;font-weight:bold">boolean</span> init <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>                           <span style="color:#998;font-style:italic">// Initialize table
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>counterCells <span style="color:#000;font-weight:bold">==</span> as<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                    CounterCell<span style="color:#000;font-weight:bold">[]</span> rs <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CounterCell<span style="color:#000;font-weight:bold">[</span>2<span style="color:#000;font-weight:bold">];</span>
                    rs<span style="color:#000;font-weight:bold">[</span>h <span style="color:#000;font-weight:bold">&amp;</span> 1<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CounterCell<span style="color:#000;font-weight:bold">(</span>x<span style="color:#000;font-weight:bold">);</span>
                    counterCells <span style="color:#000;font-weight:bold">=</span> rs<span style="color:#000;font-weight:bold">;</span>
                    init <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                cellsBusy <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>init<span style="color:#000;font-weight:bold">)</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapLong</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> BASECOUNT<span style="color:#000;font-weight:bold">,</span> v <span style="color:#000;font-weight:bold">=</span> baseCount<span style="color:#000;font-weight:bold">,</span> v <span style="color:#000;font-weight:bold">+</span> x<span style="color:#000;font-weight:bold">))</span>
            <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>                          <span style="color:#998;font-style:italic">// Fall back on using base
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="初始化-table">初始化 Table</h3>
<p>ConcurrentHashMap 的初始化也是在 put 一个元素时进行的，而不是在构造函数中进行初始化的。初始化的主要流程如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 初始化 Table
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> <span style="color:#900;font-weight:bold">initTable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> sc<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// Table 为空的时需要初始化
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span>tab <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 小于 0 表示正在初始化，所以需要当前线程放弃 CPU
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>sc <span style="color:#000;font-weight:bold">=</span> sizeCtl<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> 0<span style="color:#000;font-weight:bold">)</span>
            Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">yield</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#998;font-style:italic">// lost initialization race; just spin
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// 设置初始化标记
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> SIZECTL<span style="color:#000;font-weight:bold">,</span> sc<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 再次判断 table 是否为空
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>tab <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#458;font-weight:bold">int</span> n <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>sc <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> sc <span style="color:#000;font-weight:bold">:</span> DEFAULT_CAPACITY<span style="color:#000;font-weight:bold">;</span>
                    <span style="color:#3c5d5d;font-weight:bold">@SuppressWarnings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;unchecked&#34;</span><span style="color:#000;font-weight:bold">)</span>
                    Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> nt <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[])</span><span style="color:#000;font-weight:bold">new</span> Node<span style="color:#000;font-weight:bold">&lt;?,?&gt;[</span>n<span style="color:#000;font-weight:bold">];</span>
                    table <span style="color:#000;font-weight:bold">=</span> tab <span style="color:#000;font-weight:bold">=</span> nt<span style="color:#000;font-weight:bold">;</span>
                    sc <span style="color:#000;font-weight:bold">=</span> n <span style="color:#000;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> 2<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 设置阈值
</span><span style="color:#998;font-style:italic"></span>                sizeCtl <span style="color:#000;font-weight:bold">=</span> sc<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">return</span> tab<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="table-的扩容">Table 的扩容</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 移动或者复制元素到新的 table
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">final</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">transfer</span><span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">,</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> nextTab<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">int</span> n <span style="color:#000;font-weight:bold">=</span> tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">,</span> stride<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 计算每个 CPU 需要处理的 Node 数量，最低为 16 个
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>stride <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>NCPU <span style="color:#000;font-weight:bold">&gt;</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> 3<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">/</span> NCPU <span style="color:#000;font-weight:bold">:</span> n<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> MIN_TRANSFER_STRIDE<span style="color:#000;font-weight:bold">)</span>
        stride <span style="color:#000;font-weight:bold">=</span> MIN_TRANSFER_STRIDE<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// subdivide range
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//如果新的 Table 为空则新创建一个两倍大的  table 
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>nextTab <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>            <span style="color:#998;font-style:italic">// initiating
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#3c5d5d;font-weight:bold">@SuppressWarnings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;unchecked&#34;</span><span style="color:#000;font-weight:bold">)</span>
            Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> nt <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[])</span><span style="color:#000;font-weight:bold">new</span> Node<span style="color:#000;font-weight:bold">&lt;?,?&gt;[</span>n <span style="color:#000;font-weight:bold">&lt;&lt;</span> 1<span style="color:#000;font-weight:bold">];</span>
            nextTab <span style="color:#000;font-weight:bold">=</span> nt<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable ex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>      <span style="color:#998;font-style:italic">// try to cope with OOME
</span><span style="color:#998;font-style:italic"></span>            sizeCtl <span style="color:#000;font-weight:bold">=</span> Integer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MAX_VALUE</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        nextTable <span style="color:#000;font-weight:bold">=</span> nextTab<span style="color:#000;font-weight:bold">;</span>
        transferIndex <span style="color:#000;font-weight:bold">=</span> n<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 获取新 Table 的长度
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">int</span> nextn <span style="color:#000;font-weight:bold">=</span> nextTab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 创建 ForwardingNode 作为标志节点
</span><span style="color:#998;font-style:italic"></span>    ForwardingNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> fwd <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ForwardingNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>nextTab<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// hash 桶操作完成的标志
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">boolean</span> advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
   <span style="color:#998;font-style:italic">// 扩容完成的标志
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">boolean</span> finishing <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// to ensure sweep before committing nextTab
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">,</span> bound <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;;)</span> <span style="color:#000;font-weight:bold">{</span>
        Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> f<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> fh<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>advance<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// nextIndex: 最后一个元素
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">// nextBound: table 长度减去 桶的大小 stride，最小是 16
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#458;font-weight:bold">int</span> nextIndex<span style="color:#000;font-weight:bold">,</span> nextBound<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#998;font-style:italic">// 如果再当前桶中，直接下一个
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(--</span>i <span style="color:#000;font-weight:bold">&gt;=</span> bound <span style="color:#000;font-weight:bold">||</span> finishing<span style="color:#000;font-weight:bold">)</span>
                advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#998;font-style:italic">// 第一次 transferIndex 是原始 table 的长度
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>nextIndex <span style="color:#000;font-weight:bold">=</span> transferIndex<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                i <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">;</span>
                advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span>
                     <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> TRANSFERINDEX<span style="color:#000;font-weight:bold">,</span> nextIndex<span style="color:#000;font-weight:bold">,</span>
                      nextBound <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>nextIndex <span style="color:#000;font-weight:bold">&gt;</span> stride <span style="color:#000;font-weight:bold">?</span>
                                   nextIndex <span style="color:#000;font-weight:bold">-</span> stride <span style="color:#000;font-weight:bold">:</span> 0<span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 设置 bound = next - stride 最小为 0，就是当前处理的区间
</span><span style="color:#998;font-style:italic"></span>                bound <span style="color:#000;font-weight:bold">=</span> nextBound<span style="color:#000;font-weight:bold">;</span>
                <span style="color:#998;font-style:italic">// 应该处理的第一个元素
</span><span style="color:#998;font-style:italic"></span>                i <span style="color:#000;font-weight:bold">=</span> nextIndex <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">;</span>
                advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// 下面是结束的条件
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>i <span style="color:#000;font-weight:bold">&lt;</span> 0 <span style="color:#000;font-weight:bold">||</span> i <span style="color:#000;font-weight:bold">&gt;=</span> n <span style="color:#000;font-weight:bold">||</span> i <span style="color:#000;font-weight:bold">+</span> n <span style="color:#000;font-weight:bold">&gt;=</span> nextn<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#458;font-weight:bold">int</span> sc<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#998;font-style:italic">// 如果已经结束则删除 nextTable，并把nextTable 放到 table ，设置新的阈值
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>finishing<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                nextTable <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
                table <span style="color:#000;font-weight:bold">=</span> nextTab<span style="color:#000;font-weight:bold">;</span>
                sizeCtl <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">&lt;&lt;</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> 1<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> SIZECTL<span style="color:#000;font-weight:bold">,</span> sc <span style="color:#000;font-weight:bold">=</span> sizeCtl<span style="color:#000;font-weight:bold">,</span> sc <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>sc <span style="color:#000;font-weight:bold">-</span> 2<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> resizeStamp<span style="color:#000;font-weight:bold">(</span>n<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#000;font-weight:bold">)</span>
                    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
                finishing <span style="color:#000;font-weight:bold">=</span> advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
                i <span style="color:#000;font-weight:bold">=</span> n<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// recheck before commit
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// 如果为空则直接设置为空
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>f <span style="color:#000;font-weight:bold">=</span> tabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
            advance <span style="color:#000;font-weight:bold">=</span> casTabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> fwd<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">// 如果当前元素的 hash 为 MOVED 则表示当前元素已经被处理过了
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>fh <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> MOVED<span style="color:#000;font-weight:bold">)</span>
            advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// already processed
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// 同步锁处理非空的坐标
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span>f<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>tabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> f<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                    Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> ln<span style="color:#000;font-weight:bold">,</span> hn<span style="color:#000;font-weight:bold">;</span>
                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>fh <span style="color:#000;font-weight:bold">&gt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#458;font-weight:bold">int</span> runBit <span style="color:#000;font-weight:bold">=</span> fh <span style="color:#000;font-weight:bold">&amp;</span> n<span style="color:#000;font-weight:bold">;</span>
                        Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> lastRun <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#998;font-style:italic">// 获取新的下标
</span><span style="color:#998;font-style:italic"></span>                        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> p <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">;</span> p <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span> p <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                            <span style="color:#458;font-weight:bold">int</span> b <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span> <span style="color:#000;font-weight:bold">&amp;</span> n<span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>b <span style="color:#000;font-weight:bold">!=</span> runBit<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                                runBit <span style="color:#000;font-weight:bold">=</span> b<span style="color:#000;font-weight:bold">;</span>
                                lastRun <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#998;font-style:italic">// 如果下标为 0 设置低位为 需要处理的元素
</span><span style="color:#998;font-style:italic"></span>                        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>runBit <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                            ln <span style="color:#000;font-weight:bold">=</span> lastRun<span style="color:#000;font-weight:bold">;</span>
                            hn <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#998;font-style:italic">// 否则设置高位为需要处理的元素
</span><span style="color:#998;font-style:italic"></span>                        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                            hn <span style="color:#000;font-weight:bold">=</span> lastRun<span style="color:#000;font-weight:bold">;</span>
                            ln <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#998;font-style:italic">// 复制元素，分别到高位和低位两个链表中
</span><span style="color:#998;font-style:italic"></span>                        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> p <span style="color:#000;font-weight:bold">=</span> f<span style="color:#000;font-weight:bold">;</span> p <span style="color:#000;font-weight:bold">!=</span> lastRun<span style="color:#000;font-weight:bold">;</span> p <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                            <span style="color:#458;font-weight:bold">int</span> ph <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">;</span> K pk <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">key</span><span style="color:#000;font-weight:bold">;</span> V pv <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span><span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>ph <span style="color:#000;font-weight:bold">&amp;</span> n<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span>
                                ln <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>ph<span style="color:#000;font-weight:bold">,</span> pk<span style="color:#000;font-weight:bold">,</span> pv<span style="color:#000;font-weight:bold">,</span> ln<span style="color:#000;font-weight:bold">);</span>
                            <span style="color:#000;font-weight:bold">else</span>
                                hn <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>ph<span style="color:#000;font-weight:bold">,</span> pk<span style="color:#000;font-weight:bold">,</span> pv<span style="color:#000;font-weight:bold">,</span> hn<span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#998;font-style:italic">// 分别设置低位和高位的元素
</span><span style="color:#998;font-style:italic"></span>                        setTabAt<span style="color:#000;font-weight:bold">(</span>nextTab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">,</span> ln<span style="color:#000;font-weight:bold">);</span>
                        setTabAt<span style="color:#000;font-weight:bold">(</span>nextTab<span style="color:#000;font-weight:bold">,</span> i <span style="color:#000;font-weight:bold">+</span> n<span style="color:#000;font-weight:bold">,</span> hn<span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#998;font-style:italic">// 设置当前坐标已经处理过了
</span><span style="color:#998;font-style:italic"></span>                        setTabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">,</span> fwd<span style="color:#000;font-weight:bold">);</span>
                        advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
                    <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>f <span style="color:#000;font-weight:bold">instanceof</span> TreeBin<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                        <span style="color:#998;font-style:italic">// 对于树的处理方式
</span><span style="color:#998;font-style:italic"></span>                        TreeBin<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> t <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>TreeBin<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;)</span>f<span style="color:#000;font-weight:bold">;</span>
                        TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> lo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> loTail <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
                        TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> hi <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> hiTail <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#458;font-weight:bold">int</span> lc <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">,</span> hc <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
                        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> e <span style="color:#000;font-weight:bold">=</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">first</span><span style="color:#000;font-weight:bold">;</span> e <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span> e <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                            <span style="color:#458;font-weight:bold">int</span> h <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">;</span>
                            TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> p <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> TreeNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span>
                                <span style="color:#000;font-weight:bold">(</span>h<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">key</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
                            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>h <span style="color:#000;font-weight:bold">&amp;</span> n<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prev</span> <span style="color:#000;font-weight:bold">=</span> loTail<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
                                    lo <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                                <span style="color:#000;font-weight:bold">else</span>
                                    loTail<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span> <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                                loTail <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                                <span style="color:#000;font-weight:bold">++</span>lc<span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">}</span>
                            <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prev</span> <span style="color:#000;font-weight:bold">=</span> hiTail<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span>
                                    hi <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                                <span style="color:#000;font-weight:bold">else</span>
                                    hiTail<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span> <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                                hiTail <span style="color:#000;font-weight:bold">=</span> p<span style="color:#000;font-weight:bold">;</span>
                                <span style="color:#000;font-weight:bold">++</span>hc<span style="color:#000;font-weight:bold">;</span>
                            <span style="color:#000;font-weight:bold">}</span>
                        <span style="color:#000;font-weight:bold">}</span>
                        ln <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>lc <span style="color:#000;font-weight:bold">&lt;=</span> UNTREEIFY_THRESHOLD<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> untreeify<span style="color:#000;font-weight:bold">(</span>lo<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">:</span>
                        <span style="color:#000;font-weight:bold">(</span>hc <span style="color:#000;font-weight:bold">!=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">new</span> TreeBin<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>lo<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">:</span> t<span style="color:#000;font-weight:bold">;</span>
                        hn <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>hc <span style="color:#000;font-weight:bold">&lt;=</span> UNTREEIFY_THRESHOLD<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> untreeify<span style="color:#000;font-weight:bold">(</span>hi<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">:</span>
                        <span style="color:#000;font-weight:bold">(</span>lc <span style="color:#000;font-weight:bold">!=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">new</span> TreeBin<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;(</span>hi<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">:</span> t<span style="color:#000;font-weight:bold">;</span>
                        setTabAt<span style="color:#000;font-weight:bold">(</span>nextTab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">,</span> ln<span style="color:#000;font-weight:bold">);</span>
                        setTabAt<span style="color:#000;font-weight:bold">(</span>nextTab<span style="color:#000;font-weight:bold">,</span> i <span style="color:#000;font-weight:bold">+</span> n<span style="color:#000;font-weight:bold">,</span> hn<span style="color:#000;font-weight:bold">);</span>
                        setTabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> i<span style="color:#000;font-weight:bold">,</span> fwd<span style="color:#000;font-weight:bold">);</span>
                        advance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
                    <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 如果一个线程发现正在扩容，在参与到扩容之中
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">final</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> <span style="color:#900;font-weight:bold">helpTransfer</span><span style="color:#000;font-weight:bold">(</span>Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">,</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> f<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> nextTab<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> sc<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 取出 nextTable 进行初始化
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>tab <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>f <span style="color:#000;font-weight:bold">instanceof</span> ForwardingNode<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
        <span style="color:#000;font-weight:bold">(</span>nextTab <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span>ForwardingNode<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;)</span>f<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">nextTable</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#458;font-weight:bold">int</span> rs <span style="color:#000;font-weight:bold">=</span> resizeStamp<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">// 确保还没有变化
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>nextTab <span style="color:#000;font-weight:bold">==</span> nextTable <span style="color:#000;font-weight:bold">&amp;&amp;</span> table <span style="color:#000;font-weight:bold">==</span> tab <span style="color:#000;font-weight:bold">&amp;&amp;</span>
               <span style="color:#000;font-weight:bold">(</span>sc <span style="color:#000;font-weight:bold">=</span> sizeCtl<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>sc <span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span> RESIZE_STAMP_SHIFT<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> rs <span style="color:#000;font-weight:bold">||</span> sc <span style="color:#000;font-weight:bold">==</span> rs <span style="color:#000;font-weight:bold">+</span> 1 <span style="color:#000;font-weight:bold">||</span>
                sc <span style="color:#000;font-weight:bold">==</span> rs <span style="color:#000;font-weight:bold">+</span> MAX_RESIZERS <span style="color:#000;font-weight:bold">||</span> transferIndex <span style="color:#000;font-weight:bold">&lt;=</span> 0<span style="color:#000;font-weight:bold">)</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>U<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">compareAndSwapInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> SIZECTL<span style="color:#000;font-weight:bold">,</span> sc<span style="color:#000;font-weight:bold">,</span> sc <span style="color:#000;font-weight:bold">+</span> 1<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#998;font-style:italic">// 参与到扩容之中
</span><span style="color:#998;font-style:italic"></span>                transfer<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> nextTab<span style="color:#000;font-weight:bold">);</span>
                <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">return</span> nextTab<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">return</span> table<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="get-操作">Get 操作</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// 获取元素
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> V <span style="color:#900;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span>Object key<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;[]</span> tab<span style="color:#000;font-weight:bold">;</span> Node<span style="color:#000;font-weight:bold">&lt;</span>K<span style="color:#000;font-weight:bold">,</span>V<span style="color:#000;font-weight:bold">&gt;</span> e<span style="color:#000;font-weight:bold">,</span> p<span style="color:#000;font-weight:bold">;</span> <span style="color:#458;font-weight:bold">int</span> n<span style="color:#000;font-weight:bold">,</span> eh<span style="color:#000;font-weight:bold">;</span> K ek<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 获取 hash
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">int</span> h <span style="color:#000;font-weight:bold">=</span> spread<span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hashCode</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>tab <span style="color:#000;font-weight:bold">=</span> table<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">=</span> tab<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span>
        <span style="color:#000;font-weight:bold">(</span>e <span style="color:#000;font-weight:bold">=</span> tabAt<span style="color:#000;font-weight:bold">(</span>tab<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>n <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;</span> h<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>eh <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> h<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// 如果找到直接返回
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>ek <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> key <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>ek <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> key<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>ek<span style="color:#000;font-weight:bold">)))</span>
                <span style="color:#000;font-weight:bold">return</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// 如果小于 0 则从树上找
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>eh <span style="color:#000;font-weight:bold">&lt;</span> 0<span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span>p <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">find</span><span style="color:#000;font-weight:bold">(</span>h<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> p<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#998;font-style:italic">// 如果没有找到表明可能是链表，则遍历找
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span>e <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hash</span> <span style="color:#000;font-weight:bold">==</span> h <span style="color:#000;font-weight:bold">&amp;&amp;</span>
                <span style="color:#000;font-weight:bold">((</span>ek <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">==</span> key <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span>ek <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> key<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>ek<span style="color:#000;font-weight:bold">))))</span>
                <span style="color:#000;font-weight:bold">return</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">val</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>参考：</p>
<ol>
<li><a href="http://www.voidcn.com/article/p-hcuguoxo-bob.html">HashMap 多线程下死循环分析及JDK8修复</a></li>
<li><a href="http://footmanff.com/2018/03/13/2018-03-13-ConcurrentHashMap-1/">http://footmanff.com/2018/03/13/2018-03-13-ConcurrentHashMap-1/</a></li>
<li><a href="https://www.cnblogs.com/yangming1996/p/8031199.html">为并发而生的 ConcurrentHashMap（Java 8）</a></li>
</ol>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="https://sangzhenya.github.io/post/Java/JUC/Java-CAS/">Java CAS</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Java/JUC/Java-volatile/">Java volatile</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Java/JUC/Java-ReentrantLock/">Java ReentrantLock</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Java/JUC/Java-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/">Java 并发控制</a></li>
        
        <li><a href="https://sangzhenya.github.io/post/Java/JUC/Java-AQS/">Java AQS</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='https://sangzhenya.github.io/tags/java'>java</a></li>
                
                <li><a href='https://sangzhenya.github.io/tags/JUC'>JUC</a></li>
                
                <li><a href='https://sangzhenya.github.io/tags/%E9%9B%86%E5%90%88'>集合</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://sangzhenya.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-JNDI/" title="Java JNDI">Java JNDI</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-JVM/" title="Java JVM">Java JVM</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-HotSpot-GC-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" title="Java HotSpot GC 算法实现">Java HotSpot GC 算法实现</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-GC-2/" title="Java GC 2">Java GC 2</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-GC-1/" title="Java GC 1">Java GC 1</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="Java 虚拟机内存模型">Java 虚拟机内存模型</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/" title="Java 逃逸分析">Java 逃逸分析</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E5%9B%9B%E7%A7%8D%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" title="Java 四种引用类型">Java 四种引用类型</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/Dubbo-%E5%8E%9F%E7%90%86/" title="Dubbo 原理">Dubbo 原理</a>
    </li>
    
    <li>
        <a href="https://sangzhenya.github.io/post/Java/JVM/Java-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B/" title="Java 双亲委派模型">Java 双亲委派模型</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="https://sangzhenya.github.io/categories/Java/">Java (22)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/MQ/">MQ (3)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/MyBaits/">MyBaits (7)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/MySQL/">MySQL (4)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Netty/">Netty (10)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Nginx/">Nginx (2)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Redis/">Redis (2)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/Spring/">Spring (36)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E5%85%B3%E4%BA%8E/">关于 (1)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E5%85%B6%E4%BB%96/">其他 (8)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 (11)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E7%AE%97%E6%B3%95/">算法 (3)</a></li>
    
    <li><a href="https://sangzhenya.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (7)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://sangzhenya.github.io/tags/Active-MQ/">Active MQ</a>
    
    <a href="https://sangzhenya.github.io/tags/Cookie/">Cookie</a>
    
    <a href="https://sangzhenya.github.io/tags/Debug/">Debug</a>
    
    <a href="https://sangzhenya.github.io/tags/Docker/">Docker</a>
    
    <a href="https://sangzhenya.github.io/tags/Dubbo/">Dubbo</a>
    
    <a href="https://sangzhenya.github.io/tags/Git/">Git</a>
    
    <a href="https://sangzhenya.github.io/tags/JDK8/">JDK8</a>
    
    <a href="https://sangzhenya.github.io/tags/JPA/">JPA</a>
    
    <a href="https://sangzhenya.github.io/tags/JUC/">JUC</a>
    
    <a href="https://sangzhenya.github.io/tags/JVM/">JVM</a>
    
    <a href="https://sangzhenya.github.io/tags/java/">java</a>
    
    <a href="https://sangzhenya.github.io/tags/Jenkins/">Jenkins</a>
    
    <a href="https://sangzhenya.github.io/tags/Kafka/">Kafka</a>
    
    <a href="https://sangzhenya.github.io/tags/Kubernetes/">Kubernetes</a>
    
    <a href="https://sangzhenya.github.io/tags/Linux/">Linux</a>
    
    <a href="https://sangzhenya.github.io/tags/Maven/">Maven</a>
    
    <a href="https://sangzhenya.github.io/tags/MyBaits/">MyBaits</a>
    
    <a href="https://sangzhenya.github.io/tags/MySQL/">MySQL</a>
    
    <a href="https://sangzhenya.github.io/tags/Netty/">Netty</a>
    
    <a href="https://sangzhenya.github.io/tags/Nginx/">Nginx</a>
    
    <a href="https://sangzhenya.github.io/tags/Rabbit-MQ/">Rabbit MQ</a>
    
    <a href="https://sangzhenya.github.io/tags/Redis/">Redis</a>
    
    <a href="https://sangzhenya.github.io/tags/Rocket-MQ/">Rocket MQ</a>
    
    <a href="https://sangzhenya.github.io/tags/Session/">Session</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring/">Spring</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Boot/">Spring Boot</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Cloud/">Spring Cloud</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Data/">Spring Data</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-MVC/">Spring MVC</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-Security/">Spring Security</a>
    
    <a href="https://sangzhenya.github.io/tags/Spring-%E6%B3%A8%E8%A7%A3/">Spring 注解</a>
    
    <a href="https://sangzhenya.github.io/tags/Tmux/">Tmux</a>
    
    <a href="https://sangzhenya.github.io/tags/Zookeeper/">Zookeeper</a>
    
    <a href="https://sangzhenya.github.io/tags/java/">java</a>
    
    <a href="https://sangzhenya.github.io/tags/%E4%BB%A3%E7%A0%81/">代码</a>
    
    <a href="https://sangzhenya.github.io/tags/%E5%85%B3%E4%BA%8E/">关于</a>
    
    <a href="https://sangzhenya.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
    
    <a href="https://sangzhenya.github.io/tags/%E6%BA%90%E7%A0%81/">源码</a>
    
    <a href="https://sangzhenya.github.io/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
    <a href="https://sangzhenya.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
    
    <a href="https://sangzhenya.github.io/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
    
    <a href="https://sangzhenya.github.io/tags/%E9%9B%86%E5%90%88/">集合</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://sangzhenya.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="https://sangzhenya.github.io/">新月的博客 By 新月</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        Theme based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='https://sangzhenya.github.io/js/totop.js?v=0.0.0' async=""></script>






</body>

</html>