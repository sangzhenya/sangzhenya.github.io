<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Dubbo 原理 | 新月的博客</title>
    <meta property="og:title" content="Dubbo 原理 - 新月的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-02-07T09:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-02-07T09:00:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Dubbo 原理">
        
    <meta name="author" content="新月">
    <meta property="og:url" content="http://programya.com/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/Dubbo-%E5%8E%9F%E7%90%86/">
    <link rel="shortcut icon" href="http://programya.com/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='http://programya.com/css/normalize.css'>
    <link rel="stylesheet" href='http://programya.com/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://programya.com/">
                        新月的博客
                    </a>
                
                <p class="description">晚来天欲雪，能饮一杯无？</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://programya.com/">首页</a>
                    
                    <a  href="http://programya.com/archives/" title="归档">归档</a>
                    
                    <a  href="http://programya.com/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Dubbo 原理</h1>
        </header>
        <date class="post-meta meta-date">
            2020年2月7日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='http://programya.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1'>微服务</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>参考：<a href="http://dubbo.apache.org/zh-cn/docs/dev/design.html">Dubbo 开发者指南</a></p>
<p>Dubbo 整体框架设计如下：</p>
<p><img src="http://img.programya.com/20200104110704.png" alt="框架设计"></p>
<p>图中左边淡蓝背景的为服务消费方使用的接口，右边淡绿色背景的为服务提供方使用的接口，位于中轴线上的为双方都用到的接口。</p>
<p>主要包含 config 层，proxy 服务代理层，registry 注册中心层，cluster 路由层，monitor 监控层，protocol 远程调用层，exchange 信息交换层，transport 网络传输层，serialize 数据序列化层。</p>
<h3 id="启动流程">启动流程</h3>
<p>一个简单的 Dubbo Provider 的配置如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000;font-weight:bold">dubbo</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">application</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>dubbo-provider<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">registry</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">address</span>:<span style="color:#bbb"> </span>zookeeper://<span style="color:#099">192.168.0.111</span>:<span style="color:#099">2181</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">protocol</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>dubbo<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">port</span>:<span style="color:#bbb"> </span><span style="color:#099">20080</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">scan</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">base-packages</span>:<span style="color:#bbb"> </span>com.xinyue.dubbo.provider.service<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的是 <code>DubboConfigurationProperties</code> 配置类。</p>
<p>在 <code>DubboAutoConfiguration</code> 定义如下，为容器中引入了一些 Bean。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@ConditionalOnProperty</span><span style="color:#000;font-weight:bold">(</span>prefix <span style="color:#000;font-weight:bold">=</span> DUBBO_PREFIX<span style="color:#000;font-weight:bold">,</span> name <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;enabled&#34;</span><span style="color:#000;font-weight:bold">,</span> matchIfMissing <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#3c5d5d;font-weight:bold">@Configuration</span>
<span style="color:#998;font-style:italic">// 自动配置后调用
</span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@AutoConfigureAfter</span><span style="color:#000;font-weight:bold">(</span>DubboRelaxedBindingAutoConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#998;font-style:italic">// 启用属性配置
</span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@EnableConfigurationProperties</span><span style="color:#000;font-weight:bold">(</span>DubboConfigurationProperties<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">DubboAutoConfiguration</span> <span style="color:#000;font-weight:bold">{</span>
</code></pre></td></tr></table>
</div>
</div><p>在 <code>dubbo-spring-boot-starter</code> 包中引入了 <code>dubbo-spring-boot-autoconfigure</code> 依赖，其又为引入了 <code>dubbo-spring-boot-autoconfigure-compatible</code> 依赖，在该包中的 <code>META-INFO</code> 下的 <code>spring.factories</code> 文件中定义了 AutoConfig，ApplicationListener 等类如下：</p>
<pre><code class="language-properties" data-lang="properties">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.apache.dubbo.spring.boot.autoconfigure.DubboAutoConfiguration,\
org.apache.dubbo.spring.boot.autoconfigure.DubboRelaxedBindingAutoConfiguration
org.springframework.context.ApplicationListener=\
org.apache.dubbo.spring.boot.context.event.OverrideDubboConfigApplicationListener,\
org.apache.dubbo.spring.boot.context.event.WelcomeLogoApplicationListener,\
org.apache.dubbo.spring.boot.context.event.AwaitingNonWebApplicationListener
org.springframework.boot.env.EnvironmentPostProcessor=\
org.apache.dubbo.spring.boot.env.DubboDefaultPropertiesEnvironmentPostProcessor
org.springframework.context.ApplicationContextInitializer=\
org.apache.dubbo.spring.boot.context.DubboApplicationContextInitializer
</code></pre><p>首先在 Spring Boot 启动的时候会调用 <code>SpringApplication.prepareEnvironment</code> 方法中会调用 <code>SpringApplicationRunListeners</code> 的 <code>environmentPrepared</code> 方法。在其中会使用初始化的event 派发器派发 <code>ApplicationEnvironmentPreparedEvent</code> 事件。获取所有的 <code>ApplicationListener</code> 逐个调用 <code>onApplicationEvent</code> 方法。在 <code>ConfigFileApplicationListener</code> 类中的 <code>onApplicationEvent</code> 中中会逐个调用 <code>EnvironmentPostProcessor</code> 的<code>postProcessEnvironment</code> 方法。在 <code>DubboDefaultPropertiesEnvironmentPostProcessor</code> 中会从环境变量中取出部分属性（例如 <code>dubbo.application.name</code>） 作为 dubbo 的属性放到环境变量中。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">postProcessEnvironment</span><span style="color:#000;font-weight:bold">(</span>ConfigurableEnvironment environment<span style="color:#000;font-weight:bold">,</span> SpringApplication application<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
   MutablePropertySources propertySources <span style="color:#000;font-weight:bold">=</span> environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPropertySources</span><span style="color:#000;font-weight:bold">();</span>
   <span style="color:#998;font-style:italic">// 创建 Default 属性e
</span><span style="color:#998;font-style:italic"></span>   Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> defaultProperties <span style="color:#000;font-weight:bold">=</span> createDefaultProperties<span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">);</span>
   <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>defaultProperties<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
     addOrReplace<span style="color:#000;font-weight:bold">(</span>propertySources<span style="color:#000;font-weight:bold">,</span> defaultProperties<span style="color:#000;font-weight:bold">);</span>
   <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">createDefaultProperties</span><span style="color:#000;font-weight:bold">(</span>ConfigurableEnvironment environment<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> defaultProperties <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;();</span>
  setDubboApplicationNameProperty<span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">,</span> defaultProperties<span style="color:#000;font-weight:bold">);</span>
  setDubboConfigMultipleProperty<span style="color:#000;font-weight:bold">(</span>defaultProperties<span style="color:#000;font-weight:bold">);</span>
  setDubboApplicationQosEnableProperty<span style="color:#000;font-weight:bold">(</span>defaultProperties<span style="color:#000;font-weight:bold">);</span>
  setAllowBeanDefinitionOverriding<span style="color:#000;font-weight:bold">(</span>defaultProperties<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> defaultProperties<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>之后调用到 <code>WelcomeLogoApplicationListener</code> 的 <code>onApplicationEvent</code> 方法，主要是为了打印 Dubbo 的  Banner 信息。</p>
<p>之后调用到 <code>OverrideDubboConfigApplicationListener</code> 的 <code>onApplicationEvent</code> 方法，主要是为了拿到所有的 Dubbo 的属性信息然后放到 <code>ConfigUtils</code> 的 <code>PROPERTIES</code> 上。</p>
<p>在准备好环境之后开始准备刷新容器，调用 <code>SpringApplication</code> 的 <code>prepareContext</code> 方法。在其中会调用 <code>applyInitializers</code> 方法应用初始化，在其中会获取到所有的  <code>ApplicationContextInitializer</code> 的类调用其 <code>initialize</code> 方法。所以这里会调用到 <code>DubboApplicationContextInitializer</code> 的 <code>initialize</code> 方法主要为容器中添加两个 <code>BeanFactoryPostProcessor</code> 类：<code>OverrideBeanDefinitionRegistryPostProcessor</code>， <code>DubboConfigBeanDefinitionConflictProcessor</code>。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DubboApplicationContextInitializer
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">initialize</span><span style="color:#000;font-weight:bold">(</span>ConfigurableApplicationContext applicationContext<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  overrideBeanDefinitions<span style="color:#000;font-weight:bold">(</span>applicationContext<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">overrideBeanDefinitions</span><span style="color:#000;font-weight:bold">(</span>ConfigurableApplicationContext applicationContext<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  applicationContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addBeanFactoryPostProcessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> OverrideBeanDefinitionRegistryPostProcessor<span style="color:#000;font-weight:bold">());</span>
  applicationContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addBeanFactoryPostProcessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> DubboConfigBeanDefinitionConflictProcessor<span style="color:#000;font-weight:bold">());</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后调用  <code>refreshContext</code> 去刷新容器，在刷新容器的过程中有一部调用 <code>invokeBeanFactoryPostProcessors</code> 方法去调用 Bean Factory Processor 为容器中注册 Bean 信息。<code>OverrideBeanDefinitionRegistryPostProcessor</code> 的 <code>postProcessBeanDefinitionRegistry</code> 方法中，为容器中注册了名称为 <code>namePropertyDefaultValueDubboConfigBeanCustomizer</code> 的 <code>DubboConfigBeanCustomizer</code> 类。</p>
<p>在 <code>ConfigurationClassPostProcessor</code> 中 <code>postProcessBeanDefinitionRegistry</code>方法中会调用 <code>processConfigBeanDefinitions</code> 方法根据 <code>registry</code> 信息从配置类的加载 Bean 的定义信息。在 <code>DubboConfigBindingsRegistrar</code> 类的 <code>registerBeanDefinitions</code> 方法中</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DubboConfigBindingsRegistrar
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerBeanDefinitions</span><span style="color:#000;font-weight:bold">(</span>AnnotationMetadata importingClassMetadata<span style="color:#000;font-weight:bold">,</span> BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  AnnotationAttributes attributes <span style="color:#000;font-weight:bold">=</span> AnnotationAttributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">fromMap</span><span style="color:#000;font-weight:bold">(</span>
    importingClassMetadata<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAnnotationAttributes</span><span style="color:#000;font-weight:bold">(</span>EnableDubboConfigBindings<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()));</span>
  <span style="color:#998;font-style:italic">// 获取注解并逐个注册到容器中
</span><span style="color:#998;font-style:italic"></span>  AnnotationAttributes<span style="color:#000;font-weight:bold">[]</span> annotationAttributes <span style="color:#000;font-weight:bold">=</span> attributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAnnotationArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;value&#34;</span><span style="color:#000;font-weight:bold">);</span>
  DubboConfigBindingRegistrar registrar <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DubboConfigBindingRegistrar<span style="color:#000;font-weight:bold">();</span>
  registrar<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setEnvironment</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>AnnotationAttributes element <span style="color:#000;font-weight:bold">:</span> annotationAttributes<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    registrar<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerBeanDefinitions</span><span style="color:#000;font-weight:bold">(</span>element<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DubboConfigBindingRegistrar
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerBeanDefinitions</span><span style="color:#000;font-weight:bold">(</span>AnnotationAttributes attributes<span style="color:#000;font-weight:bold">,</span> BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取属性的前缀  例如 dubbo.applications
</span><span style="color:#998;font-style:italic"></span>  String prefix <span style="color:#000;font-weight:bold">=</span> environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">resolvePlaceholders</span><span style="color:#000;font-weight:bold">(</span>attributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;prefix&#34;</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#998;font-style:italic">// 找到对应的 type 例如 org.apache.dubbo.config.ApplicationConfig
</span><span style="color:#998;font-style:italic"></span>  Class<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> AbstractConfig<span style="color:#000;font-weight:bold">&gt;</span> configClass <span style="color:#000;font-weight:bold">=</span> attributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;type&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#458;font-weight:bold">boolean</span> multiple <span style="color:#000;font-weight:bold">=</span> attributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBoolean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;multiple&#34;</span><span style="color:#000;font-weight:bold">);</span>
  registerDubboConfigBeans<span style="color:#000;font-weight:bold">(</span>prefix<span style="color:#000;font-weight:bold">,</span> configClass<span style="color:#000;font-weight:bold">,</span> multiple<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerDubboConfigBeans</span><span style="color:#000;font-weight:bold">(</span>String prefix<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> AbstractConfig<span style="color:#000;font-weight:bold">&gt;</span> configClass<span style="color:#000;font-weight:bold">,</span>
                                      <span style="color:#458;font-weight:bold">boolean</span> multiple<span style="color:#000;font-weight:bold">,</span> BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 从环境中获取配置，如果没有相关的配置则直接返回
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> properties <span style="color:#000;font-weight:bold">=</span> getPrefixedProperties<span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPropertySources</span><span style="color:#000;font-weight:bold">(),</span> prefix<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>properties<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>log<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isDebugEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      log<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">debug</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;There is no property for binding to dubbo config class [&#34;</span> <span style="color:#000;font-weight:bold">+</span> configClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span>
                <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;] within prefix [&#34;</span> <span style="color:#000;font-weight:bold">+</span> prefix <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;]&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 否则 则去获取到 Bean Name 并注册 Dubbo Config 信息
</span><span style="color:#998;font-style:italic"></span>  Set<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> beanNames <span style="color:#000;font-weight:bold">=</span> multiple <span style="color:#000;font-weight:bold">?</span> resolveMultipleBeanNames<span style="color:#000;font-weight:bold">(</span>properties<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">:</span>
  Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">singleton</span><span style="color:#000;font-weight:bold">(</span>resolveSingleBeanName<span style="color:#000;font-weight:bold">(</span>properties<span style="color:#000;font-weight:bold">,</span> configClass<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String beanName <span style="color:#000;font-weight:bold">:</span> beanNames<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 注册 Config Bean
</span><span style="color:#998;font-style:italic"></span>    registerDubboConfigBean<span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">,</span> configClass<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 注册 Config Bean 绑定的 BeanPostProcessor
</span><span style="color:#998;font-style:italic"></span>    registerDubboConfigBindingBeanPostProcessor<span style="color:#000;font-weight:bold">(</span>prefix<span style="color:#000;font-weight:bold">,</span> beanName<span style="color:#000;font-weight:bold">,</span> multiple<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  registerDubboConfigBeanCustomizers<span style="color:#000;font-weight:bold">(</span>registry<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerDubboConfigBean</span><span style="color:#000;font-weight:bold">(</span>String beanName<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> AbstractConfig<span style="color:#000;font-weight:bold">&gt;</span> configClass<span style="color:#000;font-weight:bold">,</span>
                                         BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 根据 Config 的 class 获取对应的 builder
</span><span style="color:#998;font-style:italic"></span>  BeanDefinitionBuilder builder <span style="color:#000;font-weight:bold">=</span> rootBeanDefinition<span style="color:#000;font-weight:bold">(</span>configClass<span style="color:#000;font-weight:bold">);</span>
  AbstractBeanDefinition beanDefinition <span style="color:#000;font-weight:bold">=</span> builder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBeanDefinition</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 注册 bean 的 定义信息
</span><span style="color:#998;font-style:italic"></span>  registry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerBeanDefinition</span><span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">,</span> beanDefinition<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>log<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    log<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The dubbo config bean definition [name : &#34;</span> <span style="color:#000;font-weight:bold">+</span> beanName <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, class : &#34;</span> <span style="color:#000;font-weight:bold">+</span> configClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span>
             <span style="color:#d14">&#34;] has been registered.&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerDubboConfigBindingBeanPostProcessor</span><span style="color:#000;font-weight:bold">(</span>String prefix<span style="color:#000;font-weight:bold">,</span> String beanName<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">boolean</span> multiple<span style="color:#000;font-weight:bold">,</span>
                                                             BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> processorClass <span style="color:#000;font-weight:bold">=</span> DubboConfigBindingBeanPostProcessor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">;</span>
  BeanDefinitionBuilder builder <span style="color:#000;font-weight:bold">=</span> rootBeanDefinition<span style="color:#000;font-weight:bold">(</span>processorClass<span style="color:#000;font-weight:bold">);</span>
  String actualPrefix <span style="color:#000;font-weight:bold">=</span> multiple <span style="color:#000;font-weight:bold">?</span> buildPrefix<span style="color:#000;font-weight:bold">(</span>prefix<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> beanName <span style="color:#000;font-weight:bold">:</span> prefix<span style="color:#000;font-weight:bold">;</span>
  builder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addConstructorArgValue</span><span style="color:#000;font-weight:bold">(</span>actualPrefix<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">addConstructorArgValue</span><span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">);</span>
  AbstractBeanDefinition beanDefinition <span style="color:#000;font-weight:bold">=</span> builder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBeanDefinition</span><span style="color:#000;font-weight:bold">();</span>
  beanDefinition<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRole</span><span style="color:#000;font-weight:bold">(</span>BeanDefinition<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ROLE_INFRASTRUCTURE</span><span style="color:#000;font-weight:bold">);</span>
  registerWithGeneratedName<span style="color:#000;font-weight:bold">(</span>beanDefinition<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>log<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    log<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The BeanPostProcessor bean definition [&#34;</span> <span style="color:#000;font-weight:bold">+</span> processorClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span>
             <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;] for dubbo config bean [name : &#34;</span> <span style="color:#000;font-weight:bold">+</span> beanName <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;] has been registered.&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerDubboConfigBeanCustomizers</span><span style="color:#000;font-weight:bold">(</span>BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 注册 namePropertyDefaultValueDubboConfigBeanCustomizer 的 Bean
</span><span style="color:#998;font-style:italic"></span>  registerInfrastructureBean<span style="color:#000;font-weight:bold">(</span>registry<span style="color:#000;font-weight:bold">,</span> BEAN_NAME<span style="color:#000;font-weight:bold">,</span> NamePropertyDefaultValueDubboConfigBeanCustomizer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>之后会初始化 <code>BeanDefinitionRegistryPostProcessor</code> ，其中会 <code>DubboAutoConfiguration </code> 中获取 <code>ServiceAnnotationBeanPostProcessor</code> 并指定需要扫描的包。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@ConditionalOnProperty</span><span style="color:#000;font-weight:bold">(</span>prefix <span style="color:#000;font-weight:bold">=</span> DUBBO_SCAN_PREFIX<span style="color:#000;font-weight:bold">,</span> name <span style="color:#000;font-weight:bold">=</span> BASE_PACKAGES_PROPERTY_NAME<span style="color:#000;font-weight:bold">)</span>
<span style="color:#3c5d5d;font-weight:bold">@ConditionalOnBean</span><span style="color:#000;font-weight:bold">(</span>name <span style="color:#000;font-weight:bold">=</span> BASE_PACKAGES_PROPERTY_RESOLVER_BEAN_NAME<span style="color:#000;font-weight:bold">)</span>
<span style="color:#3c5d5d;font-weight:bold">@Bean</span>
<span style="color:#000;font-weight:bold">public</span> ServiceAnnotationBeanPostProcessor <span style="color:#900;font-weight:bold">serviceAnnotationBeanPostProcessor</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#3c5d5d;font-weight:bold">@Qualifier</span><span style="color:#000;font-weight:bold">(</span>BASE_PACKAGES_PROPERTY_RESOLVER_BEAN_NAME<span style="color:#000;font-weight:bold">)</span> PropertyResolver propertyResolver<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  Set<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> packagesToScan <span style="color:#000;font-weight:bold">=</span> propertyResolver<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span>BASE_PACKAGES_PROPERTY_NAME<span style="color:#000;font-weight:bold">,</span> Set<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> emptySet<span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> ServiceAnnotationBeanPostProcessor<span style="color:#000;font-weight:bold">(</span>packagesToScan<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在完成 <code>BeanDefinitionRegistryPostProcessor</code> 的创建之后调用 <code>BeanFactoryPostProcessor</code> 的 <code>postProcessBeanFactory</code> 方法，在 <code>DubboConfigBeanDefinitionConflictProcessor</code> 方法中处理 Application Config Bean，</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">postProcessBeanFactory</span><span style="color:#000;font-weight:bold">(</span>ConfigurableListableBeanFactory beanFactory<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> BeansException <span style="color:#000;font-weight:bold">{</span>
    resolveUniqueApplicationConfigBean<span style="color:#000;font-weight:bold">(</span>registry<span style="color:#000;font-weight:bold">,</span> beanFactory<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>此后在 <code>registerBeanPostProcessors</code> 方法中会将 <code>DubboAutoConfiguration</code> 中定义的 <code>ReferenceAnnotationBeanPostProcessor</code> 加入到容器中。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#3c5d5d;font-weight:bold">@ConditionalOnMissingBean</span>
<span style="color:#3c5d5d;font-weight:bold">@Bean</span><span style="color:#000;font-weight:bold">(</span>name <span style="color:#000;font-weight:bold">=</span> ReferenceAnnotationBeanPostProcessor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">BEAN_NAME</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">public</span> ReferenceAnnotationBeanPostProcessor <span style="color:#900;font-weight:bold">referenceAnnotationBeanPostProcessor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> ReferenceAnnotationBeanPostProcessor<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>最后在 <code>finishBeanFactoryInitialization</code> 方法中会创建处理 Dubbo 需要的几个 Config Bean。在创建的时候会调用 <code>DubboConfigBindingBeanPostProcessor</code> 的 <code>postProcessBeforeInitialization</code> 方法使用自己定义的配置信息配置相关的 Config 类。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">postProcessBeforeInitialization</span><span style="color:#000;font-weight:bold">(</span>Object bean<span style="color:#000;font-weight:bold">,</span> String beanName<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> BeansException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">beanName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> bean <span style="color:#000;font-weight:bold">instanceof</span> AbstractConfig<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    AbstractConfig dubboConfig <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>AbstractConfig<span style="color:#000;font-weight:bold">)</span> bean<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 绑定配置
</span><span style="color:#998;font-style:italic"></span>    bind<span style="color:#000;font-weight:bold">(</span>prefix<span style="color:#000;font-weight:bold">,</span> dubboConfig<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 定制 Config
</span><span style="color:#998;font-style:italic"></span>    customize<span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">,</span> dubboConfig<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> bean<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">customize</span><span style="color:#000;font-weight:bold">(</span>String beanName<span style="color:#000;font-weight:bold">,</span> AbstractConfig dubboConfig<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 逐个调用 Customizer 去定制
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>DubboConfigBeanCustomizer customizer <span style="color:#000;font-weight:bold">:</span> configBeanCustomizers<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    customizer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">customize</span><span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">,</span> dubboConfig<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="服务暴露">服务暴露</h3>
<p>参考：<a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/export-service.html">Dubbo 服务导出</a></p>
<p>在准备好 Config 之后，就可以暴露出服务了。在容器刷新的最后一步你 <code>finishRefresh</code> 方法中会将刷新完成时间发布出去。<code>ServiceBean</code> 为监听这个事件并执行 <code>onApplicationEvent</code> 方法。 在该方法中会 export 服务。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ServiceBean
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">onApplicationEvent</span><span style="color:#000;font-weight:bold">(</span>ContextRefreshedEvent event<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>isExported<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>isUnexported<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The service ready on spring started. service: &#34;</span> <span style="color:#000;font-weight:bold">+</span> getInterface<span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>
    export<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">export</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 调用其父类 ServiceConfig 的方法
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">export</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// Publish ServiceBeanExportedEvent
</span><span style="color:#998;font-style:italic"></span>  publishExportEvent<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">248
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">249
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">250
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">251
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">252
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">253
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">254
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">255
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">256
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">257
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">258
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">259
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">260
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">261
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">262
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">263
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">264
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">265
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">266
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">267
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">268
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">269
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">270
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">271
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">272
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">273
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">274
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">275
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">276
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">277
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">278
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">279
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">280
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">281
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">282
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">283
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">284
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">285
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">286
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">287
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">288
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">289
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">290
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">291
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">292
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">293
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">294
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">295
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">296
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">297
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">298
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">299
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">300
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">301
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">302
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">303
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">304
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">305
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">306
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">307
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">308
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">309
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">310
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">311
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">312
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">313
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">314
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">315
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">316
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">317
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">318
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">319
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">320
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">321
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">322
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">323
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">324
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">325
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">326
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">327
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">328
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">329
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">330
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">331
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">332
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">333
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">334
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">335
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">336
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">337
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">338
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">339
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">340
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">341
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">342
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">343
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">344
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">345
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">346
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">347
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">348
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">349
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">350
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">351
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">352
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">353
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">354
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">355
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">356
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">357
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ServiceConfig
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">export</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  checkAndUpdateSubConfigs<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>shouldExport<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 判断是否应该 delay 如果应该的话则设置 schedule
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>shouldDelay<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    DELAY_EXPORT_EXECUTOR<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">::</span>doExport<span style="color:#000;font-weight:bold">,</span> getDelay<span style="color:#000;font-weight:bold">(),</span> TimeUnit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MILLISECONDS</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 否则开始 export
</span><span style="color:#998;font-style:italic"></span>    doExport<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 检查和更笨 Config
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">checkAndUpdateSubConfigs</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 使用全局的配置补全 Config
</span><span style="color:#998;font-style:italic"></span>  completeCompoundConfigs<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 启动配置中心：从 ConfigManager 获取 configCenter
</span><span style="color:#998;font-style:italic"></span>  startConfigCenter<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// Check 默认值
</span><span style="color:#998;font-style:italic"></span>  checkDefault<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// Check 协议信息
</span><span style="color:#998;font-style:italic"></span>  checkProtocol<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// Check Application
</span><span style="color:#998;font-style:italic"></span>  checkApplication<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// if protocol is not injvm checkRegistry
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>isOnlyInJvm<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// check 注册信息
</span><span style="color:#998;font-style:italic"></span>    checkRegistry<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 刷新
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refresh</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// Check 数据信息
</span><span style="color:#998;font-style:italic"></span>  checkMetadataReport<span style="color:#000;font-weight:bold">();</span>

  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>interfaceName<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;&lt;dubbo:service interface=\&#34;\&#34; /&gt; interface not allow null!&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 是否是泛型 Service
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ref <span style="color:#000;font-weight:bold">instanceof</span> GenericService<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    interfaceClass <span style="color:#000;font-weight:bold">=</span> GenericService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>generic<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      generic <span style="color:#000;font-weight:bold">=</span> Boolean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">TRUE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 获取对应的 interface class
</span><span style="color:#998;font-style:italic"></span>      interfaceClass <span style="color:#000;font-weight:bold">=</span> Class<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forName</span><span style="color:#000;font-weight:bold">(</span>interfaceName<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentThread</span><span style="color:#000;font-weight:bold">()</span>
                                     <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContextClassLoader</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>ClassNotFoundException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// check interface 和 method
</span><span style="color:#998;font-style:italic"></span>    checkInterfaceAndMethods<span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">,</span> methods<span style="color:#000;font-weight:bold">);</span>
    checkRef<span style="color:#000;font-weight:bold">();</span>
    generic <span style="color:#000;font-weight:bold">=</span> Boolean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">FALSE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 判断 local 信息
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>local <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>Boolean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">TRUE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>local<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      local <span style="color:#000;font-weight:bold">=</span> interfaceName <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;Local&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> localClass<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      localClass <span style="color:#000;font-weight:bold">=</span> ClassUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forNameWithThreadContextClassLoader</span><span style="color:#000;font-weight:bold">(</span>local<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>ClassNotFoundException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isAssignableFrom</span><span style="color:#000;font-weight:bold">(</span>localClass<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The local implementation class &#34;</span> <span style="color:#000;font-weight:bold">+</span> localClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; not implement interface &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceName<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 判断存根信息
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>stub <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>Boolean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">TRUE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>stub<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      stub <span style="color:#000;font-weight:bold">=</span> interfaceName <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;Stub&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> stubClass<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      stubClass <span style="color:#000;font-weight:bold">=</span> ClassUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forNameWithThreadContextClassLoader</span><span style="color:#000;font-weight:bold">(</span>stub<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>ClassNotFoundException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isAssignableFrom</span><span style="color:#000;font-weight:bold">(</span>stubClass<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The stub implementation class &#34;</span> <span style="color:#000;font-weight:bold">+</span> stubClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; not implement interface &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceName<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// Legitimacy check of stub, note that: the local will deprecated
</span><span style="color:#998;font-style:italic"></span>  checkStubAndLocal<span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// Legitimacy check and setup of local simulated operations.
</span><span style="color:#998;font-style:italic"></span>  checkMock<span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">startConfigCenter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 当前的 configCenter 如果为空的话则去从 ConfigManager 中获取 Config
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>configCenter <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    ConfigManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getConfigCenter</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">ifPresent</span><span style="color:#000;font-weight:bold">(</span>cc <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configCenter</span> <span style="color:#000;font-weight:bold">=</span> cc<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configCenter</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 刷新 configCenter
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configCenter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refresh</span><span style="color:#000;font-weight:bold">();</span>
    prepareEnvironment<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 调用 ConfigManager 的刷新方法
</span><span style="color:#998;font-style:italic"></span>  ConfigManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">refreshAll</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 刷新 config
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">refresh</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    CompositeConfiguration compositeConfiguration <span style="color:#000;font-weight:bold">=</span> Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getConfiguration</span><span style="color:#000;font-weight:bold">(</span>getPrefix<span style="color:#000;font-weight:bold">(),</span> getId<span style="color:#000;font-weight:bold">());</span>
    Configuration config <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ConfigConfigurationAdapter<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isConfigCenterFirst</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// The sequence would be: SystemConfiguration -&gt; AppExternalConfiguration -&gt; ExternalConfiguration -&gt; AbstractConfig -&gt; PropertiesConfiguration
</span><span style="color:#998;font-style:italic"></span>      compositeConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addConfiguration</span><span style="color:#000;font-weight:bold">(</span>4<span style="color:#000;font-weight:bold">,</span> config<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// The sequence would be: SystemConfiguration -&gt; AbstractConfig -&gt; AppExternalConfiguration -&gt; ExternalConfiguration -&gt; PropertiesConfiguration
</span><span style="color:#998;font-style:italic"></span>      compositeConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addConfiguration</span><span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">,</span> config<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">// loop methods, get override value and set the new value back to method
</span><span style="color:#998;font-style:italic"></span>    Method<span style="color:#000;font-weight:bold">[]</span> methods <span style="color:#000;font-weight:bold">=</span> getClass<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getMethods</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Method method <span style="color:#000;font-weight:bold">:</span> methods<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>MethodUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isSetter</span><span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
          String value <span style="color:#000;font-weight:bold">=</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">trim</span><span style="color:#000;font-weight:bold">(</span>compositeConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>extractPropertyName<span style="color:#000;font-weight:bold">(</span>getClass<span style="color:#000;font-weight:bold">(),</span> method<span style="color:#000;font-weight:bold">)));</span>
          <span style="color:#998;font-style:italic">// isTypeMatch() is called to avoid duplicate and incorrect update, for example, we have two &#39;setGeneric&#39; methods in ReferenceConfig.
</span><span style="color:#998;font-style:italic"></span>          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>value<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> ClassUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isTypeMatch</span><span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterTypes</span><span style="color:#000;font-weight:bold">()[</span>0<span style="color:#000;font-weight:bold">],</span> value<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> ClassUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertPrimitive</span><span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterTypes</span><span style="color:#000;font-weight:bold">()[</span>0<span style="color:#000;font-weight:bold">],</span> value<span style="color:#000;font-weight:bold">));</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>NoSuchMethodException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to override the property &#34;</span> <span style="color:#000;font-weight:bold">+</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; in &#34;</span> <span style="color:#000;font-weight:bold">+</span>
                      <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClass</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getSimpleName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span>
                      <span style="color:#d14">&#34;, please make sure every property has getter/setter method provided.&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isParametersSetter<span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        String value <span style="color:#000;font-weight:bold">=</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">trim</span><span style="color:#000;font-weight:bold">(</span>compositeConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getString</span><span style="color:#000;font-weight:bold">(</span>extractPropertyName<span style="color:#000;font-weight:bold">(</span>getClass<span style="color:#000;font-weight:bold">(),</span> method<span style="color:#000;font-weight:bold">)));</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>value<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> invokeGetParameters<span style="color:#000;font-weight:bold">(</span>getClass<span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
          map <span style="color:#000;font-weight:bold">=</span> map <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;()</span> <span style="color:#000;font-weight:bold">:</span> map<span style="color:#000;font-weight:bold">;</span>
          map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putAll</span><span style="color:#000;font-weight:bold">(</span>convert<span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseParameters</span><span style="color:#000;font-weight:bold">(</span>value<span style="color:#000;font-weight:bold">),</span> <span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">));</span>
          invokeSetParameters<span style="color:#000;font-weight:bold">(</span>getClass<span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> map<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to override &#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 做 export
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doExport</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>unexported<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The service &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; has already unexported!&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>exported<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  exported <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
	<span style="color:#998;font-style:italic">// 获取接口名称
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    path <span style="color:#000;font-weight:bold">=</span> interfaceName<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 执行 Export
</span><span style="color:#998;font-style:italic"></span>  doExportUrls<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 执行 export urls
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doExportUrls</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取中心的 urls
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> registryURLs <span style="color:#000;font-weight:bold">=</span> loadRegistries<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>ProtocolConfig protocolConfig <span style="color:#000;font-weight:bold">:</span> protocols<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 生成 pathkey 和 provider model
</span><span style="color:#998;font-style:italic"></span>    String pathKey <span style="color:#000;font-weight:bold">=</span> URL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">buildKey</span><span style="color:#000;font-weight:bold">(</span>getContextPath<span style="color:#000;font-weight:bold">(</span>protocolConfig<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>p <span style="color:#000;font-weight:bold">-&gt;</span> p <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/&#34;</span> <span style="color:#000;font-weight:bold">+</span> path<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">orElse</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">),</span> group<span style="color:#000;font-weight:bold">,</span> version<span style="color:#000;font-weight:bold">);</span>
    ProviderModel providerModel <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ProviderModel<span style="color:#000;font-weight:bold">(</span>pathKey<span style="color:#000;font-weight:bold">,</span> ref<span style="color:#000;font-weight:bold">,</span> interfaceClass<span style="color:#000;font-weight:bold">);</span>
    ApplicationModel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">initProviderModel</span><span style="color:#000;font-weight:bold">(</span>pathKey<span style="color:#000;font-weight:bold">,</span> providerModel<span style="color:#000;font-weight:bold">);</span>
    doExportUrlsFor1Protocol<span style="color:#000;font-weight:bold">(</span>protocolConfig<span style="color:#000;font-weight:bold">,</span> registryURLs<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 暴露 url
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doExportUrlsFor1Protocol</span><span style="color:#000;font-weight:bold">(</span>ProtocolConfig protocolConfig<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> registryURLs<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  String name <span style="color:#000;font-weight:bold">=</span> protocolConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    name <span style="color:#000;font-weight:bold">=</span> DUBBO<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 元数据的 map
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
  map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>SIDE_KEY<span style="color:#000;font-weight:bold">,</span> PROVIDER_SIDE<span style="color:#000;font-weight:bold">);</span>

  appendRuntimeParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> metrics<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> application<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> module<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// remove &#39;default.&#39; prefix for configs from ProviderConfig
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// appendParameters(map, provider, Constants.DEFAULT_KEY);
</span><span style="color:#998;font-style:italic"></span>  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> provider<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> protocolConfig<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>methods<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>MethodConfig method <span style="color:#000;font-weight:bold">:</span> methods<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> method<span style="color:#000;font-weight:bold">,</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
      String retryKey <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.retry&#34;</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">containsKey</span><span style="color:#000;font-weight:bold">(</span>retryKey<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        String retryValue <span style="color:#000;font-weight:bold">=</span> map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>retryKey<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>Boolean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">FALSE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>retryValue<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.retries&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;0&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
      List<span style="color:#000;font-weight:bold">&lt;</span>ArgumentConfig<span style="color:#000;font-weight:bold">&gt;</span> arguments <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getArguments</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>arguments<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>ArgumentConfig argument <span style="color:#000;font-weight:bold">:</span> arguments<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#998;font-style:italic">// convert argument type
</span><span style="color:#998;font-style:italic"></span>          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            Method<span style="color:#000;font-weight:bold">[]</span> methods <span style="color:#000;font-weight:bold">=</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethods</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#998;font-style:italic">// visit all methods
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>methods <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> methods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
              <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> methods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">;</span> i<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
                String methodName <span style="color:#000;font-weight:bold">=</span> methods<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">].</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">();</span>
                <span style="color:#998;font-style:italic">// target the method, and get its signature
</span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>methodName<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
                  Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argtypes <span style="color:#000;font-weight:bold">=</span> methods<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">].</span><span style="color:#008080">getParameterTypes</span><span style="color:#000;font-weight:bold">();</span>
                  <span style="color:#998;font-style:italic">// one callback in the method
</span><span style="color:#998;font-style:italic"></span>                  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>argtypes<span style="color:#000;font-weight:bold">[</span>argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">()].</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
                      appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> argument<span style="color:#000;font-weight:bold">,</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.&#34;</span> <span style="color:#000;font-weight:bold">+</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">());</span>
                    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Argument config error : the index attribute and type attribute not match :index :&#34;</span> <span style="color:#000;font-weight:bold">+</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, type:&#34;</span> <span style="color:#000;font-weight:bold">+</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">());</span>
                    <span style="color:#000;font-weight:bold">}</span>
                  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#998;font-style:italic">// multiple callbacks in the method
</span><span style="color:#998;font-style:italic"></span>                    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> j <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> j <span style="color:#000;font-weight:bold">&lt;</span> argtypes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">;</span> j<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
                      Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> argclazz <span style="color:#000;font-weight:bold">=</span> argtypes<span style="color:#000;font-weight:bold">[</span>j<span style="color:#000;font-weight:bold">];</span>
                      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>argclazz<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
                        appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> argument<span style="color:#000;font-weight:bold">,</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.&#34;</span> <span style="color:#000;font-weight:bold">+</span> j<span style="color:#000;font-weight:bold">);</span>
                        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span>1 <span style="color:#000;font-weight:bold">&amp;&amp;</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> j<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                          <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Argument config error : the index attribute and type attribute not match :index :&#34;</span> <span style="color:#000;font-weight:bold">+</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, type:&#34;</span> <span style="color:#000;font-weight:bold">+</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">());</span>
                        <span style="color:#000;font-weight:bold">}</span>
                      <span style="color:#000;font-weight:bold">}</span>
                    <span style="color:#000;font-weight:bold">}</span>
                  <span style="color:#000;font-weight:bold">}</span>
                <span style="color:#000;font-weight:bold">}</span>
              <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span>1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> argument<span style="color:#000;font-weight:bold">,</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.&#34;</span> <span style="color:#000;font-weight:bold">+</span> argument<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIndex</span><span style="color:#000;font-weight:bold">());</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Argument config must set index or type attribute.eg: &lt;dubbo:argument index=&#39;0&#39; .../&gt; or &lt;dubbo:argument type=xxx .../&gt;&#34;</span><span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#998;font-style:italic">// end of methods for
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ProtocolUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isGeneric</span><span style="color:#000;font-weight:bold">(</span>generic<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>GENERIC_KEY<span style="color:#000;font-weight:bold">,</span> generic<span style="color:#000;font-weight:bold">);</span>
    map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>METHODS_KEY<span style="color:#000;font-weight:bold">,</span> ANY_VALUE<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    String revision <span style="color:#000;font-weight:bold">=</span> Version<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVersion</span><span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">,</span> version<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>revision <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> revision<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>REVISION_KEY<span style="color:#000;font-weight:bold">,</span> revision<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    String<span style="color:#000;font-weight:bold">[]</span> methods <span style="color:#000;font-weight:bold">=</span> Wrapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getWrapper</span><span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getMethodNames</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>methods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;No method found in service interface &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>METHODS_KEY<span style="color:#000;font-weight:bold">,</span> ANY_VALUE<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>METHODS_KEY<span style="color:#000;font-weight:bold">,</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> HashSet<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;(</span>Arrays<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">asList</span><span style="color:#000;font-weight:bold">(</span>methods<span style="color:#000;font-weight:bold">)),</span> <span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>ConfigUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ConfigUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isDefault</span><span style="color:#000;font-weight:bold">(</span>token<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>TOKEN_KEY<span style="color:#000;font-weight:bold">,</span> UUID<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">randomUUID</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>TOKEN_KEY<span style="color:#000;font-weight:bold">,</span> token<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// export service
</span><span style="color:#998;font-style:italic"></span>  String host <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findConfigedHosts</span><span style="color:#000;font-weight:bold">(</span>protocolConfig<span style="color:#000;font-weight:bold">,</span> registryURLs<span style="color:#000;font-weight:bold">,</span> map<span style="color:#000;font-weight:bold">);</span>
  Integer port <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findConfigedPorts</span><span style="color:#000;font-weight:bold">(</span>protocolConfig<span style="color:#000;font-weight:bold">,</span> name<span style="color:#000;font-weight:bold">,</span> map<span style="color:#000;font-weight:bold">);</span>
  URL url <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> URL<span style="color:#000;font-weight:bold">(</span>name<span style="color:#000;font-weight:bold">,</span> host<span style="color:#000;font-weight:bold">,</span> port<span style="color:#000;font-weight:bold">,</span> getContextPath<span style="color:#000;font-weight:bold">(</span>protocolConfig<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">map</span><span style="color:#000;font-weight:bold">(</span>p <span style="color:#000;font-weight:bold">-&gt;</span> p <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/&#34;</span> <span style="color:#000;font-weight:bold">+</span> path<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">orElse</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">),</span> map<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>ConfiguratorFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasExtension</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
    url <span style="color:#000;font-weight:bold">=</span> ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>ConfiguratorFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtension</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">getConfigurator</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">configure</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  String scope <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>SCOPE_KEY<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// don&#39;t export when none is configured
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>SCOPE_NONE<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span>scope<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#998;font-style:italic">// export to local if the config is not remote (export to remote only when config is remote)
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>SCOPE_REMOTE<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span>scope<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      exportLocal<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// export to remote if the config is not local (export to local only when config is local)
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>SCOPE_LOCAL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span>scope<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>registryURLs<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>URL registryURL <span style="color:#000;font-weight:bold">:</span> registryURLs<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#998;font-style:italic">//if protocol is only injvm ,not register
</span><span style="color:#998;font-style:italic"></span>          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>LOCAL_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#000;font-weight:bold">}</span>
          <span style="color:#998;font-style:italic">// 获取 url
</span><span style="color:#998;font-style:italic"></span>          url <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterIfAbsent</span><span style="color:#000;font-weight:bold">(</span>DYNAMIC_KEY<span style="color:#000;font-weight:bold">,</span> registryURL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>DYNAMIC_KEY<span style="color:#000;font-weight:bold">));</span>
          <span style="color:#998;font-style:italic">// 获取 monitor URL
</span><span style="color:#998;font-style:italic"></span>          URL monitorUrl <span style="color:#000;font-weight:bold">=</span> loadMonitor<span style="color:#000;font-weight:bold">(</span>registryURL<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>monitorUrl <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            url <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterAndEncoded</span><span style="color:#000;font-weight:bold">(</span>MONITOR_KEY<span style="color:#000;font-weight:bold">,</span> monitorUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toFullString</span><span style="color:#000;font-weight:bold">());</span>
          <span style="color:#000;font-weight:bold">}</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>REGISTER_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
              logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Register dubbo service &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; url &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; to registry &#34;</span> <span style="color:#000;font-weight:bold">+</span> registryURL<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
              logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Export dubbo service &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; to url &#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
          <span style="color:#000;font-weight:bold">}</span>

          <span style="color:#998;font-style:italic">// For providers, this is used to enable custom proxy to generate invoker
</span><span style="color:#998;font-style:italic"></span>          String proxy <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>PROXY_KEY<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>proxy<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            registryURL <span style="color:#000;font-weight:bold">=</span> registryURL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameter</span><span style="color:#000;font-weight:bold">(</span>PROXY_KEY<span style="color:#000;font-weight:bold">,</span> proxy<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span>

          <span style="color:#998;font-style:italic">// 获取 invoker
</span><span style="color:#998;font-style:italic"></span>          Invoker<span style="color:#000;font-weight:bold">&lt;?&gt;</span> invoker <span style="color:#000;font-weight:bold">=</span> PROXY_FACTORY<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInvoker</span><span style="color:#000;font-weight:bold">(</span>ref<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">)</span> interfaceClass<span style="color:#000;font-weight:bold">,</span> registryURL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterAndEncoded</span><span style="color:#000;font-weight:bold">(</span>EXPORT_KEY<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toFullString</span><span style="color:#000;font-weight:bold">()));</span>
          <span style="color:#998;font-style:italic">// invoker 包装
</span><span style="color:#998;font-style:italic"></span>          DelegateProviderMetaDataInvoker wrapperInvoker <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DelegateProviderMetaDataInvoker<span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
          <span style="color:#998;font-style:italic">// export 代理
</span><span style="color:#998;font-style:italic"></span>          Exporter<span style="color:#000;font-weight:bold">&lt;?&gt;</span> exporter <span style="color:#000;font-weight:bold">=</span> protocol<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">export</span><span style="color:#000;font-weight:bold">(</span>wrapperInvoker<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#998;font-style:italic">// 添加到 exporter 中
</span><span style="color:#998;font-style:italic"></span>          exporters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>exporter<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
          logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Export dubbo service &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; to url &#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        Invoker<span style="color:#000;font-weight:bold">&lt;?&gt;</span> invoker <span style="color:#000;font-weight:bold">=</span> PROXY_FACTORY<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInvoker</span><span style="color:#000;font-weight:bold">(</span>ref<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">)</span> interfaceClass<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
        DelegateProviderMetaDataInvoker wrapperInvoker <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DelegateProviderMetaDataInvoker<span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>

        Exporter<span style="color:#000;font-weight:bold">&lt;?&gt;</span> exporter <span style="color:#000;font-weight:bold">=</span> protocol<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">export</span><span style="color:#000;font-weight:bold">(</span>wrapperInvoker<span style="color:#000;font-weight:bold">);</span>
        exporters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>exporter<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">                 * @since 2.7.0
</span><span style="color:#998;font-style:italic">                 * ServiceData Store
</span><span style="color:#998;font-style:italic">                 */</span>
      MetadataReportService metadataReportService <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>metadataReportService <span style="color:#000;font-weight:bold">=</span> getMetadataReportService<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 发布 provider 的 metadata
</span><span style="color:#998;font-style:italic"></span>        metadataReportService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">publishProvider</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">urls</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ConfigManager 
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">refreshAll</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// refresh all configs here,
</span><span style="color:#998;font-style:italic"></span>  getApplication<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">ifPresent</span><span style="color:#000;font-weight:bold">(</span>ApplicationConfig<span style="color:#000;font-weight:bold">::</span>refresh<span style="color:#000;font-weight:bold">);</span>
  getMonitor<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">ifPresent</span><span style="color:#000;font-weight:bold">(</span>MonitorConfig<span style="color:#000;font-weight:bold">::</span>refresh<span style="color:#000;font-weight:bold">);</span>
  getModule<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">ifPresent</span><span style="color:#000;font-weight:bold">(</span>ModuleConfig<span style="color:#000;font-weight:bold">::</span>refresh<span style="color:#000;font-weight:bold">);</span>

  getProtocols<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">values</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">forEach</span><span style="color:#000;font-weight:bold">(</span>ProtocolConfig<span style="color:#000;font-weight:bold">::</span>refresh<span style="color:#000;font-weight:bold">);</span>
  getRegistries<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">values</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">forEach</span><span style="color:#000;font-weight:bold">(</span>RegistryConfig<span style="color:#000;font-weight:bold">::</span>refresh<span style="color:#000;font-weight:bold">);</span>
  getProviders<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">values</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">forEach</span><span style="color:#000;font-weight:bold">(</span>ProviderConfig<span style="color:#000;font-weight:bold">::</span>refresh<span style="color:#000;font-weight:bold">);</span>
  getConsumers<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">values</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">forEach</span><span style="color:#000;font-weight:bold">(</span>ConsumerConfig<span style="color:#000;font-weight:bold">::</span>refresh<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AbstractInterfaceConfig
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">checkRegistry</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 加载注册的  Registry 的信息
</span><span style="color:#998;font-style:italic"></span>  loadRegistriesFromBackwardConfig<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 获取外部配置中的 Registry 的信息
</span><span style="color:#998;font-style:italic"></span>  convertRegistryIdsToRegistries<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 遍历 registries 并逐个判断是否是合法的
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>RegistryConfig registryConfig <span style="color:#000;font-weight:bold">:</span> registries<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>registryConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isValid</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;No registry config found or it&#39;s not a valid config! &#34;</span> <span style="color:#000;font-weight:bold">+</span>
                                      <span style="color:#d14">&#34;The registry config is: &#34;</span> <span style="color:#000;font-weight:bold">+</span> registryConfig<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 使用 registries 作为默认的 config center
</span><span style="color:#998;font-style:italic"></span>  useRegistryForConfigIfNecessary<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">useRegistryForConfigIfNecessary</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 遍历 registries
</span><span style="color:#998;font-style:italic"></span>  registries<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span>RegistryConfig<span style="color:#000;font-weight:bold">::</span>isZookeeperProtocol<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">findFirst</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">ifPresent</span><span style="color:#000;font-weight:bold">(</span>rc <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// we use the loading status of DynamicConfiguration to decide whether ConfigCenter has been initiated.
</span><span style="color:#998;font-style:italic"></span>    Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getDynamicConfiguration</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">orElseGet</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      ConfigManager configManager <span style="color:#000;font-weight:bold">=</span> ConfigManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">();</span>
      ConfigCenterConfig cc <span style="color:#000;font-weight:bold">=</span> configManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConfigCenter</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">orElse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ConfigCenterConfig<span style="color:#000;font-weight:bold">());</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameters</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setParameters</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>rc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameters</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameters</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">putAll</span><span style="color:#000;font-weight:bold">(</span>rc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameters</span><span style="color:#000;font-weight:bold">());</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#998;font-style:italic">// 设置 参数/协议/地址/用户名/密码等信息
</span><span style="color:#998;font-style:italic"></span>      cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameters</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>org<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">apache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">dubbo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remoting</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Constants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CLIENT_KEY</span><span style="color:#000;font-weight:bold">,</span>rc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClient</span><span style="color:#000;font-weight:bold">());</span>
      cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setProtocol</span><span style="color:#000;font-weight:bold">(</span>rc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">());</span>
      cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAddress</span><span style="color:#000;font-weight:bold">(</span>rc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">());</span>
      cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUsername</span><span style="color:#000;font-weight:bold">(</span>rc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUsername</span><span style="color:#000;font-weight:bold">());</span>
      cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPassword</span><span style="color:#000;font-weight:bold">(</span>rc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPassword</span><span style="color:#000;font-weight:bold">());</span>
      cc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHighestPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
      setConfigCenter<span style="color:#000;font-weight:bold">(</span>cc<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// 启动 config center
</span><span style="color:#998;font-style:italic"></span>      startConfigCenter<span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">startConfigCenter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>configCenter <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    ConfigManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getConfigCenter</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">ifPresent</span><span style="color:#000;font-weight:bold">(</span>cc <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configCenter</span> <span style="color:#000;font-weight:bold">=</span> cc<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configCenter</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 刷新 config center
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configCenter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refresh</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 准备环境
</span><span style="color:#998;font-style:italic"></span>    prepareEnvironment<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  ConfigManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">refreshAll</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">prepareEnvironment</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isValid</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">checkOrUpdateInited</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 获取动态配置信息
</span><span style="color:#998;font-style:italic"></span>    DynamicConfiguration dynamicConfiguration <span style="color:#000;font-weight:bold">=</span> getDynamicConfiguration<span style="color:#000;font-weight:bold">(</span>configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toUrl</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#998;font-style:italic">// 获取配置内容
</span><span style="color:#998;font-style:italic"></span>    String configContent <span style="color:#000;font-weight:bold">=</span> dynamicConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperties</span><span style="color:#000;font-weight:bold">(</span>configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConfigFile</span><span style="color:#000;font-weight:bold">(),</span> configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getGroup</span><span style="color:#000;font-weight:bold">());</span>
		<span style="color:#998;font-style:italic">// 获取 group name
</span><span style="color:#998;font-style:italic"></span>    String appGroup <span style="color:#000;font-weight:bold">=</span> application <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> application<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    String appConfigContent <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>appGroup<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      appConfigContent <span style="color:#000;font-weight:bold">=</span> dynamicConfiguration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperties</span>
        <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAppConfigFile</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">?</span> configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAppConfigFile</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">:</span> configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConfigFile</span><span style="color:#000;font-weight:bold">(),</span>
         appGroup
        <span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 将 config 相关的信息放到 Environment 上
</span><span style="color:#998;font-style:italic"></span>      Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setConfigCenterFirst</span><span style="color:#000;font-weight:bold">(</span>configCenter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isHighestPriority</span><span style="color:#000;font-weight:bold">());</span>
      Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">updateExternalConfigurationMap</span><span style="color:#000;font-weight:bold">(</span>parseProperties<span style="color:#000;font-weight:bold">(</span>configContent<span style="color:#000;font-weight:bold">));</span>
      Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">updateAppExternalConfigurationMap</span><span style="color:#000;font-weight:bold">(</span>parseProperties<span style="color:#000;font-weight:bold">(</span>appConfigContent<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to parse configurations from Config Center.&#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> DynamicConfiguration <span style="color:#900;font-weight:bold">getDynamicConfiguration</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  DynamicConfigurationFactory factory <span style="color:#000;font-weight:bold">=</span> ExtensionLoader
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>DynamicConfigurationFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtension</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#998;font-style:italic">// 使用工厂根据 URL 获取 DynamicConfiguration
</span><span style="color:#998;font-style:italic"></span>  DynamicConfiguration configuration <span style="color:#000;font-weight:bold">=</span> factory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDynamicConfiguration</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 将获取到的 configuration 放到 环境中
</span><span style="color:#998;font-style:italic"></span>  Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInstance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setDynamicConfiguration</span><span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> configuration<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AbstractDynamicConfigurationFactory
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> DynamicConfiguration <span style="color:#900;font-weight:bold">getDynamicConfiguration</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 如果 dynamicConfiguration 为空则创建一个
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>dynamicConfiguration <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>dynamicConfiguration <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        dynamicConfiguration <span style="color:#000;font-weight:bold">=</span> createDynamicConfiguration<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> dynamicConfiguration<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ZookeeperDynamicConfigurationFactory
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> DynamicConfiguration <span style="color:#900;font-weight:bold">createDynamicConfiguration</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 如果是 zookeeper 类型则创建一个 ZookeeperDynamicConfiguration 
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> ZookeeperDynamicConfiguration<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> zookeeperTransporter<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ZookeeperDynamicConfiguration
</span><span style="color:#998;font-style:italic"></span>ZookeeperDynamicConfiguration<span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> ZookeeperTransporter zookeeperTransporter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 初始化当前类的信息
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">url</span> <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">;</span>
  rootPath <span style="color:#000;font-weight:bold">=</span> PATH_SEPARATOR <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>CONFIG_NAMESPACE_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_GROUP<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/config&#34;</span><span style="color:#000;font-weight:bold">;</span>

  initializedLatch <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CountDownLatch<span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cacheListener</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CacheListener<span style="color:#000;font-weight:bold">(</span>rootPath<span style="color:#000;font-weight:bold">,</span> initializedLatch<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">executor</span> <span style="color:#000;font-weight:bold">=</span> Executors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newFixedThreadPool</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> NamedThreadFactory<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClass</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getSimpleName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">));</span>

  <span style="color:#998;font-style:italic">// 使用 zookeeperTransporter 连接并得到 zkClient
</span><span style="color:#998;font-style:italic"></span>  zkClient <span style="color:#000;font-weight:bold">=</span> zookeeperTransporter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">connect</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 监听 /dubbo/config 节点的变化
</span><span style="color:#998;font-style:italic"></span>  zkClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addDataListener</span><span style="color:#000;font-weight:bold">(</span>rootPath<span style="color:#000;font-weight:bold">,</span> cacheListener<span style="color:#000;font-weight:bold">,</span> executor<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Wait for connection
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">long</span> timeout <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;init.timeout&#34;</span><span style="color:#000;font-weight:bold">,</span> 5000<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#458;font-weight:bold">boolean</span> isCountDown <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">initializedLatch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">await</span><span style="color:#000;font-weight:bold">(</span>timeout<span style="color:#000;font-weight:bold">,</span> TimeUnit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MILLISECONDS</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>isCountDown<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to receive INITIALIZED event from zookeeper, pls. check if url &#34;</span>
                                      <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; is correct&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to build local cache for config center (zookeeper).&#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AbstractZookeeperTransporter
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> ZookeeperClient <span style="color:#900;font-weight:bold">connect</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  ZookeeperClient zookeeperClient<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 获取到所用的连接 URL
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> addressList <span style="color:#000;font-weight:bold">=</span> getURLBackupAddress<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// The field define the zookeeper server , including protocol, host, port, username, password
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>zookeeperClient <span style="color:#000;font-weight:bold">=</span> fetchAndUpdateZookeeperClientCache<span style="color:#000;font-weight:bold">(</span>addressList<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> zookeeperClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isConnected</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;find valid zookeeper client from the cache for address: &#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> zookeeperClient<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// avoid creating too many connections， so add lock
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span>zookeeperClientMap<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 先从缓存中获取
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>zookeeperClient <span style="color:#000;font-weight:bold">=</span> fetchAndUpdateZookeeperClientCache<span style="color:#000;font-weight:bold">(</span>addressList<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> zookeeperClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isConnected</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;find valid zookeeper client from the cache for address: &#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">return</span> zookeeperClient<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">// 从缓存中获取不到则创建一个
</span><span style="color:#998;font-style:italic"></span>    zookeeperClient <span style="color:#000;font-weight:bold">=</span> createZookeeperClient<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;No valid zookeeper client found from cache, therefore create a new client for url. &#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 把连接放到 zookeeperClientMap 中
</span><span style="color:#998;font-style:italic"></span>    writeToClientMap<span style="color:#000;font-weight:bold">(</span>addressList<span style="color:#000;font-weight:bold">,</span> zookeeperClient<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> zookeeperClient<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// CuratorZookeeperTransporter
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> ZookeeperClient <span style="color:#900;font-weight:bold">createZookeeperClient</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 创建一个 CuratorZookeeperClient
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> CuratorZookeeperClient<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// CuratorZookeeperClient
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">CuratorZookeeperClient</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 从 url 中获取连接需要的信息
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">int</span> timeout <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>TIMEOUT_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_CONNECTION_TIMEOUT_MS<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#458;font-weight:bold">int</span> sessionExpireMs <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>ZK_SESSION_EXPIRE_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_SESSION_TIMEOUT_MS<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 创建设置相关的属性，超时时间，重处理策略
</span><span style="color:#998;font-style:italic"></span>    CuratorFrameworkFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Builder</span> builder <span style="color:#000;font-weight:bold">=</span> CuratorFrameworkFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">builder</span><span style="color:#000;font-weight:bold">()</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">connectString</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBackupAddress</span><span style="color:#000;font-weight:bold">())</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">retryPolicy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> RetryNTimes<span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> 1000<span style="color:#000;font-weight:bold">))</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">connectionTimeoutMs</span><span style="color:#000;font-weight:bold">(</span>timeout<span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">sessionTimeoutMs</span><span style="color:#000;font-weight:bold">(</span>sessionExpireMs<span style="color:#000;font-weight:bold">);</span>
    String authority <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAuthority</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>authority <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> authority<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      builder <span style="color:#000;font-weight:bold">=</span> builder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">authorization</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;digest&#34;</span><span style="color:#000;font-weight:bold">,</span> authority<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBytes</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 使用 builder 模式创建 Client
</span><span style="color:#998;font-style:italic"></span>    client <span style="color:#000;font-weight:bold">=</span> builder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 在 Client 上添加 listener
</span><span style="color:#998;font-style:italic"></span>    client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConnectionStateListenable</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">addListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> CuratorConnectionStateListener<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#998;font-style:italic">// 开始连接
</span><span style="color:#998;font-style:italic"></span>    client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#458;font-weight:bold">boolean</span> connected <span style="color:#000;font-weight:bold">=</span> client<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">blockUntilConnected</span><span style="color:#000;font-weight:bold">(</span>timeout<span style="color:#000;font-weight:bold">,</span> TimeUnit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MILLISECONDS</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>connected<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;zookeeper not connected&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// RegistryProtocol
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> Exporter<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">export</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> originInvoker<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取 注册中心的 url
</span><span style="color:#998;font-style:italic"></span>  URL registryUrl <span style="color:#000;font-weight:bold">=</span> getRegistryUrl<span style="color:#000;font-weight:bold">(</span>originInvoker<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 获取 provider 的 url
</span><span style="color:#998;font-style:italic"></span>  URL providerUrl <span style="color:#000;font-weight:bold">=</span> getProviderUrl<span style="color:#000;font-weight:bold">(</span>originInvoker<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// Subscribe the override data
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// FIXME When the provider subscribes, it will affect the scene : a certain JVM exposes the service and call
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//  the same service. Because the subscribed is cached key with the name of the service, it causes the
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">//  subscription information to cover.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> URL overrideSubscribeUrl <span style="color:#000;font-weight:bold">=</span> getSubscribedOverrideUrl<span style="color:#000;font-weight:bold">(</span>providerUrl<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">final</span> OverrideListener overrideSubscribeListener <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> OverrideListener<span style="color:#000;font-weight:bold">(</span>overrideSubscribeUrl<span style="color:#000;font-weight:bold">,</span> originInvoker<span style="color:#000;font-weight:bold">);</span>
  overrideListeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>overrideSubscribeUrl<span style="color:#000;font-weight:bold">,</span> overrideSubscribeListener<span style="color:#000;font-weight:bold">);</span>
	<span style="color:#998;font-style:italic">// 使用配置覆盖 URL
</span><span style="color:#998;font-style:italic"></span>  providerUrl <span style="color:#000;font-weight:bold">=</span> overrideUrlWithConfig<span style="color:#000;font-weight:bold">(</span>providerUrl<span style="color:#000;font-weight:bold">,</span> overrideSubscribeListener<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 暴露 invoker 
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> ExporterChangeableWrapper<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> exporter <span style="color:#000;font-weight:bold">=</span> doLocalExport<span style="color:#000;font-weight:bold">(</span>originInvoker<span style="color:#000;font-weight:bold">,</span> providerUrl<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 创建 zookeeper Registry
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> Registry registry <span style="color:#000;font-weight:bold">=</span> getRegistry<span style="color:#000;font-weight:bold">(</span>originInvoker<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 获取注册的 Provider 的 URL
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> URL registeredProviderUrl <span style="color:#000;font-weight:bold">=</span> getRegisteredProviderUrl<span style="color:#000;font-weight:bold">(</span>providerUrl<span style="color:#000;font-weight:bold">,</span> registryUrl<span style="color:#000;font-weight:bold">);</span>
  ProviderInvokerWrapper<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> providerInvokerWrapper <span style="color:#000;font-weight:bold">=</span> ProviderConsumerRegTable<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerProvider</span><span style="color:#000;font-weight:bold">(</span>originInvoker<span style="color:#000;font-weight:bold">,</span>
                                                                                               registryUrl<span style="color:#000;font-weight:bold">,</span> registeredProviderUrl<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">//to judge if we need to delay publish
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">boolean</span> register <span style="color:#000;font-weight:bold">=</span> providerUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>REGISTER_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>register<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 注册 provider
</span><span style="color:#998;font-style:italic"></span>    register<span style="color:#000;font-weight:bold">(</span>registryUrl<span style="color:#000;font-weight:bold">,</span> registeredProviderUrl<span style="color:#000;font-weight:bold">);</span>
    providerInvokerWrapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setReg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// Deprecated! Subscribe to override rules in 2.6.x or before.
</span><span style="color:#998;font-style:italic"></span>  registry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">subscribe</span><span style="color:#000;font-weight:bold">(</span>overrideSubscribeUrl<span style="color:#000;font-weight:bold">,</span> overrideSubscribeListener<span style="color:#000;font-weight:bold">);</span>

  exporter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRegisterUrl</span><span style="color:#000;font-weight:bold">(</span>registeredProviderUrl<span style="color:#000;font-weight:bold">);</span>
  exporter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSubscribeUrl</span><span style="color:#000;font-weight:bold">(</span>overrideSubscribeUrl<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">//Ensure that a new exporter instance is returned every time export
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DestroyableExporter<span style="color:#000;font-weight:bold">&lt;&gt;(</span>exporter<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">register</span><span style="color:#000;font-weight:bold">(</span>URL registryUrl<span style="color:#000;font-weight:bold">,</span> URL registeredProviderUrl<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取注册中心
</span><span style="color:#998;font-style:italic"></span>  Registry registry <span style="color:#000;font-weight:bold">=</span> registryFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRegistry</span><span style="color:#000;font-weight:bold">(</span>registryUrl<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 注册 Provider 的 URL
</span><span style="color:#998;font-style:italic"></span>  registry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>registeredProviderUrl<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DubboProtocol
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> Exporter<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">export</span><span style="color:#000;font-weight:bold">(</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> invoker<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  URL url <span style="color:#000;font-weight:bold">=</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#998;font-style:italic">// export service.
</span><span style="color:#998;font-style:italic"></span>  String key <span style="color:#000;font-weight:bold">=</span> serviceKey<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  DubboExporter<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> exporter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DubboExporter<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;(</span>invoker<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> exporterMap<span style="color:#000;font-weight:bold">);</span>
  exporterMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> exporter<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">//export an stub service for dispatching event
</span><span style="color:#998;font-style:italic"></span>  Boolean isStubSupportEvent <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>STUB_EVENT_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_STUB_EVENT<span style="color:#000;font-weight:bold">);</span>
  Boolean isCallbackservice <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>IS_CALLBACK_SERVICE<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isStubSupportEvent <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>isCallbackservice<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    String stubServiceMethods <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>STUB_EVENT_METHODS_KEY<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>stubServiceMethods <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> stubServiceMethods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isWarnEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;consumer [&#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>INTERFACE_KEY<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span>
                                              <span style="color:#d14">&#34;], has set stubproxy support event ,but no stub methods founded.&#34;</span><span style="color:#000;font-weight:bold">));</span>
      <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      stubServiceMethodsMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getServiceKey</span><span style="color:#000;font-weight:bold">(),</span> stubServiceMethods<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  openServer<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  optimizeSerialization<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">return</span> exporter<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">openServer</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// find server.
</span><span style="color:#998;font-style:italic"></span>  String key <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">//client can export a service which&#39;s only for server to invoke
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">boolean</span> isServer <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>IS_SERVER_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isServer<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 获取 Server 
</span><span style="color:#998;font-style:italic"></span>    ExchangeServer server <span style="color:#000;font-weight:bold">=</span> serverMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>server <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        server <span style="color:#000;font-weight:bold">=</span> serverMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>server <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#998;font-style:italic">// 创建 Server
</span><span style="color:#998;font-style:italic"></span>          serverMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> createServer<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// server supports reset, use together with override
</span><span style="color:#998;font-style:italic"></span>      server<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">reset</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> ExchangeServer <span style="color:#900;font-weight:bold">createServer</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// Build URL
</span><span style="color:#998;font-style:italic"></span>  url <span style="color:#000;font-weight:bold">=</span> URLBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">from</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#998;font-style:italic">// send readonly event when server closes, it&#39;s enabled by default
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterIfAbsent</span><span style="color:#000;font-weight:bold">(</span>CHANNEL_READONLYEVENT_SENT_KEY<span style="color:#000;font-weight:bold">,</span> Boolean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">TRUE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">())</span>
    <span style="color:#998;font-style:italic">// enable heartbeat by default
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterIfAbsent</span><span style="color:#000;font-weight:bold">(</span>HEARTBEAT_KEY<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>DEFAULT_HEARTBEAT<span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameter</span><span style="color:#000;font-weight:bold">(</span>CODEC_KEY<span style="color:#000;font-weight:bold">,</span> DubboCodec<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NAME</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
  String str <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>SERVER_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_REMOTING_SERVER<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>str <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> str<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>Transporter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">hasExtension</span><span style="color:#000;font-weight:bold">(</span>str<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Unsupported server type: &#34;</span> <span style="color:#000;font-weight:bold">+</span> str <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, url: &#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  ExchangeServer server<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 绑定 url 和 处理 Handler
</span><span style="color:#998;font-style:italic"></span>    server <span style="color:#000;font-weight:bold">=</span> Exchangers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> requestHandler<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>RemotingException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Fail to start server(url: &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;) &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  str <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>CLIENT_KEY<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>str <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> str<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Set<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> supportedTypes <span style="color:#000;font-weight:bold">=</span> ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>Transporter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getSupportedExtensions</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>supportedTypes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span>str<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Unsupported client type: &#34;</span> <span style="color:#000;font-weight:bold">+</span> str<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">return</span> server<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// Exchangers
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> ExchangeServer <span style="color:#900;font-weight:bold">bind</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> ExchangeHandler handler<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RemotingException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;url == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>handler <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;handler == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  url <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterIfAbsent</span><span style="color:#000;font-weight:bold">(</span>Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CODEC_KEY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;exchange&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 绑定
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> getExchanger<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> handler<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// HeaderExchanger
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> ExchangeServer <span style="color:#900;font-weight:bold">bind</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> ExchangeHandler handler<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RemotingException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 创建一个 HeaderExchangeServer
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> HeaderExchangeServer<span style="color:#000;font-weight:bold">(</span>Transporters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> DecodeHandler<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> HeaderExchangeHandler<span style="color:#000;font-weight:bold">(</span>handler<span style="color:#000;font-weight:bold">))));</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// Transporters
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> Server <span style="color:#900;font-weight:bold">bind</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> ChannelHandler<span style="color:#000;font-weight:bold">...</span> handlers<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RemotingException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;url == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>handlers <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> handlers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;handlers == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  ChannelHandler handler<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>handlers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    handler <span style="color:#000;font-weight:bold">=</span> handlers<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    handler <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ChannelHandlerDispatcher<span style="color:#000;font-weight:bold">(</span>handlers<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 使用 Transporter 绑定 Server
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> getTransporter<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">bind</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> handler<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// NettyTransporter
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Server <span style="color:#900;font-weight:bold">bind</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> ChannelHandler listener<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RemotingException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 底层使用 Netty 创建 Server
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> NettyServer<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ProviderConsumerRegTable
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> ProviderInvokerWrapper<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">registerProvider</span><span style="color:#000;font-weight:bold">(</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> invoker<span style="color:#000;font-weight:bold">,</span> URL registryUrl<span style="color:#000;font-weight:bold">,</span> URL providerUrl<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 包装 invoker
</span><span style="color:#998;font-style:italic"></span>  ProviderInvokerWrapper<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> wrapperInvoker <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ProviderInvokerWrapper<span style="color:#000;font-weight:bold">&lt;&gt;(</span>invoker<span style="color:#000;font-weight:bold">,</span> registryUrl<span style="color:#000;font-weight:bold">,</span> providerUrl<span style="color:#000;font-weight:bold">);</span>
  String serviceUniqueName <span style="color:#000;font-weight:bold">=</span> providerUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getServiceKey</span><span style="color:#000;font-weight:bold">();</span>
  ConcurrentMap<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">,</span> ProviderInvokerWrapper<span style="color:#000;font-weight:bold">&gt;</span> invokers <span style="color:#000;font-weight:bold">=</span> providerInvokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>serviceUniqueName<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invokers <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 放到 providerInvokers 中
</span><span style="color:#998;font-style:italic"></span>    providerInvokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putIfAbsent</span><span style="color:#000;font-weight:bold">(</span>serviceUniqueName<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> ConcurrentHashMap<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
    invokers <span style="color:#000;font-weight:bold">=</span> providerInvokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>serviceUniqueName<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  invokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">,</span> wrapperInvoker<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> wrapperInvoker<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// FailbackRegistry
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">register</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 放到已经注册的列表中
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  removeFailedRegistered<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  removeFailedUnregistered<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Sending a registration request to the server side
</span><span style="color:#998;font-style:italic"></span>    doRegister<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Throwable t <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">// If the startup detection is opened, the Exception is thrown directly.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">boolean</span> check <span style="color:#000;font-weight:bold">=</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHECK_KEY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">&amp;&amp;</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHECK_KEY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>CONSUMER_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#458;font-weight:bold">boolean</span> skipFailback <span style="color:#000;font-weight:bold">=</span> t <span style="color:#000;font-weight:bold">instanceof</span> SkipFailbackWrapperException<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>check <span style="color:#000;font-weight:bold">||</span> skipFailback<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>skipFailback<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        t <span style="color:#000;font-weight:bold">=</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCause</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to register &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; to registry &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to register &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, waiting for retry, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">// Record a failed registration request to a failed list, retry regularly
</span><span style="color:#998;font-style:italic"></span>    addFailedRegistered<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ZookeeperRegistry
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doRegister</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 注册到 zookeeper 中
</span><span style="color:#998;font-style:italic"></span>    zkClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span>toUrlPath<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">),</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>DYNAMIC_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to register &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; to zookeeper &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>此外是在 <code>ServiceAnnotationBeanPostProcessor</code> 中将所有 使用 Dubbo 注解 Service 且在被扫描包里的 Service 使用 <code>ServiceBean</code> 为基类注册到容器中。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">postProcessBeanDefinitionRegistry</span><span style="color:#000;font-weight:bold">(</span>BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> BeansException <span style="color:#000;font-weight:bold">{</span>
  Set<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> resolvedPackagesToScan <span style="color:#000;font-weight:bold">=</span> resolvePackagesToScan<span style="color:#000;font-weight:bold">(</span>packagesToScan<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>resolvedPackagesToScan<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 扫描包
</span><span style="color:#998;font-style:italic"></span>    registerServiceBeans<span style="color:#000;font-weight:bold">(</span>resolvedPackagesToScan<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isWarnEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;packagesToScan is empty , ServiceBean registry will be ignored!&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerServiceBeans</span><span style="color:#000;font-weight:bold">(</span>Set<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> packagesToScan<span style="color:#000;font-weight:bold">,</span> BeanDefinitionRegistry registry<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  DubboClassPathBeanDefinitionScanner scanner <span style="color:#000;font-weight:bold">=</span>
    <span style="color:#000;font-weight:bold">new</span> DubboClassPathBeanDefinitionScanner<span style="color:#000;font-weight:bold">(</span>registry<span style="color:#000;font-weight:bold">,</span> environment<span style="color:#000;font-weight:bold">,</span> resourceLoader<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 获取 Bean Name Generator
</span><span style="color:#998;font-style:italic"></span>  BeanNameGenerator beanNameGenerator <span style="color:#000;font-weight:bold">=</span> resolveBeanNameGenerator<span style="color:#000;font-weight:bold">(</span>registry<span style="color:#000;font-weight:bold">);</span>
  scanner<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setBeanNameGenerator</span><span style="color:#000;font-weight:bold">(</span>beanNameGenerator<span style="color:#000;font-weight:bold">);</span>
  scanner<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addIncludeFilter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> AnnotationTypeFilter<span style="color:#000;font-weight:bold">(</span>Service<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">));</span>
  scanner<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addIncludeFilter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> AnnotationTypeFilter<span style="color:#000;font-weight:bold">(</span>com<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">alibaba</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">dubbo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">annotation</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String packageToScan <span style="color:#000;font-weight:bold">:</span> packagesToScan<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Registers @Service Bean first
</span><span style="color:#998;font-style:italic"></span>    scanner<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">scan</span><span style="color:#000;font-weight:bold">(</span>packageToScan<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// Finds all BeanDefinitionHolders of @Service whether @ComponentScan scans or not.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 找到 Bean 定义的 Holder
</span><span style="color:#998;font-style:italic"></span>    Set<span style="color:#000;font-weight:bold">&lt;</span>BeanDefinitionHolder<span style="color:#000;font-weight:bold">&gt;</span> beanDefinitionHolders <span style="color:#000;font-weight:bold">=</span>
      findServiceBeanDefinitionHolders<span style="color:#000;font-weight:bold">(</span>scanner<span style="color:#000;font-weight:bold">,</span> packageToScan<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">,</span> beanNameGenerator<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>beanDefinitionHolders<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>BeanDefinitionHolder beanDefinitionHolder <span style="color:#000;font-weight:bold">:</span> beanDefinitionHolders<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 注册到容器中
</span><span style="color:#998;font-style:italic"></span>        registerServiceBean<span style="color:#000;font-weight:bold">(</span>beanDefinitionHolder<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">,</span> scanner<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span>beanDefinitionHolders<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; annotated Dubbo&#39;s @Service Components { &#34;</span> <span style="color:#000;font-weight:bold">+</span>
                    beanDefinitionHolders <span style="color:#000;font-weight:bold">+</span>
                    <span style="color:#d14">&#34; } were scanned under package[&#34;</span> <span style="color:#000;font-weight:bold">+</span> packageToScan <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;]&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isWarnEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;No Spring Bean annotating Dubbo&#39;s @Service was found under package[&#34;</span>
                    <span style="color:#000;font-weight:bold">+</span> packageToScan <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;]&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="服务引用">服务引用</h3>
<p>参考：<a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/refer-service.html">服务引用</a></p>
<p>对于 Reference 则封装成 <code>ReferenceBean</code> Bean。</p>
<p>在创建 Service 类的时候如果有使用 Reference 注解注释的时候 AutoWired 组件，会使用 <code>AnnotationInjectedBeanPostProcessor</code> 去创建或者获取需要的组件。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AnnotationInjectedBeanPostProcessor
</span><span style="color:#998;font-style:italic">// 为 Bean inject 属性，Bean 是 Target 的 Bean，Bean Name 是属性名称，pvs 是属性值
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">inject</span><span style="color:#000;font-weight:bold">(</span>Object bean<span style="color:#000;font-weight:bold">,</span> String beanName<span style="color:#000;font-weight:bold">,</span> PropertyValues pvs<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable <span style="color:#000;font-weight:bold">{</span>
  Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> injectedType <span style="color:#000;font-weight:bold">=</span> field<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 获取 injected Object
</span><span style="color:#998;font-style:italic"></span>  Object injectedObject <span style="color:#000;font-weight:bold">=</span> getInjectedObject<span style="color:#000;font-weight:bold">(</span>attributes<span style="color:#000;font-weight:bold">,</span> bean<span style="color:#000;font-weight:bold">,</span> beanName<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
  ReflectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">makeAccessible</span><span style="color:#000;font-weight:bold">(</span>field<span style="color:#000;font-weight:bold">);</span>
  field<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">set</span><span style="color:#000;font-weight:bold">(</span>bean<span style="color:#000;font-weight:bold">,</span> injectedObject<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">protected</span> Object <span style="color:#900;font-weight:bold">getInjectedObject</span><span style="color:#000;font-weight:bold">(</span>AnnotationAttributes attributes<span style="color:#000;font-weight:bold">,</span> Object bean<span style="color:#000;font-weight:bold">,</span> String beanName<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> injectedType<span style="color:#000;font-weight:bold">,</span>
                                       InjectionMetadata<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">InjectedElement</span> injectedElement<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取 Cache Key
</span><span style="color:#998;font-style:italic"></span>  String cacheKey <span style="color:#000;font-weight:bold">=</span> buildInjectedObjectCacheKey<span style="color:#000;font-weight:bold">(</span>attributes<span style="color:#000;font-weight:bold">,</span> bean<span style="color:#000;font-weight:bold">,</span> beanName<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">,</span> injectedElement<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 尝试从 Cache 中获取
</span><span style="color:#998;font-style:italic"></span>  Object injectedObject <span style="color:#000;font-weight:bold">=</span> injectedObjectsCache<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>cacheKey<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>injectedObject <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 执行获取 Inject Bean 
</span><span style="color:#998;font-style:italic"></span>    injectedObject <span style="color:#000;font-weight:bold">=</span> doGetInjectedBean<span style="color:#000;font-weight:bold">(</span>attributes<span style="color:#000;font-weight:bold">,</span> bean<span style="color:#000;font-weight:bold">,</span> beanName<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">,</span> injectedElement<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// Customized inject-object if necessary
</span><span style="color:#998;font-style:italic"></span>    injectedObjectsCache<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putIfAbsent</span><span style="color:#000;font-weight:bold">(</span>cacheKey<span style="color:#000;font-weight:bold">,</span> injectedObject<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> injectedObject<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ReferenceAnnotationBeanPostProcessor
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> Object <span style="color:#900;font-weight:bold">doGetInjectedBean</span><span style="color:#000;font-weight:bold">(</span>AnnotationAttributes attributes<span style="color:#000;font-weight:bold">,</span> Object bean<span style="color:#000;font-weight:bold">,</span> String beanName<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> injectedType<span style="color:#000;font-weight:bold">,</span>
                                       InjectionMetadata<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">InjectedElement</span> injectedElement<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// The name of bean that annotated Dubbo&#39;s {@link Service @Service} in local Spring {@link ApplicationContext}
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// Referenced Bean 的名称：ServiceBean:com.xinyue.dubbo.api.service.ArticleService
</span><span style="color:#998;font-style:italic"></span>  String referencedBeanName <span style="color:#000;font-weight:bold">=</span> buildReferencedBeanName<span style="color:#000;font-weight:bold">(</span>attributes<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// The name of bean that is declared by {@link Reference @Reference} annotation injection
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// Reference Bean 名称：@Reference com.xinyue.dubbo.api.service.ArticleService
</span><span style="color:#998;font-style:italic"></span>  String referenceBeanName <span style="color:#000;font-weight:bold">=</span> getReferenceBeanName<span style="color:#000;font-weight:bold">(</span>attributes<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// Build Reference Bean
</span><span style="color:#998;font-style:italic"></span>  ReferenceBean referenceBean <span style="color:#000;font-weight:bold">=</span> buildReferenceBeanIfAbsent<span style="color:#000;font-weight:bold">(</span>referenceBeanName<span style="color:#000;font-weight:bold">,</span> attributes<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// Register an instance of ReferenceBean as a Spring Bean
</span><span style="color:#998;font-style:italic"></span>  registerReferenceBean<span style="color:#000;font-weight:bold">(</span>referencedBeanName<span style="color:#000;font-weight:bold">,</span> referenceBean<span style="color:#000;font-weight:bold">,</span> attributes<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 放到缓存中
</span><span style="color:#998;font-style:italic"></span>  cacheInjectedReferenceBean<span style="color:#000;font-weight:bold">(</span>referenceBean<span style="color:#000;font-weight:bold">,</span> injectedElement<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// Get or Create a proxy of ReferenceBean for the specified the type of Dubbo service interface
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> getOrCreateProxy<span style="color:#000;font-weight:bold">(</span>referencedBeanName<span style="color:#000;font-weight:bold">,</span> referenceBeanName<span style="color:#000;font-weight:bold">,</span> referenceBean<span style="color:#000;font-weight:bold">,</span> injectedType<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">registerReferenceBean</span><span style="color:#000;font-weight:bold">(</span>String referencedBeanName<span style="color:#000;font-weight:bold">,</span> ReferenceBean referenceBean<span style="color:#000;font-weight:bold">,</span>
                                   AnnotationAttributes attributes<span style="color:#000;font-weight:bold">,</span>
                                   Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> interfaceClass<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取 Bean Factory
</span><span style="color:#998;font-style:italic"></span>  ConfigurableListableBeanFactory beanFactory <span style="color:#000;font-weight:bold">=</span> getBeanFactory<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 获取 Bean 名称
</span><span style="color:#998;font-style:italic"></span>  String beanName <span style="color:#000;font-weight:bold">=</span> getReferenceBeanName<span style="color:#000;font-weight:bold">(</span>attributes<span style="color:#000;font-weight:bold">,</span> interfaceClass<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>existsServiceBean<span style="color:#000;font-weight:bold">(</span>referencedBeanName<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#998;font-style:italic">// If @Service bean is local one
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// Get  the @Service&#39;s BeanDefinition from {@link BeanFactory}
</span><span style="color:#998;font-style:italic"></span>    AbstractBeanDefinition beanDefinition <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>AbstractBeanDefinition<span style="color:#000;font-weight:bold">)</span> beanFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBeanDefinition</span><span style="color:#000;font-weight:bold">(</span>referencedBeanName<span style="color:#000;font-weight:bold">);</span>
    RuntimeBeanReference runtimeBeanReference <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>RuntimeBeanReference<span style="color:#000;font-weight:bold">)</span> beanDefinition<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPropertyValues</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ref&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// The name of bean annotated @Service
</span><span style="color:#998;font-style:italic"></span>    String serviceBeanName <span style="color:#000;font-weight:bold">=</span> runtimeBeanReference<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBeanName</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// register Alias rather than a new bean name, in order to reduce duplicated beans
</span><span style="color:#998;font-style:italic"></span>    beanFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerAlias</span><span style="color:#000;font-weight:bold">(</span>serviceBeanName<span style="color:#000;font-weight:bold">,</span> beanName<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#998;font-style:italic">// Remote @Service Bean
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>beanFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">containsBean</span><span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 注册到 Bean 工厂中
</span><span style="color:#998;font-style:italic"></span>      beanFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerSingleton</span><span style="color:#000;font-weight:bold">(</span>beanName<span style="color:#000;font-weight:bold">,</span> referenceBean<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> Object <span style="color:#900;font-weight:bold">getOrCreateProxy</span><span style="color:#000;font-weight:bold">(</span>String referencedBeanName<span style="color:#000;font-weight:bold">,</span> String referenceBeanName<span style="color:#000;font-weight:bold">,</span> ReferenceBean referenceBean<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> serviceInterfaceType<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>existsServiceBean<span style="color:#000;font-weight:bold">(</span>referencedBeanName<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#998;font-style:italic">// If the local @Service Bean exists, build a proxy of ReferenceBean
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> newProxyInstance<span style="color:#000;font-weight:bold">(</span>getClassLoader<span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">new</span> Class<span style="color:#000;font-weight:bold">[]{</span>serviceInterfaceType<span style="color:#000;font-weight:bold">},</span>
                            wrapInvocationHandler<span style="color:#000;font-weight:bold">(</span>referenceBeanName<span style="color:#000;font-weight:bold">,</span> referenceBean<span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>    
    <span style="color:#998;font-style:italic">// ReferenceBean should be initialized and get immediately
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> referenceBean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ReferenceConfig
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">synchronized</span> T <span style="color:#900;font-weight:bold">get</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// Check each config modules are created properly and override their properties if necessary.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// 和 ServiceConfig 中的类似
</span><span style="color:#998;font-style:italic"></span>  checkAndUpdateSubConfigs<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>destroyed<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The invoker of ReferenceConfig(&#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;) has already destroyed!&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ref <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    init<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> ref<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">checkAndUpdateSubConfigs</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>interfaceName<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;&lt;dubbo:reference interface=\&#34;\&#34; /&gt; interface not allow null!&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// Complete Config
</span><span style="color:#998;font-style:italic"></span>  completeCompoundConfigs<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 启动 config center, 刷新 Config
</span><span style="color:#998;font-style:italic"></span>  startConfigCenter<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// get consumer&#39;s global configuration
</span><span style="color:#998;font-style:italic"></span>  checkDefault<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 刷新 Reference Config
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refresh</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>getGeneric<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> getConsumer<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    setGeneric<span style="color:#000;font-weight:bold">(</span>getConsumer<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getGeneric</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 一些校验
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ProtocolUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isGeneric</span><span style="color:#000;font-weight:bold">(</span>getGeneric<span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
    interfaceClass <span style="color:#000;font-weight:bold">=</span> GenericService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      interfaceClass <span style="color:#000;font-weight:bold">=</span> Class<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forName</span><span style="color:#000;font-weight:bold">(</span>interfaceName<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> Thread<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentThread</span><span style="color:#000;font-weight:bold">()</span>
                                     <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContextClassLoader</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>ClassNotFoundException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    checkInterfaceAndMethods<span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">,</span> methods<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  resolveFile<span style="color:#000;font-weight:bold">();</span>
  checkApplication<span style="color:#000;font-weight:bold">();</span>
  checkMetadataReport<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>initialized<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// Legitimacy check of stub, note that: the local will deprecated, and replace with stub
</span><span style="color:#998;font-style:italic"></span>  checkStubAndLocal<span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// Check Mock
</span><span style="color:#998;font-style:italic"></span>  checkMock<span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// Build 参数
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
  map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>SIDE_KEY<span style="color:#000;font-weight:bold">,</span> CONSUMER_SIDE<span style="color:#000;font-weight:bold">);</span>
  appendRuntimeParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>ProtocolUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isGeneric</span><span style="color:#000;font-weight:bold">(</span>getGeneric<span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
    String revision <span style="color:#000;font-weight:bold">=</span> Version<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVersion</span><span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">,</span> version<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>revision <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> revision<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>REVISION_KEY<span style="color:#000;font-weight:bold">,</span> revision<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    String<span style="color:#000;font-weight:bold">[]</span> methods <span style="color:#000;font-weight:bold">=</span> Wrapper<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getWrapper</span><span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getMethodNames</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>methods<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;No method found in service interface &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>METHODS_KEY<span style="color:#000;font-weight:bold">,</span> ANY_VALUE<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>METHODS_KEY<span style="color:#000;font-weight:bold">,</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> HashSet<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;(</span>Arrays<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">asList</span><span style="color:#000;font-weight:bold">(</span>methods<span style="color:#000;font-weight:bold">)),</span> COMMA_SEPARATOR<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>INTERFACE_KEY<span style="color:#000;font-weight:bold">,</span> interfaceName<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> metrics<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> application<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> module<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// remove &#39;default.&#39; prefix for configs from ConsumerConfig
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// appendParameters(map, consumer, Constants.DEFAULT_KEY);
</span><span style="color:#998;font-style:italic"></span>  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> consumer<span style="color:#000;font-weight:bold">);</span>
  appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;</span> attributes <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>methods<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    attributes <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">&gt;();</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>MethodConfig methodConfig <span style="color:#000;font-weight:bold">:</span> methods<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> methodConfig<span style="color:#000;font-weight:bold">,</span> methodConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
      String retryKey <span style="color:#000;font-weight:bold">=</span> methodConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.retry&#34;</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">containsKey</span><span style="color:#000;font-weight:bold">(</span>retryKey<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        String retryValue <span style="color:#000;font-weight:bold">=</span> map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>retryKey<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;false&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>retryValue<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>methodConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.retries&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;0&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
      attributes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>methodConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">(),</span> convertMethodConfig2AsyncInfo<span style="color:#000;font-weight:bold">(</span>methodConfig<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  String hostToRegistry <span style="color:#000;font-weight:bold">=</span> ConfigUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSystemProperty</span><span style="color:#000;font-weight:bold">(</span>DUBBO_IP_TO_REGISTRY<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>hostToRegistry<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    hostToRegistry <span style="color:#000;font-weight:bold">=</span> NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isInvalidLocalHost<span style="color:#000;font-weight:bold">(</span>hostToRegistry<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Specified invalid registry ip from property:&#34;</span> <span style="color:#000;font-weight:bold">+</span> DUBBO_IP_TO_REGISTRY <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, value:&#34;</span> <span style="color:#000;font-weight:bold">+</span> hostToRegistry<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>REGISTER_IP_KEY<span style="color:#000;font-weight:bold">,</span> hostToRegistry<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 创建代理
</span><span style="color:#998;font-style:italic"></span>  ref <span style="color:#000;font-weight:bold">=</span> createProxy<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 生成 key 并 init Customer Model
</span><span style="color:#998;font-style:italic"></span>  String serviceKey <span style="color:#000;font-weight:bold">=</span> URL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">buildKey</span><span style="color:#000;font-weight:bold">(</span>interfaceName<span style="color:#000;font-weight:bold">,</span> group<span style="color:#000;font-weight:bold">,</span> version<span style="color:#000;font-weight:bold">);</span>
  ApplicationModel<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">initConsumerModel</span><span style="color:#000;font-weight:bold">(</span>serviceKey<span style="color:#000;font-weight:bold">,</span> buildConsumerModel<span style="color:#000;font-weight:bold">(</span>serviceKey<span style="color:#000;font-weight:bold">,</span> attributes<span style="color:#000;font-weight:bold">));</span>
  initialized <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> T <span style="color:#900;font-weight:bold">createProxy</span><span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> map<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>shouldJvmRefer<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Ref JVM
</span><span style="color:#998;font-style:italic"></span>    URL url <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> URL<span style="color:#000;font-weight:bold">(</span>LOCAL_PROTOCOL<span style="color:#000;font-weight:bold">,</span> LOCALHOST_VALUE<span style="color:#000;font-weight:bold">,</span> 0<span style="color:#000;font-weight:bold">,</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">addParameters</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
    invoker <span style="color:#000;font-weight:bold">=</span> REF_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refer</span><span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Using injvm service &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">clear</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#998;font-style:italic">// reference retry init will add url to urls, lead to OOM
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// user specified URL, could be peer-to-peer address, or register center&#39;s address.
</span><span style="color:#998;font-style:italic"></span>      String<span style="color:#000;font-weight:bold">[]</span> us <span style="color:#000;font-weight:bold">=</span> SEMICOLON_SPLIT_PATTERN<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>us <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> us<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String u <span style="color:#000;font-weight:bold">:</span> us<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          URL url <span style="color:#000;font-weight:bold">=</span> URL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>u<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getPath</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
            url <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPath</span><span style="color:#000;font-weight:bold">(</span>interfaceName<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>REGISTRY_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
            urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterAndEncoded</span><span style="color:#000;font-weight:bold">(</span>REFER_KEY<span style="color:#000;font-weight:bold">,</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toQueryString</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">)));</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>ClusterUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">mergeUrl</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> map<span style="color:#000;font-weight:bold">));</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// assemble URL from register center&#39;s configuration
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// if protocols not injvm checkRegistry
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>LOCAL_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span>getProtocol<span style="color:#000;font-weight:bold">())){</span>
        <span style="color:#998;font-style:italic">// 和 Service Config 类似也是找到注册中心配置，转换校验，然后连接获取 动态的配置
</span><span style="color:#998;font-style:italic"></span>        checkRegistry<span style="color:#000;font-weight:bold">();</span>
        <span style="color:#998;font-style:italic">// 获取到所有注册中心 URL
</span><span style="color:#998;font-style:italic"></span>        List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> us <span style="color:#000;font-weight:bold">=</span> loadRegistries<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>us<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>URL u <span style="color:#000;font-weight:bold">:</span> us<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            URL monitorUrl <span style="color:#000;font-weight:bold">=</span> loadMonitor<span style="color:#000;font-weight:bold">(</span>u<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>monitorUrl <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
              map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>MONITOR_KEY<span style="color:#000;font-weight:bold">,</span> URL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">encode</span><span style="color:#000;font-weight:bold">(</span>monitorUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toFullString</span><span style="color:#000;font-weight:bold">()));</span>
            <span style="color:#000;font-weight:bold">}</span>
            urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>u<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterAndEncoded</span><span style="color:#000;font-weight:bold">(</span>REFER_KEY<span style="color:#000;font-weight:bold">,</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toQueryString</span><span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">)));</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;No such any registry to reference &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceName <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; on the consumer &#34;</span> <span style="color:#000;font-weight:bold">+</span> NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; use dubbo version &#34;</span> <span style="color:#000;font-weight:bold">+</span> Version<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVersion</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, please config &lt;dubbo:registry address=\&#34;...\&#34; /&gt; to your spring config.&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 如果只有一个注册中心的 URL 则直接获取即可 invoker
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// 会调用到 RegistryProtocol 的 refer
</span><span style="color:#998;font-style:italic"></span>      invoker <span style="color:#000;font-weight:bold">=</span> REF_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refer</span><span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">,</span> urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 如果有多个则遍历获取
</span><span style="color:#998;font-style:italic"></span>      List<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;?&gt;&gt;</span> invokers <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;?&gt;&gt;();</span>
      URL registryURL <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>URL url <span style="color:#000;font-weight:bold">:</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        invokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>REF_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refer</span><span style="color:#000;font-weight:bold">(</span>interfaceClass<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>REGISTRY_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
          registryURL <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// use last registry url
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#998;font-style:italic">// 获取一个 invoker 集合
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>registryURL <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// registry url is available
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// use RegistryAwareCluster only when register&#39;s CLUSTER is available
</span><span style="color:#998;font-style:italic"></span>        URL u <span style="color:#000;font-weight:bold">=</span> registryURL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameter</span><span style="color:#000;font-weight:bold">(</span>CLUSTER_KEY<span style="color:#000;font-weight:bold">,</span> RegistryAwareCluster<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NAME</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">// The invoker wrap relation would be: RegistryAwareClusterInvoker(StaticDirectory) -&gt; FailoverClusterInvoker(RegistryDirectory, will execute route) -&gt; Invoker
</span><span style="color:#998;font-style:italic"></span>        invoker <span style="color:#000;font-weight:bold">=</span> CLUSTER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> StaticDirectory<span style="color:#000;font-weight:bold">(</span>u<span style="color:#000;font-weight:bold">,</span> invokers<span style="color:#000;font-weight:bold">));</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// not a registry url, must be direct invoke.
</span><span style="color:#998;font-style:italic"></span>        invoker <span style="color:#000;font-weight:bold">=</span> CLUSTER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> StaticDirectory<span style="color:#000;font-weight:bold">(</span>invokers<span style="color:#000;font-weight:bold">));</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>shouldCheck<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isAvailable</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to check the status of the service &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceName <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;. No provider available for the service &#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span>group <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#d14">&#34;&#34;</span> <span style="color:#000;font-weight:bold">:</span> group <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> interfaceName <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span>version <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#d14">&#34;&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#34;:&#34;</span> <span style="color:#000;font-weight:bold">+</span> version<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; from the url &#34;</span> <span style="color:#000;font-weight:bold">+</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; to the consumer &#34;</span> <span style="color:#000;font-weight:bold">+</span> NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; use dubbo version &#34;</span> <span style="color:#000;font-weight:bold">+</span> Version<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVersion</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Refer dubbo service &#34;</span> <span style="color:#000;font-weight:bold">+</span> interfaceClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; from url &#34;</span> <span style="color:#000;font-weight:bold">+</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
  
  <span style="color:#998;font-style:italic">// 元信息发布
</span><span style="color:#998;font-style:italic"></span>  MetadataReportService metadataReportService <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>metadataReportService <span style="color:#000;font-weight:bold">=</span> getMetadataReportService<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    URL consumerURL <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> URL<span style="color:#000;font-weight:bold">(</span>CONSUMER_PROTOCOL<span style="color:#000;font-weight:bold">,</span> map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>REGISTER_IP_KEY<span style="color:#000;font-weight:bold">),</span> 0<span style="color:#000;font-weight:bold">,</span> map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>INTERFACE_KEY<span style="color:#000;font-weight:bold">),</span> map<span style="color:#000;font-weight:bold">);</span>
    metadataReportService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">publishConsumer</span><span style="color:#000;font-weight:bold">(</span>consumerURL<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// create service proxy
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span>T<span style="color:#000;font-weight:bold">)</span> PROXY_FACTORY<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProxy</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">protected</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">loadRegistries</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">boolean</span> provider<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// check &amp;&amp; override if necessary
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> registryList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;();</span>
  <span style="color:#998;font-style:italic">// 遍历注册中心
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>registries<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>RegistryConfig config <span style="color:#000;font-weight:bold">:</span> registries<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      String address <span style="color:#000;font-weight:bold">=</span> config<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>address<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        address <span style="color:#000;font-weight:bold">=</span> ANYHOST_VALUE<span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>RegistryConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NO_AVAILABLE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equalsIgnoreCase</span><span style="color:#000;font-weight:bold">(</span>address<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;();</span>
        appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> application<span style="color:#000;font-weight:bold">);</span>
        appendParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">,</span> config<span style="color:#000;font-weight:bold">);</span>
        map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>PATH_KEY<span style="color:#000;font-weight:bold">,</span> RegistryService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
        appendRuntimeParameters<span style="color:#000;font-weight:bold">(</span>map<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">containsKey</span><span style="color:#000;font-weight:bold">(</span>PROTOCOL_KEY<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>PROTOCOL_KEY<span style="color:#000;font-weight:bold">,</span> DUBBO_PROTOCOL<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls <span style="color:#000;font-weight:bold">=</span> UrlUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseURLs</span><span style="color:#000;font-weight:bold">(</span>address<span style="color:#000;font-weight:bold">,</span> map<span style="color:#000;font-weight:bold">);</span>

        <span style="color:#998;font-style:italic">// 找到所有的注册中心 URL 并返回
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>URL url <span style="color:#000;font-weight:bold">:</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          url <span style="color:#000;font-weight:bold">=</span> URLBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">from</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameter</span><span style="color:#000;font-weight:bold">(</span>REGISTRY_KEY<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">())</span>
            <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setProtocol</span><span style="color:#000;font-weight:bold">(</span>REGISTRY_PROTOCOL<span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>provider <span style="color:#000;font-weight:bold">&amp;&amp;</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>REGISTER_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span>
              <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(!</span>provider <span style="color:#000;font-weight:bold">&amp;&amp;</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>SUBSCRIBE_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
            registryList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> registryList<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// RegistryProtocol
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">refer</span><span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> type<span style="color:#000;font-weight:bold">,</span> URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 生成 URL
</span><span style="color:#998;font-style:italic"></span>  url <span style="color:#000;font-weight:bold">=</span> URLBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">from</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setProtocol</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>REGISTRY_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_REGISTRY<span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">removeParameter</span><span style="color:#000;font-weight:bold">(</span>REGISTRY_KEY<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 根据 URL 获取注册中心
</span><span style="color:#998;font-style:italic"></span>  Registry registry <span style="color:#000;font-weight:bold">=</span> registryFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRegistry</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>RegistryService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 如果是注册中心 Service 则通过 ProxyFactory 创建 invoker
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> proxyFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInvoker</span><span style="color:#000;font-weight:bold">((</span>T<span style="color:#000;font-weight:bold">)</span> registry<span style="color:#000;font-weight:bold">,</span> type<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// group=&#34;a,b&#34; or group=&#34;*&#34;
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> qs <span style="color:#000;font-weight:bold">=</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseQueryString</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterAndDecoded</span><span style="color:#000;font-weight:bold">(</span>REFER_KEY<span style="color:#000;font-weight:bold">));</span>
  String group <span style="color:#000;font-weight:bold">=</span> qs<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>GROUP_KEY<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>group <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> group<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>COMMA_SPLIT_PATTERN<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span>group<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">&gt;</span> 1 <span style="color:#000;font-weight:bold">||</span> <span style="color:#d14">&#34;*&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>group<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">return</span> doRefer<span style="color:#000;font-weight:bold">(</span>getMergeableCluster<span style="color:#000;font-weight:bold">(),</span> registry<span style="color:#000;font-weight:bold">,</span> type<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 执行获取
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> doRefer<span style="color:#000;font-weight:bold">(</span>cluster<span style="color:#000;font-weight:bold">,</span> registry<span style="color:#000;font-weight:bold">,</span> type<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">doRefer</span><span style="color:#000;font-weight:bold">(</span>Cluster cluster<span style="color:#000;font-weight:bold">,</span> Registry registry<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> type<span style="color:#000;font-weight:bold">,</span> URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 新建一个注册发现根据需要 provider 的 type 和 当前的 url
</span><span style="color:#998;font-style:italic"></span>  RegistryDirectory<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> directory <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> RegistryDirectory<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;(</span>type<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 设置注册中心和协议
</span><span style="color:#998;font-style:italic"></span>  directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRegistry</span><span style="color:#000;font-weight:bold">(</span>registry<span style="color:#000;font-weight:bold">);</span>
  directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setProtocol</span><span style="color:#000;font-weight:bold">(</span>protocol<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// all attributes of REFER_KEY
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> parameters <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;(</span>directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getParameters</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#998;font-style:italic">// 生成订阅者的 URL
</span><span style="color:#998;font-style:italic"></span>  URL subscribeUrl <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> URL<span style="color:#000;font-weight:bold">(</span>CONSUMER_PROTOCOL<span style="color:#000;font-weight:bold">,</span> parameters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">remove</span><span style="color:#000;font-weight:bold">(</span>REGISTER_IP_KEY<span style="color:#000;font-weight:bold">),</span> 0<span style="color:#000;font-weight:bold">,</span> type<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">(),</span> parameters<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>ANY_VALUE<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getServiceInterface</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>REGISTER_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRegisteredConsumerUrl</span><span style="color:#000;font-weight:bold">(</span>getRegisteredConsumerUrl<span style="color:#000;font-weight:bold">(</span>subscribeUrl<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#998;font-style:italic">// 注册 Customer
</span><span style="color:#998;font-style:italic"></span>    registry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getRegisteredConsumerUrl</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
  directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">buildRouterChain</span><span style="color:#000;font-weight:bold">(</span>subscribeUrl<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 开始订阅
</span><span style="color:#998;font-style:italic"></span>  directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">subscribe</span><span style="color:#000;font-weight:bold">(</span>subscribeUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameter</span><span style="color:#000;font-weight:bold">(</span>CATEGORY_KEY<span style="color:#000;font-weight:bold">,</span>
                                                PROVIDERS_CATEGORY <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span> CONFIGURATORS_CATEGORY <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span> ROUTERS_CATEGORY<span style="color:#000;font-weight:bold">));</span>

  <span style="color:#998;font-style:italic">// 订阅后就拿到了 invoker
</span><span style="color:#998;font-style:italic"></span>  Invoker invoker <span style="color:#000;font-weight:bold">=</span> cluster<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">join</span><span style="color:#000;font-weight:bold">(</span>directory<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 注册到 ProviderConsumerRegTable 中
</span><span style="color:#998;font-style:italic"></span>  ProviderConsumerRegTable<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerConsumer</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">,</span> subscribeUrl<span style="color:#000;font-weight:bold">,</span> directory<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// RegistryDirectory
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">subscribe</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 设置 Consumer 的 URL
</span><span style="color:#998;font-style:italic"></span>  setConsumerUrl<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  CONSUMER_CONFIGURATION_LISTENER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addNotifyListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
  serviceConfigurationListener <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ReferenceConfigurationListener<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">);</span>
  registry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">subscribe</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">synchronized</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">notify</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取到的 provider 的url
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;&gt;</span> categoryUrls <span style="color:#000;font-weight:bold">=</span> urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stream</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span>Objects<span style="color:#000;font-weight:bold">::</span>nonNull<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">::</span>isValidCategory<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">::</span>isNotCompatibleFor26x<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">collect</span><span style="color:#000;font-weight:bold">(</span>Collectors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">groupingBy</span><span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>UrlUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isConfigurator</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> CONFIGURATORS_CATEGORY<span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>UrlUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isRoute</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> ROUTERS_CATEGORY<span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>UrlUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isProvider</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> PROVIDERS_CATEGORY<span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}));</span>

  List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> configuratorURLs <span style="color:#000;font-weight:bold">=</span> categoryUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrDefault</span><span style="color:#000;font-weight:bold">(</span>CONFIGURATORS_CATEGORY<span style="color:#000;font-weight:bold">,</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">emptyList</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configurators</span> <span style="color:#000;font-weight:bold">=</span> Configurator<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toConfigurators</span><span style="color:#000;font-weight:bold">(</span>configuratorURLs<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">orElse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">configurators</span><span style="color:#000;font-weight:bold">);</span>

  List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> routerURLs <span style="color:#000;font-weight:bold">=</span> categoryUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrDefault</span><span style="color:#000;font-weight:bold">(</span>ROUTERS_CATEGORY<span style="color:#000;font-weight:bold">,</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">emptyList</span><span style="color:#000;font-weight:bold">());</span>
  toRouters<span style="color:#000;font-weight:bold">(</span>routerURLs<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">ifPresent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">::</span>addRouters<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// providers
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> providerURLs <span style="color:#000;font-weight:bold">=</span> categoryUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getOrDefault</span><span style="color:#000;font-weight:bold">(</span>PROVIDERS_CATEGORY<span style="color:#000;font-weight:bold">,</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">emptyList</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#998;font-style:italic">// 刷新和覆盖 invoker
</span><span style="color:#998;font-style:italic"></span>  refreshOverrideAndInvoker<span style="color:#000;font-weight:bold">(</span>providerURLs<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">refreshOverrideAndInvoker</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// mock zookeeper://xxx?mock=return null
</span><span style="color:#998;font-style:italic"></span>  overrideDirectoryUrl<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 根据 URL 刷卡 invoker
</span><span style="color:#998;font-style:italic"></span>  refreshInvoker<span style="color:#000;font-weight:bold">(</span>urls<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">refreshInvoker</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> invokerUrls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  Assert<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">notNull</span><span style="color:#000;font-weight:bold">(</span>invokerUrls<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;invokerUrls should not be null&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invokerUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> 1
      <span style="color:#000;font-weight:bold">&amp;&amp;</span> invokerUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span>
      <span style="color:#000;font-weight:bold">&amp;&amp;</span> EMPTY_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>invokerUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forbidden</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// Forbid to access
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokers</span> <span style="color:#000;font-weight:bold">=</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">emptyList</span><span style="color:#000;font-weight:bold">();</span>
    routerChain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setInvokers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokers</span><span style="color:#000;font-weight:bold">);</span>
    destroyAllInvokers<span style="color:#000;font-weight:bold">();</span> <span style="color:#998;font-style:italic">// Close all invokers
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forbidden</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// Allow to access
</span><span style="color:#998;font-style:italic"></span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> oldUrlInvokerMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">urlInvokerMap</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// local reference
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invokerUrls <span style="color:#000;font-weight:bold">==</span> Collections<span style="color:#000;font-weight:bold">.&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span>emptyList<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      invokerUrls <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invokerUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cachedInvokerUrls</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      invokerUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cachedInvokerUrls</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cachedInvokerUrls</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashSet<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
      <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">cachedInvokerUrls</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAll</span><span style="color:#000;font-weight:bold">(</span>invokerUrls<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">//Cached invoker urls, convenient for comparison
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invokerUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 根据 URL 获取 Invoker
</span><span style="color:#998;font-style:italic"></span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> newUrlInvokerMap <span style="color:#000;font-weight:bold">=</span> toInvokers<span style="color:#000;font-weight:bold">(</span>invokerUrls<span style="color:#000;font-weight:bold">);</span><span style="color:#998;font-style:italic">// Translate url list to Invoker map
</span><span style="color:#998;font-style:italic"></span>
    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * If the calculation is wrong, it is not processed.
</span><span style="color:#998;font-style:italic">             *
</span><span style="color:#998;font-style:italic">             * 1. The protocol configured by the client is inconsistent with the protocol of the server.
</span><span style="color:#998;font-style:italic">             *    eg: consumer protocol = dubbo, provider only has other protocol services(rest).
</span><span style="color:#998;font-style:italic">             * 2. The registration center is not robust and pushes illegal specification data.
</span><span style="color:#998;font-style:italic">             *
</span><span style="color:#998;font-style:italic">             */</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmptyMap</span><span style="color:#000;font-weight:bold">(</span>newUrlInvokerMap<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;urls to invokers error .invokerUrls.size :&#34;</span> <span style="color:#000;font-weight:bold">+</span> invokerUrls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, invoker.size :0. urls :&#34;</span> <span style="color:#000;font-weight:bold">+</span> invokerUrls
                                             <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">()));</span>
      <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    List<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> newInvokers <span style="color:#000;font-weight:bold">=</span> Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unmodifiableList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;(</span>newUrlInvokerMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">values</span><span style="color:#000;font-weight:bold">()));</span>
    <span style="color:#998;font-style:italic">// pre-route and build cache, notice that route cache should build on original Invoker list.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// toMergeMethodInvokerMap() will wrap some invokers having different groups, those wrapped invokers not should be routed.
</span><span style="color:#998;font-style:italic"></span>    routerChain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setInvokers</span><span style="color:#000;font-weight:bold">(</span>newInvokers<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invokers</span> <span style="color:#000;font-weight:bold">=</span> multiGroup <span style="color:#000;font-weight:bold">?</span> toMergeInvokerList<span style="color:#000;font-weight:bold">(</span>newInvokers<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">:</span> newInvokers<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">urlInvokerMap</span> <span style="color:#000;font-weight:bold">=</span> newUrlInvokerMap<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      destroyUnusedInvokers<span style="color:#000;font-weight:bold">(</span>oldUrlInvokerMap<span style="color:#000;font-weight:bold">,</span> newUrlInvokerMap<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// Close the unused Invoker
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;destroyUnusedInvokers error. &#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#900;font-weight:bold">toInvokers</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> newUrlInvokerMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>urls <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> newUrlInvokerMap<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  Set<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> keys <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashSet<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
  String queryProtocols <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">queryMap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>PROTOCOL_KEY<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>URL providerUrl <span style="color:#000;font-weight:bold">:</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// If protocol is configured at the reference side, only the matching protocol is selected
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>queryProtocols <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> queryProtocols<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#458;font-weight:bold">boolean</span> accept <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
      String<span style="color:#000;font-weight:bold">[]</span> acceptProtocols <span style="color:#000;font-weight:bold">=</span> queryProtocols<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;,&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String acceptProtocol <span style="color:#000;font-weight:bold">:</span> acceptProtocols<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>providerUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>acceptProtocol<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          accept <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>accept<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>EMPTY_PROTOCOL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>providerUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>Protocol<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">hasExtension</span><span style="color:#000;font-weight:bold">(</span>providerUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Unsupported protocol &#34;</span> <span style="color:#000;font-weight:bold">+</span> providerUrl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProtocol</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span>
                                             <span style="color:#d14">&#34; in notified url: &#34;</span> <span style="color:#000;font-weight:bold">+</span> providerUrl <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; from registry &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span>
                                             <span style="color:#d14">&#34; to consumer &#34;</span> <span style="color:#000;font-weight:bold">+</span> NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, supported protocol: &#34;</span> <span style="color:#000;font-weight:bold">+</span>
                                             ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>Protocol<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getSupportedExtensions</span><span style="color:#000;font-weight:bold">()));</span>
      <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    URL url <span style="color:#000;font-weight:bold">=</span> mergeUrl<span style="color:#000;font-weight:bold">(</span>providerUrl<span style="color:#000;font-weight:bold">);</span>

    String key <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toFullString</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#998;font-style:italic">// The parameter urls are sorted
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>keys<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// Repeated url
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">continue</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    keys<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// Cache key is url that does not merge with consumer side parameters, regardless of how the consumer combines parameters, if the server url changes, then refer again
</span><span style="color:#998;font-style:italic"></span>    Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> localUrlInvokerMap <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">urlInvokerMap</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// local reference
</span><span style="color:#998;font-style:italic"></span>    Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> invoker <span style="color:#000;font-weight:bold">=</span> localUrlInvokerMap <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">:</span> localUrlInvokerMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invoker <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// Not in the cache, refer again
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#458;font-weight:bold">boolean</span> enabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasParameter</span><span style="color:#000;font-weight:bold">(</span>DISABLED_KEY<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
          enabled <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">!</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>DISABLED_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
          enabled <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>ENABLED_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>enabled<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#998;font-style:italic">// 创建 invoker delegate，最终创建的是一个 dubbo 的 config
</span><span style="color:#998;font-style:italic"></span>          invoker <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> InvokerDelegate<span style="color:#000;font-weight:bold">&lt;&gt;(</span>protocol<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">refer</span><span style="color:#000;font-weight:bold">(</span>serviceType<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">),</span> url<span style="color:#000;font-weight:bold">,</span> providerUrl<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to refer invoker for interface:&#34;</span> <span style="color:#000;font-weight:bold">+</span> serviceType <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;,url:(&#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;)&#34;</span> <span style="color:#000;font-weight:bold">+</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> t<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invoker <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// Put new invoker in cache
</span><span style="color:#998;font-style:italic"></span>        newUrlInvokerMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> invoker<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      newUrlInvokerMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> invoker<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  keys<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">clear</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">return</span> newUrlInvokerMap<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// FailbackRegistry
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">subscribe</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> NotifyListener listener<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">subscribe</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">);</span>
  removeFailedSubscribed<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Sending a subscription request to the server side
</span><span style="color:#998;font-style:italic"></span>    doSubscribe<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Throwable t <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">;</span>

    List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls <span style="color:#000;font-weight:bold">=</span> getCacheUrls<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>urls<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      notify<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">,</span> urls<span style="color:#000;font-weight:bold">);</span>
      logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to subscribe &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, Using cached list: &#34;</span> <span style="color:#000;font-weight:bold">+</span> urls <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; from cache file: &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>FILE_KEY<span style="color:#000;font-weight:bold">,</span> System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;user.home&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/dubbo-registry-&#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;.cache&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// If the startup detection is opened, the Exception is thrown directly.
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#458;font-weight:bold">boolean</span> check <span style="color:#000;font-weight:bold">=</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHECK_KEY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">&amp;&amp;</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHECK_KEY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#458;font-weight:bold">boolean</span> skipFailback <span style="color:#000;font-weight:bold">=</span> t <span style="color:#000;font-weight:bold">instanceof</span> SkipFailbackWrapperException<span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>check <span style="color:#000;font-weight:bold">||</span> skipFailback<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>skipFailback<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          t <span style="color:#000;font-weight:bold">=</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCause</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalStateException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to subscribe &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> t<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to subscribe &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, waiting for retry, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> t<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#998;font-style:italic">// Record a failed registration request to a failed list, retry regularly
</span><span style="color:#998;font-style:italic"></span>    addFailedSubscribed<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 去订阅
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doSubscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> URL url<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">final</span> NotifyListener listener<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ANY_VALUE<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getServiceInterface</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
      String root <span style="color:#000;font-weight:bold">=</span> toRootPath<span style="color:#000;font-weight:bold">();</span>
      ConcurrentMap<span style="color:#000;font-weight:bold">&lt;</span>NotifyListener<span style="color:#000;font-weight:bold">,</span> ChildListener<span style="color:#000;font-weight:bold">&gt;</span> listeners <span style="color:#000;font-weight:bold">=</span> zkListeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>listeners <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        zkListeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putIfAbsent</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> ConcurrentHashMap<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
        listeners <span style="color:#000;font-weight:bold">=</span> zkListeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      ChildListener zkListener <span style="color:#000;font-weight:bold">=</span> listeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>listener<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>zkListener <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        listeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putIfAbsent</span><span style="color:#000;font-weight:bold">(</span>listener<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>parentPath<span style="color:#000;font-weight:bold">,</span> currentChilds<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String child <span style="color:#000;font-weight:bold">:</span> currentChilds<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            child <span style="color:#000;font-weight:bold">=</span> URL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decode</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>anyServices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">contains</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
              anyServices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">);</span>
              subscribe<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPath</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">addParameters</span><span style="color:#000;font-weight:bold">(</span>INTERFACE_KEY<span style="color:#000;font-weight:bold">,</span> child<span style="color:#000;font-weight:bold">,</span>
                                                         Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHECK_KEY</span><span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)),</span> listener<span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">}</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">});</span>
        zkListener <span style="color:#000;font-weight:bold">=</span> listeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>listener<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      zkClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
      List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> services <span style="color:#000;font-weight:bold">=</span> zkClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addChildListener</span><span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">,</span> zkListener<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmpty</span><span style="color:#000;font-weight:bold">(</span>services<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String service <span style="color:#000;font-weight:bold">:</span> services<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          service <span style="color:#000;font-weight:bold">=</span> URL<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">decode</span><span style="color:#000;font-weight:bold">(</span>service<span style="color:#000;font-weight:bold">);</span>
          anyServices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>service<span style="color:#000;font-weight:bold">);</span>
          subscribe<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setPath</span><span style="color:#000;font-weight:bold">(</span>service<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">addParameters</span><span style="color:#000;font-weight:bold">(</span>INTERFACE_KEY<span style="color:#000;font-weight:bold">,</span> service<span style="color:#000;font-weight:bold">,</span>
                                                       Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CHECK_KEY</span><span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)),</span> listener<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 如果有订阅的接口
</span><span style="color:#998;font-style:italic"></span>      List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
      <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>String path <span style="color:#000;font-weight:bold">:</span> toCategoriesPath<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 获取 listener
</span><span style="color:#998;font-style:italic"></span>        ConcurrentMap<span style="color:#000;font-weight:bold">&lt;</span>NotifyListener<span style="color:#000;font-weight:bold">,</span> ChildListener<span style="color:#000;font-weight:bold">&gt;</span> listeners <span style="color:#000;font-weight:bold">=</span> zkListeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>listeners <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          zkListeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putIfAbsent</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">new</span> ConcurrentHashMap<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
          <span style="color:#998;font-style:italic">// 从注册中心中获取 listener
</span><span style="color:#998;font-style:italic"></span>          listeners <span style="color:#000;font-weight:bold">=</span> zkListeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        ChildListener zkListener <span style="color:#000;font-weight:bold">=</span> listeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>listener<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>zkListener <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          listeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putIfAbsent</span><span style="color:#000;font-weight:bold">(</span>listener<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>parentPath<span style="color:#000;font-weight:bold">,</span> currentChilds<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">-&gt;</span> ZookeeperRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">notify</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">,</span> toUrlsWithEmpty<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> parentPath<span style="color:#000;font-weight:bold">,</span> currentChilds<span style="color:#000;font-weight:bold">)));</span>
          <span style="color:#998;font-style:italic">// 获取 listener
</span><span style="color:#998;font-style:italic"></span>          zkListener <span style="color:#000;font-weight:bold">=</span> listeners<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>listener<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// 在注册中心中创建订阅
</span><span style="color:#998;font-style:italic"></span>        zkClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">create</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
        List<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> children <span style="color:#000;font-weight:bold">=</span> zkClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addChildListener</span><span style="color:#000;font-weight:bold">(</span>path<span style="color:#000;font-weight:bold">,</span> zkListener<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>children <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          urls<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAll</span><span style="color:#000;font-weight:bold">(</span>toUrlsWithEmpty<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> path<span style="color:#000;font-weight:bold">,</span> children<span style="color:#000;font-weight:bold">));</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#998;font-style:italic">// 通过获取到了 listener
</span><span style="color:#998;font-style:italic"></span>      notify<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">,</span> urls<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to subscribe &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; to zookeeper &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">notify</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> NotifyListener listener<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;notify url == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>listener <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;notify listener == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    doNotify<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">,</span> urls<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Record a failed registration request to a failed list, retry regularly
</span><span style="color:#998;font-style:italic"></span>    addFailedNotified<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">,</span> urls<span style="color:#000;font-weight:bold">);</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Failed to notify for subscribe &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, waiting for retry, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> t<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> t<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">doNotify</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> NotifyListener listener<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">notify</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> listener<span style="color:#000;font-weight:bold">,</span> urls<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AbstractRegistry
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">notify</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">,</span> NotifyListener listener<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;notify url == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>listener <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> IllegalArgumentException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;notify listener == null&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">(</span>urls<span style="color:#000;font-weight:bold">))</span>
      <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>ANY_VALUE<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getServiceInterface</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Ignore empty notify urls for subscribe url &#34;</span> <span style="color:#000;font-weight:bold">+</span> url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isInfoEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Notify urls for subscribe url &#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, urls: &#34;</span> <span style="color:#000;font-weight:bold">+</span> urls<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// keep every provider&#39;s category.
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;&gt;</span> result <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>URL u <span style="color:#000;font-weight:bold">:</span> urls<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>UrlUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isMatch</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> u<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      String category <span style="color:#000;font-weight:bold">=</span> u<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>CATEGORY_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_CATEGORY<span style="color:#000;font-weight:bold">);</span>
      List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> categoryList <span style="color:#000;font-weight:bold">=</span> result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">computeIfAbsent</span><span style="color:#000;font-weight:bold">(</span>category<span style="color:#000;font-weight:bold">,</span> k <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
      categoryList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>u<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;&gt;</span> categoryNotified <span style="color:#000;font-weight:bold">=</span> notified<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">computeIfAbsent</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> u <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">new</span> ConcurrentHashMap<span style="color:#000;font-weight:bold">&lt;&gt;());</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Entry</span><span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;&gt;</span> entry <span style="color:#000;font-weight:bold">:</span> result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">entrySet</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    String category <span style="color:#000;font-weight:bold">=</span> entry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKey</span><span style="color:#000;font-weight:bold">();</span>
    List<span style="color:#000;font-weight:bold">&lt;</span>URL<span style="color:#000;font-weight:bold">&gt;</span> categoryList <span style="color:#000;font-weight:bold">=</span> entry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getValue</span><span style="color:#000;font-weight:bold">();</span>
    categoryNotified<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>category<span style="color:#000;font-weight:bold">,</span> categoryList<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 调用 listener 的 notify 方法
</span><span style="color:#998;font-style:italic"></span>    listener<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">notify</span><span style="color:#000;font-weight:bold">(</span>categoryList<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// We will update our cache file after each notification.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// When our Registry has a subscribe failure due to network jitter, we can return at least the existing cache URL.
</span><span style="color:#998;font-style:italic"></span>    saveProperties<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DubboProtocol
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">protocolBindingRefer</span><span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> serviceType<span style="color:#000;font-weight:bold">,</span> URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  optimizeSerialization<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// create rpc invoker.
</span><span style="color:#998;font-style:italic"></span>  DubboInvoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> invoker <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DubboInvoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;(</span>serviceType<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">,</span> getClients<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">),</span> invokers<span style="color:#000;font-weight:bold">);</span>
  invokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 获取客户端地址
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> ExchangeClient<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getClients</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// whether to share connection
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">boolean</span> useShareConnect <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#458;font-weight:bold">int</span> connections <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>CONNECTIONS_KEY<span style="color:#000;font-weight:bold">,</span> 0<span style="color:#000;font-weight:bold">);</span>
  List<span style="color:#000;font-weight:bold">&lt;</span>ReferenceCountExchangeClient<span style="color:#000;font-weight:bold">&gt;</span> shareClients <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// if not configured, connection is shared, otherwise, one connection for one service
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>connections <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    useShareConnect <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// The xml configuration should have a higher priority than properties.
</span><span style="color:#998;font-style:italic"></span>    String shareConnectionsStr <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>SHARE_CONNECTIONS_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
    connections <span style="color:#000;font-weight:bold">=</span> Integer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseInt</span><span style="color:#000;font-weight:bold">(</span>StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isBlank</span><span style="color:#000;font-weight:bold">(</span>shareConnectionsStr<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">?</span> ConfigUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span>SHARE_CONNECTIONS_KEY<span style="color:#000;font-weight:bold">,</span>
    shareClients <span style="color:#000;font-weight:bold">=</span> getSharedClient<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> connections<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  ExchangeClient<span style="color:#000;font-weight:bold">[]</span> clients <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ExchangeClient<span style="color:#000;font-weight:bold">[</span>connections<span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> clients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">;</span> i<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>useShareConnect<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      clients<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> shareClients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>i<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      clients<span style="color:#000;font-weight:bold">[</span>i<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> initClient<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> clients<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> ExchangeClient <span style="color:#900;font-weight:bold">initClient</span><span style="color:#000;font-weight:bold">(</span>URL url<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// client type setting.
</span><span style="color:#998;font-style:italic"></span>  String str <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>CLIENT_KEY<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>SERVER_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_REMOTING_CLIENT<span style="color:#000;font-weight:bold">));</span>
  url <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameter</span><span style="color:#000;font-weight:bold">(</span>CODEC_KEY<span style="color:#000;font-weight:bold">,</span> DubboCodec<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NAME</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// enable heartbeat by default
</span><span style="color:#998;font-style:italic"></span>  url <span style="color:#000;font-weight:bold">=</span> url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addParameterIfAbsent</span><span style="color:#000;font-weight:bold">(</span>HEARTBEAT_KEY<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>DEFAULT_HEARTBEAT<span style="color:#000;font-weight:bold">));</span>
  <span style="color:#998;font-style:italic">// BIO is not allowed since it has severe performance issue.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>str <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> str<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>Transporter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">hasExtension</span><span style="color:#000;font-weight:bold">(</span>str<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Unsupported client type: &#34;</span> <span style="color:#000;font-weight:bold">+</span> str <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;,&#34;</span> <span style="color:#000;font-weight:bold">+</span>
                           <span style="color:#d14">&#34; supported client type is &#34;</span> <span style="color:#000;font-weight:bold">+</span> StringUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">join</span><span style="color:#000;font-weight:bold">(</span>ExtensionLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getExtensionLoader</span><span style="color:#000;font-weight:bold">(</span>Transporter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getSupportedExtensions</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#d14">&#34; &#34;</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span>
  ExchangeClient client<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// connection should be lazy
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>LAZY_CONNECT_KEY<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      client <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> LazyConnectExchangeClient<span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> requestHandler<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 最终创建了一个 NettyClient 的连接
</span><span style="color:#998;font-style:italic"></span>      client <span style="color:#000;font-weight:bold">=</span> Exchangers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">connect</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> requestHandler<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>RemotingException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Fail to create remoting client for service(&#34;</span> <span style="color:#000;font-weight:bold">+</span> url <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;): &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> client<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="服务调用">服务调用</h3>
<p>参考：<a href="http://dubbo.apache.org/zh-cn/docs/source_code_guide/service-invoking-process.html">服务调用</a></p>
<p>一个简单的方法如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@GetMapping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">public</span> Article <span style="color:#900;font-weight:bold">hello</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> articleService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getArticleById</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Debug 运行查看 Dubbo 生成的 Proxy 类如下：</p>
<p><img src="http://img.programya.com/20200105102938.png" alt="Dubbo Proxy"></p>
<p>首先调用的是 <code>InvokerInvocationHandler</code> 中的 invoker 方法</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// InvokerInvocationHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Object proxy<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable <span style="color:#000;font-weight:bold">{</span>
  String methodName <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">();</span>
  Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> parameterTypes <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterTypes</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDeclaringClass</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> Object<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;toString&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>methodName<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> parameterTypes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;hashCode&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>methodName<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> parameterTypes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hashCode</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;equals&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>methodName<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> parameterTypes<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>args<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 判断不是 Object 的几个方法之后继续执行 invoke
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">new</span> RpcInvocation<span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">recreate</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后到了 <code>AbstractClusterInvoker</code> 中</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 校验是否已经被销毁
</span><span style="color:#998;font-style:italic"></span>  checkWhetherDestroyed<span style="color:#000;font-weight:bold">();</span>

  <span style="color:#998;font-style:italic">// binding attachments into invocation.
</span><span style="color:#998;font-style:italic"></span>  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> contextAttachments <span style="color:#000;font-weight:bold">=</span> RpcContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAttachments</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>contextAttachments <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> contextAttachments<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">((</span>RpcInvocation<span style="color:#000;font-weight:bold">)</span> invocation<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">addAttachments</span><span style="color:#000;font-weight:bold">(</span>contextAttachments<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 获取所有可用的 invoker
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> invokers <span style="color:#000;font-weight:bold">=</span> list<span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 初始化负载均衡机制
</span><span style="color:#998;font-style:italic"></span>  LoadBalance loadbalance <span style="color:#000;font-weight:bold">=</span> initLoadBalance<span style="color:#000;font-weight:bold">(</span>invokers<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// Idempotent operation: invocation id will be added in async operation by default
</span><span style="color:#998;font-style:italic"></span>  RpcUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attachInvocationIdIfAsync</span><span style="color:#000;font-weight:bold">(</span>getUrl<span style="color:#000;font-weight:bold">(),</span> invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">//  执行 invoke
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> doInvoke<span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">,</span> invokers<span style="color:#000;font-weight:bold">,</span> loadbalance<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后到了 <code>FailoverClusterInvoker</code> 中</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">doInvoke</span><span style="color:#000;font-weight:bold">(</span>Invocation invocation<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">final</span> List<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> invokers<span style="color:#000;font-weight:bold">,</span> LoadBalance loadbalance<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  List<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> copyInvokers <span style="color:#000;font-weight:bold">=</span> invokers<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 确保有 invokers
</span><span style="color:#998;font-style:italic"></span>  checkInvokers<span style="color:#000;font-weight:bold">(</span>copyInvokers<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 获取方法名称
</span><span style="color:#998;font-style:italic"></span>  String methodName <span style="color:#000;font-weight:bold">=</span> RpcUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethodName</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 获取重试次数
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">int</span> len <span style="color:#000;font-weight:bold">=</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getMethodParameter</span><span style="color:#000;font-weight:bold">(</span>methodName<span style="color:#000;font-weight:bold">,</span> RETRIES_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_RETRIES<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">+</span> 1<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>len <span style="color:#000;font-weight:bold">&lt;=</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    len <span style="color:#000;font-weight:bold">=</span> 1<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// retry loop.
</span><span style="color:#998;font-style:italic"></span>  RpcException le <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#998;font-style:italic">// last exception.
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;</span> invoked <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;</span>Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;&gt;(</span>copyInvokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#998;font-style:italic">// invoked invokers.
</span><span style="color:#998;font-style:italic"></span>  Set<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;</span> providers <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> HashSet<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">&gt;(</span>len<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> len<span style="color:#000;font-weight:bold">;</span> i<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">//Reselect before retry to avoid a change of candidate `invokers`.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">//NOTE: if `invokers` changed, then `invoked` also lose accuracy.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>i <span style="color:#000;font-weight:bold">&gt;</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 判断是否已经被销毁
</span><span style="color:#998;font-style:italic"></span>      checkWhetherDestroyed<span style="color:#000;font-weight:bold">();</span>
      <span style="color:#998;font-style:italic">// 获取 invokers
</span><span style="color:#998;font-style:italic"></span>      copyInvokers <span style="color:#000;font-weight:bold">=</span> list<span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// check again
</span><span style="color:#998;font-style:italic"></span>      checkInvokers<span style="color:#000;font-weight:bold">(</span>copyInvokers<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 根据负载均衡机制选择一个 invoker
</span><span style="color:#998;font-style:italic"></span>    Invoker<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> invoker <span style="color:#000;font-weight:bold">=</span> select<span style="color:#000;font-weight:bold">(</span>loadbalance<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">,</span> copyInvokers<span style="color:#000;font-weight:bold">,</span> invoked<span style="color:#000;font-weight:bold">);</span>
    invoked<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 把 invoker 放到上下文中
</span><span style="color:#998;font-style:italic"></span>    RpcContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setInvokers</span><span style="color:#000;font-weight:bold">((</span>List<span style="color:#000;font-weight:bold">)</span> invoked<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 执行 invoker
</span><span style="color:#998;font-style:italic"></span>      Result result <span style="color:#000;font-weight:bold">=</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>le <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isWarnEnabled</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Although retry the method &#34;</span> <span style="color:#000;font-weight:bold">+</span> methodName
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; in the service &#34;</span> <span style="color:#000;font-weight:bold">+</span> getInterface<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span>
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; was successful by the provider &#34;</span> <span style="color:#000;font-weight:bold">+</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">()</span>
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, but there have been failed providers &#34;</span> <span style="color:#000;font-weight:bold">+</span> providers
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; (&#34;</span> <span style="color:#000;font-weight:bold">+</span> providers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/&#34;</span> <span style="color:#000;font-weight:bold">+</span> copyInvokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span>
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;) from the registry &#34;</span> <span style="color:#000;font-weight:bold">+</span> directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">()</span>
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; on the consumer &#34;</span> <span style="color:#000;font-weight:bold">+</span> NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">()</span>
                    <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; using the dubbo version &#34;</span> <span style="color:#000;font-weight:bold">+</span> Version<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVersion</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;. Last error is: &#34;</span>
                    <span style="color:#000;font-weight:bold">+</span> le<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> le<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#998;font-style:italic">// 返回结果
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">return</span> result<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>RpcException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isBiz</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// biz exception.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">throw</span> e<span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
      le <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      le <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      providers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span>le<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCode</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#d14">&#34;Failed to invoke the method &#34;</span>
                         <span style="color:#000;font-weight:bold">+</span> methodName <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; in the service &#34;</span> <span style="color:#000;font-weight:bold">+</span> getInterface<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span>
                         <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;. Tried &#34;</span> <span style="color:#000;font-weight:bold">+</span> len <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; times of the providers &#34;</span> <span style="color:#000;font-weight:bold">+</span> providers
                         <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; (&#34;</span> <span style="color:#000;font-weight:bold">+</span> providers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/&#34;</span> <span style="color:#000;font-weight:bold">+</span> copyInvokers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span>
                         <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;) from the registry &#34;</span> <span style="color:#000;font-weight:bold">+</span> directory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAddress</span><span style="color:#000;font-weight:bold">()</span>
                         <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; on the consumer &#34;</span> <span style="color:#000;font-weight:bold">+</span> NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; using the dubbo version &#34;</span>
                         <span style="color:#000;font-weight:bold">+</span> Version<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVersion</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;. Last error is: &#34;</span>
                         <span style="color:#000;font-weight:bold">+</span> le<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> le<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCause</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> le<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCause</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">:</span> le<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ProtocolFilterWrapper
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 调用 filter invoker
</span><span style="color:#998;font-style:italic"></span>  Result asyncResult <span style="color:#000;font-weight:bold">=</span> filterInvoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>

  asyncResult <span style="color:#000;font-weight:bold">=</span> asyncResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">whenCompleteWithContext</span><span style="color:#000;font-weight:bold">((</span>r<span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> filters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">-</span> 1<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&gt;=</span> 0<span style="color:#000;font-weight:bold">;</span> i<span style="color:#000;font-weight:bold">--)</span> <span style="color:#000;font-weight:bold">{</span>
      Filter filter <span style="color:#000;font-weight:bold">=</span> filters<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>i<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// onResponse callback
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>filter <span style="color:#000;font-weight:bold">instanceof</span> ListenableFilter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        Filter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Listener</span> listener <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span>ListenableFilter<span style="color:#000;font-weight:bold">)</span> filter<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">listener</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>listener <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>t <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            listener<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">onResponse</span><span style="color:#000;font-weight:bold">(</span>r<span style="color:#000;font-weight:bold">,</span> filterInvoker<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            listener<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">onError</span><span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">,</span> filterInvoker<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        filter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">onResponse</span><span style="color:#000;font-weight:bold">(</span>r<span style="color:#000;font-weight:bold">,</span> filterInvoker<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">return</span> asyncResult<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ProtocolFilterWrapper
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  Result asyncResult<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 调用 filter invoke
</span><span style="color:#998;font-style:italic"></span>    asyncResult <span style="color:#000;font-weight:bold">=</span> filter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// onError callback
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>filter <span style="color:#000;font-weight:bold">instanceof</span> ListenableFilter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      Filter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Listener</span> listener <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span>ListenableFilter<span style="color:#000;font-weight:bold">)</span> filter<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">listener</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>listener <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        listener<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">onError</span><span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">,</span> invoker<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">throw</span> e<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> asyncResult<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// ConsumerContextFilter
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Invoker<span style="color:#000;font-weight:bold">&lt;?&gt;</span> invoker<span style="color:#000;font-weight:bold">,</span> Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 在上下文中设置相关的信息
</span><span style="color:#998;font-style:italic"></span>  RpcContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setInvoker</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setInvocation</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setLocalAddress</span><span style="color:#000;font-weight:bold">(</span>NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">(),</span> 0<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRemoteAddress</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getHost</span><span style="color:#000;font-weight:bold">(),</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getPort</span><span style="color:#000;font-weight:bold">())</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setRemoteApplicationName</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>REMOTE_APPLICATION_KEY<span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAttachment</span><span style="color:#000;font-weight:bold">(</span>REMOTE_APPLICATION_KEY<span style="color:#000;font-weight:bold">,</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getParameter</span><span style="color:#000;font-weight:bold">(</span>APPLICATION_KEY<span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invocation <span style="color:#000;font-weight:bold">instanceof</span> RpcInvocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">((</span>RpcInvocation<span style="color:#000;font-weight:bold">)</span> invocation<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">setInvoker</span><span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    RpcContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">removeServerContext</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 继续调用 invoke
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    RpcContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">removeContext</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// FutureFilter
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> Invoker<span style="color:#000;font-weight:bold">&lt;?&gt;</span> invoker<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">final</span> Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 主要是为异步用的
</span><span style="color:#998;font-style:italic"></span>  fireInvokeCallback<span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// need to configure if there&#39;s return value before the invocation in order to help invoker to judge if it&#39;s
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#998;font-style:italic">// necessary to return future.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// MonitorFilter
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Invoker<span style="color:#000;font-weight:bold">&lt;?&gt;</span> invoker<span style="color:#000;font-weight:bold">,</span> Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 判断是否需要 monitor
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrl</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">hasParameter</span><span style="color:#000;font-weight:bold">(</span>MONITOR_KEY<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAttachment</span><span style="color:#000;font-weight:bold">(</span>MONITOR_FILTER_START_TIME<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>System<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentTimeMillis</span><span style="color:#000;font-weight:bold">()));</span>
    getConcurrent<span style="color:#000;font-weight:bold">(</span>invoker<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">incrementAndGet</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#998;font-style:italic">// count up
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// proceed invocation chain
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AsyncToSyncInvoker
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 执行 invoke
</span><span style="color:#998;font-style:italic"></span>  Result asyncResult <span style="color:#000;font-weight:bold">=</span> invoker<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 等待获取结果
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>InvokeMode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SYNC</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">((</span>RpcInvocation<span style="color:#000;font-weight:bold">)</span> invocation<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getInvokeMode</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      asyncResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>Integer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MAX_VALUE</span><span style="color:#000;font-weight:bold">,</span> TimeUnit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">MILLISECONDS</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InterruptedException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Interrupted unexpectedly while waiting for remoting result to return!  method: &#34;</span> <span style="color:#000;font-weight:bold">+</span> invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethodName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, provider: &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>ExecutionException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    Throwable t <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCause</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>t <span style="color:#000;font-weight:bold">instanceof</span> TimeoutException<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span>RpcException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">TIMEOUT_EXCEPTION</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;Invoke remote method timeout. method: &#34;</span> <span style="color:#000;font-weight:bold">+</span> invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethodName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, provider: &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>t <span style="color:#000;font-weight:bold">instanceof</span> RemotingException<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span>RpcException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NETWORK_EXCEPTION</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;Failed to invoke remote method: &#34;</span> <span style="color:#000;font-weight:bold">+</span> invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethodName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, provider: &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 返回结果
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> asyncResult<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AbstractInvoker
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Invocation inv<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> RpcException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// if invoker is destroyed due to address refresh from registry, let&#39;s allow the current invoke to proceed
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>destroyed<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    logger<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Invoker for service &#34;</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">this</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; on consumer &#34;</span> <span style="color:#000;font-weight:bold">+</span> NetUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalHost</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; is destroyed, &#34;</span>
                <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, dubbo version is &#34;</span> <span style="color:#000;font-weight:bold">+</span> Version<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVersion</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, this invoker should not be used any longer&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  RpcInvocation invocation <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>RpcInvocation<span style="color:#000;font-weight:bold">)</span> inv<span style="color:#000;font-weight:bold">;</span>
  invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setInvoker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 设置 attachment
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmptyMap</span><span style="color:#000;font-weight:bold">(</span>attachment<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAttachmentsIfAbsent</span><span style="color:#000;font-weight:bold">(</span>attachment<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> String<span style="color:#000;font-weight:bold">&gt;</span> contextAttachments <span style="color:#000;font-weight:bold">=</span> RpcContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getAttachments</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>CollectionUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isNotEmptyMap</span><span style="color:#000;font-weight:bold">(</span>contextAttachments<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * invocation.addAttachmentsIfAbsent(context){@link RpcInvocation#addAttachmentsIfAbsent(Map)}should not be used here,
</span><span style="color:#998;font-style:italic">             * because the {@link RpcContext#setAttachment(String, String)} is passed in the Filter when the call is triggered
</span><span style="color:#998;font-style:italic">             * by the built-in retry mechanism of the Dubbo. The attachment to update RpcContext will no longer work, which is
</span><span style="color:#998;font-style:italic">             * a mistake in most cases (for example, through Filter to RpcContext output traceId and spanId and other information).
</span><span style="color:#998;font-style:italic">             */</span>
    invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addAttachments</span><span style="color:#000;font-weight:bold">(</span>contextAttachments<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 设置 invoke mode
</span><span style="color:#998;font-style:italic"></span>  invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setInvokeMode</span><span style="color:#000;font-weight:bold">(</span>RpcUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getInvokeMode</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">));</span>
  RpcUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">attachInvocationIdIfAsync</span><span style="color:#000;font-weight:bold">(</span>getUrl<span style="color:#000;font-weight:bold">(),</span> invocation<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 执行 invoke
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> doInvoke<span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>InvocationTargetException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> 
    <span style="color:#998;font-style:italic">// biz exception
</span><span style="color:#998;font-style:italic"></span>    Throwable te <span style="color:#000;font-weight:bold">=</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTargetException</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>te <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">return</span> AsyncRpcResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newDefaultAsyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>te <span style="color:#000;font-weight:bold">instanceof</span> RpcException<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">((</span>RpcException<span style="color:#000;font-weight:bold">)</span> te<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">setCode</span><span style="color:#000;font-weight:bold">(</span>RpcException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">BIZ_EXCEPTION</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">return</span> AsyncRpcResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newDefaultAsyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> te<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>RpcException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isBiz</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">return</span> AsyncRpcResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newDefaultAsyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> e<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> AsyncRpcResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newDefaultAsyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">,</span> invocation<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DubboInvoker
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">protected</span> Result <span style="color:#900;font-weight:bold">doInvoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> Invocation invocation<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable <span style="color:#000;font-weight:bold">{</span>
  RpcInvocation inv <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>RpcInvocation<span style="color:#000;font-weight:bold">)</span> invocation<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">final</span> String methodName <span style="color:#000;font-weight:bold">=</span> RpcUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethodName</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
  inv<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAttachment</span><span style="color:#000;font-weight:bold">(</span>PATH_KEY<span style="color:#000;font-weight:bold">,</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getPath</span><span style="color:#000;font-weight:bold">());</span>
  inv<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAttachment</span><span style="color:#000;font-weight:bold">(</span>VERSION_KEY<span style="color:#000;font-weight:bold">,</span> version<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 获取 ExchangeClient
</span><span style="color:#998;font-style:italic"></span>  ExchangeClient currentClient<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>clients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span> <span style="color:#000;font-weight:bold">==</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    currentClient <span style="color:#000;font-weight:bold">=</span> clients<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    currentClient <span style="color:#000;font-weight:bold">=</span> clients<span style="color:#000;font-weight:bold">[</span>index<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAndIncrement</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">%</span> clients<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">];</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">boolean</span> isOneway <span style="color:#000;font-weight:bold">=</span> RpcUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isOneway</span><span style="color:#000;font-weight:bold">(</span>getUrl<span style="color:#000;font-weight:bold">(),</span> invocation<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#458;font-weight:bold">int</span> timeout <span style="color:#000;font-weight:bold">=</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getMethodPositiveParameter</span><span style="color:#000;font-weight:bold">(</span>methodName<span style="color:#000;font-weight:bold">,</span> TIMEOUT_KEY<span style="color:#000;font-weight:bold">,</span> DEFAULT_TIMEOUT<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isOneway<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#458;font-weight:bold">boolean</span> isSent <span style="color:#000;font-weight:bold">=</span> getUrl<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getMethodParameter</span><span style="color:#000;font-weight:bold">(</span>methodName<span style="color:#000;font-weight:bold">,</span> Constants<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SENT_KEY</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
      currentClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">send</span><span style="color:#000;font-weight:bold">(</span>inv<span style="color:#000;font-weight:bold">,</span> isSent<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">return</span> AsyncRpcResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newDefaultAsyncResult</span><span style="color:#000;font-weight:bold">(</span>invocation<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 创建一个异步的 rpc result
</span><span style="color:#998;font-style:italic"></span>      AsyncRpcResult asyncRpcResult <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AsyncRpcResult<span style="color:#000;font-weight:bold">(</span>inv<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// 使用 Netty 执行 request 请求
</span><span style="color:#998;font-style:italic"></span>      CompletableFuture<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> responseFuture <span style="color:#000;font-weight:bold">=</span> currentClient<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">request</span><span style="color:#000;font-weight:bold">(</span>inv<span style="color:#000;font-weight:bold">,</span> timeout<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// 订阅response 结果
</span><span style="color:#998;font-style:italic"></span>      asyncRpcResult<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">subscribeTo</span><span style="color:#000;font-weight:bold">(</span>responseFuture<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// save for 2.6.x compatibility, for example, TraceFilter in Zipkin uses com.alibaba.xxx.FutureAdapter
</span><span style="color:#998;font-style:italic"></span>      FutureContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getContext</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">setCompatibleFuture</span><span style="color:#000;font-weight:bold">(</span>responseFuture<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// 返回异步 rpc result
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">return</span> asyncRpcResult<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>TimeoutException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span>RpcException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">TIMEOUT_EXCEPTION</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;Invoke remote method timeout. method: &#34;</span> <span style="color:#000;font-weight:bold">+</span> invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethodName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, provider: &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>RemotingException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> RpcException<span style="color:#000;font-weight:bold">(</span>RpcException<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NETWORK_EXCEPTION</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;Failed to invoke remote method: &#34;</span> <span style="color:#000;font-weight:bold">+</span> invocation<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMethodName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, provider: &#34;</span> <span style="color:#000;font-weight:bold">+</span> getUrl<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;, cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMessage</span><span style="color:#000;font-weight:bold">(),</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// AsyncRpcResult
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">subscribeTo</span><span style="color:#000;font-weight:bold">(</span>CompletableFuture<span style="color:#000;font-weight:bold">&lt;?&gt;</span> future<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 等待结果
</span><span style="color:#998;font-style:italic"></span>  future<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">whenComplete</span><span style="color:#000;font-weight:bold">((</span>obj<span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">-&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>t <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">completeExceptionally</span><span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">complete</span><span style="color:#000;font-weight:bold">((</span>Result<span style="color:#000;font-weight:bold">)</span> obj<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div>
        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="http://programya.com/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/Dubbo-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/">Dubbo 基本配置</a></li>
        
        <li><a href="http://programya.com/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/Dubbo-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Dubbo 基本概念和环境搭建</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='http://programya.com/tags/Dubbo'>Dubbo</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://programya.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-JNDI/" title="Java JNDI">Java JNDI</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-JVM/" title="Java JVM">Java JVM</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-HotSpot-GC-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" title="Java HotSpot GC 算法实现">Java HotSpot GC 算法实现</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-GC-2/" title="Java GC 2">Java GC 2</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-GC-1/" title="Java GC 1">Java GC 1</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="Java 虚拟机内存模型">Java 虚拟机内存模型</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/" title="Java 逃逸分析">Java 逃逸分析</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Spring/Spring-Security/Spring-Security/" title="Spring Security">Spring Security</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-%E5%9B%9B%E7%A7%8D%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" title="Java 四种引用类型">Java 四种引用类型</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/Dubbo-%E5%8E%9F%E7%90%86/" title="Dubbo 原理">Dubbo 原理</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="http://programya.com/categories/Java/">Java (22)</a></li>
    
    <li><a href="http://programya.com/categories/MQ/">MQ (3)</a></li>
    
    <li><a href="http://programya.com/categories/MyBaits/">MyBaits (7)</a></li>
    
    <li><a href="http://programya.com/categories/MySQL/">MySQL (4)</a></li>
    
    <li><a href="http://programya.com/categories/Netty/">Netty (10)</a></li>
    
    <li><a href="http://programya.com/categories/Nginx/">Nginx (2)</a></li>
    
    <li><a href="http://programya.com/categories/Redis/">Redis (2)</a></li>
    
    <li><a href="http://programya.com/categories/Spring/">Spring (37)</a></li>
    
    <li><a href="http://programya.com/categories/%E5%85%B3%E4%BA%8E/">关于 (1)</a></li>
    
    <li><a href="http://programya.com/categories/%E5%85%B6%E4%BB%96/">其他 (8)</a></li>
    
    <li><a href="http://programya.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 (11)</a></li>
    
    <li><a href="http://programya.com/categories/%E7%AE%97%E6%B3%95/">算法 (3)</a></li>
    
    <li><a href="http://programya.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (7)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="http://programya.com/tags/Active-MQ/">Active MQ</a>
    
    <a href="http://programya.com/tags/Cookie/">Cookie</a>
    
    <a href="http://programya.com/tags/Debug/">Debug</a>
    
    <a href="http://programya.com/tags/Docker/">Docker</a>
    
    <a href="http://programya.com/tags/Dubbo/">Dubbo</a>
    
    <a href="http://programya.com/tags/Git/">Git</a>
    
    <a href="http://programya.com/tags/JDK8/">JDK8</a>
    
    <a href="http://programya.com/tags/JPA/">JPA</a>
    
    <a href="http://programya.com/tags/JUC/">JUC</a>
    
    <a href="http://programya.com/tags/JVM/">JVM</a>
    
    <a href="http://programya.com/tags/java/">java</a>
    
    <a href="http://programya.com/tags/Jenkins/">Jenkins</a>
    
    <a href="http://programya.com/tags/Kafka/">Kafka</a>
    
    <a href="http://programya.com/tags/Kubernetes/">Kubernetes</a>
    
    <a href="http://programya.com/tags/Linux/">Linux</a>
    
    <a href="http://programya.com/tags/Maven/">Maven</a>
    
    <a href="http://programya.com/tags/MyBaits/">MyBaits</a>
    
    <a href="http://programya.com/tags/MySQL/">MySQL</a>
    
    <a href="http://programya.com/tags/Netty/">Netty</a>
    
    <a href="http://programya.com/tags/Nginx/">Nginx</a>
    
    <a href="http://programya.com/tags/Rabbit-MQ/">Rabbit MQ</a>
    
    <a href="http://programya.com/tags/Redis/">Redis</a>
    
    <a href="http://programya.com/tags/Rocket-MQ/">Rocket MQ</a>
    
    <a href="http://programya.com/tags/Session/">Session</a>
    
    <a href="http://programya.com/tags/Spring/">Spring</a>
    
    <a href="http://programya.com/tags/Spring-Boot/">Spring Boot</a>
    
    <a href="http://programya.com/tags/Spring-Cloud/">Spring Cloud</a>
    
    <a href="http://programya.com/tags/Spring-Data/">Spring Data</a>
    
    <a href="http://programya.com/tags/Spring-MVC/">Spring MVC</a>
    
    <a href="http://programya.com/tags/Spring-Security/">Spring Security</a>
    
    <a href="http://programya.com/tags/Spring-%E6%B3%A8%E8%A7%A3/">Spring 注解</a>
    
    <a href="http://programya.com/tags/Tmux/">Tmux</a>
    
    <a href="http://programya.com/tags/Zookeeper/">Zookeeper</a>
    
    <a href="http://programya.com/tags/java/">java</a>
    
    <a href="http://programya.com/tags/%E4%BB%A3%E7%A0%81/">代码</a>
    
    <a href="http://programya.com/tags/%E5%85%B3%E4%BA%8E/">关于</a>
    
    <a href="http://programya.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
    
    <a href="http://programya.com/tags/%E6%BA%90%E7%A0%81/">源码</a>
    
    <a href="http://programya.com/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
    <a href="http://programya.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
    
    <a href="http://programya.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
    
    <a href="http://programya.com/tags/%E9%9B%86%E5%90%88/">集合</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://programya.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="http://programya.com/">新月的博客 By 新月</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        Theme based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='http://programya.com/js/totop.js?v=0.0.0' async=""></script>






</body>

</html>