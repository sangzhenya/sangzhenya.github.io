<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MyBatis 运行原理 | 新月的博客</title>
    <meta property="og:title" content="MyBatis 运行原理 - 新月的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-05-11T09:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-05-11T09:00:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="MyBatis 运行原理">
        
    <meta name="author" content="新月">
    <meta property="og:url" content="http://programya.com/post/DataBase/MyBatis/MyBaits-%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/">
    <link rel="shortcut icon" href="http://programya.com/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='http://programya.com/css/normalize.css'>
    <link rel="stylesheet" href='http://programya.com/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://programya.com/">
                        新月的博客
                    </a>
                
                <p class="description">晚来天欲雪，能饮一杯无？</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://programya.com/">首页</a>
                    
                    <a  href="http://programya.com/archives/" title="归档">归档</a>
                    
                    <a  href="http://programya.com/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">MyBatis 运行原理</h1>
        </header>
        <date class="post-meta meta-date">
            2019年5月11日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='http://programya.com/categories/MyBaits'>MyBaits</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>MyBaits 分层结构图</p>
<p><img src="http://img.programya.com/20191228151822.png" alt="MyBatis 分层结构图"></p>
<p>MyBatis 过程整个过程有以下四步：</p>
<ol>
<li>创建 <code>SqlSessionFactory</code></li>
<li>获取 <code>SqlSession</code></li>
<li>获取代理对象</li>
<li>执行方法</li>
</ol>
<h3 id="获取-sqlsessionfactory">获取 <code>SqlSessionFactory</code></h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> SqlSessionFactory <span style="color:#900;font-weight:bold">getSqlSessionFactory</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> IOException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取配置的文件流
</span><span style="color:#998;font-style:italic"></span>  InputStream inputStream <span style="color:#000;font-weight:bold">=</span> Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResourceAsStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mybatis-config.xml&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 根据配置使用 SqlSessionFactoryBuilder 生成 SqlSessionFactory
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> SqlSessionFactoryBuilder<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">(</span>inputStream<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// SqlSessionFactoryBuilder
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> SqlSessionFactory <span style="color:#900;font-weight:bold">build</span><span style="color:#000;font-weight:bold">(</span>InputStream inputStream<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 调用内部的 build 方法
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> build<span style="color:#000;font-weight:bold">(</span>inputStream<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">public</span> SqlSessionFactory <span style="color:#900;font-weight:bold">build</span><span style="color:#000;font-weight:bold">(</span>InputStream inputStream<span style="color:#000;font-weight:bold">,</span> String environment<span style="color:#000;font-weight:bold">,</span> Properties properties<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 根据配置文件，环境信息和配置信息生成一个 XMLConfigBuilder
</span><span style="color:#998;font-style:italic"></span>    XMLConfigBuilder parser <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> XMLConfigBuilder<span style="color:#000;font-weight:bold">(</span>inputStream<span style="color:#000;font-weight:bold">,</span> environment<span style="color:#000;font-weight:bold">,</span> properties<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 解析文件生成 Configuration 对象，然后使用 Configuration 放到 SqlSessionFactory 返回
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> build<span style="color:#000;font-weight:bold">(</span>parser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> ExceptionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">wrapException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error building SqlSession.&#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">reset</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      inputStream<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">close</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IOException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// Intentionally ignore. Prefer previous error.
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">public</span> SqlSessionFactory <span style="color:#900;font-weight:bold">build</span><span style="color:#000;font-weight:bold">(</span>Configuration config<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DefaultSqlSessionFactory<span style="color:#000;font-weight:bold">(</span>config<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">148
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">149
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">150
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">151
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">152
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">153
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">154
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">155
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">156
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">157
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">158
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">159
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">160
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">161
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">162
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">163
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">164
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">165
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">166
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">167
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">168
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">169
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">170
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">171
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">172
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">173
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">174
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">175
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">176
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">177
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">178
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">179
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">180
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">181
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">182
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">183
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">184
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">185
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">186
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">187
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">188
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">189
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">190
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">191
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">192
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">193
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">194
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">195
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">196
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">197
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">198
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">199
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">200
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">201
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">202
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">203
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">204
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">205
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">206
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">207
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">208
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">209
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">210
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">211
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">212
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">213
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">214
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">215
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">216
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">217
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">218
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">219
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">220
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">221
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">222
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">223
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">224
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">225
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">226
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">227
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">228
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">229
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">230
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">231
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">232
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">233
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">234
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">235
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">236
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">237
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">238
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">239
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">240
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">241
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">242
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">243
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">244
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">245
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">246
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">247
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">248
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">249
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">250
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">251
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">252
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">253
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">254
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">255
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">256
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">257
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">258
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">259
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">260
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">261
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">262
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">263
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// XMLConfigBuilder
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Configuration <span style="color:#900;font-weight:bold">parse</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 判断是否解析过，如果解析过则抛出异常
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parsed<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Each XMLConfigBuilder can only be used once.&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  parsed <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 获取 MyBaits Config 的根节点 configuration，解析 config
</span><span style="color:#998;font-style:italic"></span>  parseConfiguration<span style="color:#000;font-weight:bold">(</span>parser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/configuration&#34;</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">return</span> configuration<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">parseConfiguration</span><span style="color:#000;font-weight:bold">(</span>XNode root<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    propertiesElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;properties&#34;</span><span style="color:#000;font-weight:bold">));</span>
    Properties settings <span style="color:#000;font-weight:bold">=</span> settingsAsProperties<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;settings&#34;</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#998;font-style:italic">// 如果配置了 vfsImpl，取出来放到 config 上
</span><span style="color:#998;font-style:italic"></span>    loadCustomVfs<span style="color:#000;font-weight:bold">(</span>settings<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 设置自定义日志的实现 SLF4J | LOG4J | LOG4J2 | JDK_LOGGING | COMMONS_LOGGING | STDOUT_LOGGING | NO_LOGGING
</span><span style="color:#998;font-style:italic"></span>    loadCustomLogImpl<span style="color:#000;font-weight:bold">(</span>settings<span style="color:#000;font-weight:bold">);</span>
    typeAliasesElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;typeAliases&#34;</span><span style="color:#000;font-weight:bold">));</span>
    pluginElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;plugins&#34;</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#998;font-style:italic">// 解析对象工厂
</span><span style="color:#998;font-style:italic"></span>    objectFactoryElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;objectFactory&#34;</span><span style="color:#000;font-weight:bold">));</span>
    objectWrapperFactoryElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;objectWrapperFactory&#34;</span><span style="color:#000;font-weight:bold">));</span>
    reflectorFactoryElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;reflectorFactory&#34;</span><span style="color:#000;font-weight:bold">));</span>
    settingsElement<span style="color:#000;font-weight:bold">(</span>settings<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// read it after objectFactory and objectWrapperFactory issue #631
</span><span style="color:#998;font-style:italic"></span>    environmentsElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;environments&#34;</span><span style="color:#000;font-weight:bold">));</span>
    databaseIdProviderElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;databaseIdProvider&#34;</span><span style="color:#000;font-weight:bold">));</span>
    typeHandlerElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;typeHandlers&#34;</span><span style="color:#000;font-weight:bold">));</span>
    mapperElement<span style="color:#000;font-weight:bold">(</span>root<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mappers&#34;</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error parsing SQL Mapper Configuration. Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 处理 properties 配置
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">propertiesElement</span><span style="color:#000;font-weight:bold">(</span>XNode context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>context <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 获取所有的属性
</span><span style="color:#998;font-style:italic"></span>    Properties defaults <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildrenAsProperties</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 获取 resource 属性和 url 属性
</span><span style="color:#998;font-style:italic"></span>    String resource <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;resource&#34;</span><span style="color:#000;font-weight:bold">);</span>
    String url <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;url&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resource <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> url <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 如果 resource 不为空则获取所有的属性到 defaults 中，如果配置了 url 则从 url 中读取属性到 resource 中
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 这里也可以看出，从 resource 中读取的属性会覆盖 properties 内部配置的属性
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resource <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      defaults<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putAll</span><span style="color:#000;font-weight:bold">(</span>Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResourceAsProperties</span><span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>url <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      defaults<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putAll</span><span style="color:#000;font-weight:bold">(</span>Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrlAsProperties</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 如果调用 build 方法的时候传入了参数，这边也会放入到属性上
</span><span style="color:#998;font-style:italic"></span>    Properties vars <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getVariables</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>vars <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      defaults<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putAll</span><span style="color:#000;font-weight:bold">(</span>vars<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 将所有的属性放在 parser 和 configuration 上
</span><span style="color:#998;font-style:italic"></span>    parser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVariables</span><span style="color:#000;font-weight:bold">(</span>defaults<span style="color:#000;font-weight:bold">);</span>
    configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setVariables</span><span style="color:#000;font-weight:bold">(</span>defaults<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 处理 setting 配置
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> Properties <span style="color:#900;font-weight:bold">settingsAsProperties</span><span style="color:#000;font-weight:bold">(</span>XNode context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>context <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Properties<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 获取所有的 setting 值
</span><span style="color:#998;font-style:italic"></span>  Properties props <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildrenAsProperties</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 确保所有的设置都是可用的，即 MyBatis 支持的，否则抛出异常
</span><span style="color:#998;font-style:italic"></span>  MetaClass metaConfig <span style="color:#000;font-weight:bold">=</span> MetaClass<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">forClass</span><span style="color:#000;font-weight:bold">(</span>Configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> localReflectorFactory<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>Object key <span style="color:#000;font-weight:bold">:</span> props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">keySet</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>metaConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasSetter</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">)))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;The setting &#34;</span> <span style="color:#000;font-weight:bold">+</span> key <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; is not known.  Make sure you spelled it correctly (case sensitive).&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> props<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 设置别名信息
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">typeAliasesElement</span><span style="color:#000;font-weight:bold">(</span>XNode parent<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parent <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>XNode child <span style="color:#000;font-weight:bold">:</span> parent<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildren</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 如果配置的是 package
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;package&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
        String typeAliasPackage <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">// 扫描包逐个注册 alias 和 type
</span><span style="color:#998;font-style:italic"></span>        configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTypeAliasRegistry</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">registerAliases</span><span style="color:#000;font-weight:bold">(</span>typeAliasPackage<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 如果是逐个注册 alias 和 type
</span><span style="color:#998;font-style:italic"></span>        String alias <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;alias&#34;</span><span style="color:#000;font-weight:bold">);</span>
        String type <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;type&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
          Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> clazz <span style="color:#000;font-weight:bold">=</span> Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">classForName</span><span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>alias <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            typeAliasRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerAlias</span><span style="color:#000;font-weight:bold">(</span>clazz<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            typeAliasRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerAlias</span><span style="color:#000;font-weight:bold">(</span>alias<span style="color:#000;font-weight:bold">,</span> clazz<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>ClassNotFoundException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error registering typeAlias for &#39;&#34;</span> <span style="color:#000;font-weight:bold">+</span> alias <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;&#39;. Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 添加 plugin 
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">pluginElement</span><span style="color:#000;font-weight:bold">(</span>XNode parent<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parent <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 遍历配置
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>XNode child <span style="color:#000;font-weight:bold">:</span> parent<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildren</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 获取配置的 interceptor
</span><span style="color:#998;font-style:italic"></span>      String interceptor <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;interceptor&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// 获取配置的属性
</span><span style="color:#998;font-style:italic"></span>      Properties properties <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildrenAsProperties</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#998;font-style:italic">// 生成一个 Interceptor 并设置属性，然后放到 configuration 上
</span><span style="color:#998;font-style:italic"></span>      Interceptor interceptorInstance <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Interceptor<span style="color:#000;font-weight:bold">)</span> resolveClass<span style="color:#000;font-weight:bold">(</span>interceptor<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getDeclaredConstructor</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">newInstance</span><span style="color:#000;font-weight:bold">();</span>
      interceptorInstance<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setProperties</span><span style="color:#000;font-weight:bold">(</span>properties<span style="color:#000;font-weight:bold">);</span>
      configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addInterceptor</span><span style="color:#000;font-weight:bold">(</span>interceptorInstance<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 从 setting 上读取配置信息逐个放到 config 上
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">settingsElement</span><span style="color:#000;font-weight:bold">(</span>Properties props<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAutoMappingBehavior</span><span style="color:#000;font-weight:bold">(</span>AutoMappingBehavior<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;autoMappingBehavior&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;PARTIAL&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAutoMappingUnknownColumnBehavior</span><span style="color:#000;font-weight:bold">(</span>AutoMappingUnknownColumnBehavior<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;autoMappingUnknownColumnBehavior&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;NONE&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setCacheEnabled</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;cacheEnabled&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setProxyFactory</span><span style="color:#000;font-weight:bold">((</span>ProxyFactory<span style="color:#000;font-weight:bold">)</span> createInstance<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;proxyFactory&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setLazyLoadingEnabled</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;lazyLoadingEnabled&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setAggressiveLazyLoading</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;aggressiveLazyLoading&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMultipleResultSetsEnabled</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;multipleResultSetsEnabled&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUseColumnLabel</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;useColumnLabel&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUseGeneratedKeys</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;useGeneratedKeys&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDefaultExecutorType</span><span style="color:#000;font-weight:bold">(</span>ExecutorType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;defaultExecutorType&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;SIMPLE&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDefaultStatementTimeout</span><span style="color:#000;font-weight:bold">(</span>integerValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;defaultStatementTimeout&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDefaultFetchSize</span><span style="color:#000;font-weight:bold">(</span>integerValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;defaultFetchSize&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDefaultResultSetType</span><span style="color:#000;font-weight:bold">(</span>resolveResultSetType<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;defaultResultSetType&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setMapUnderscoreToCamelCase</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;mapUnderscoreToCamelCase&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSafeRowBoundsEnabled</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;safeRowBoundsEnabled&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setLocalCacheScope</span><span style="color:#000;font-weight:bold">(</span>LocalCacheScope<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;localCacheScope&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;SESSION&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setJdbcTypeForNull</span><span style="color:#000;font-weight:bold">(</span>JdbcType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;jdbcTypeForNull&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;OTHER&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setLazyLoadTriggerMethods</span><span style="color:#000;font-weight:bold">(</span>stringSetValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;lazyLoadTriggerMethods&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#d14">&#34;equals,clone,hashCode,toString&#34;</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setSafeResultHandlerEnabled</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;safeResultHandlerEnabled&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDefaultScriptingLanguage</span><span style="color:#000;font-weight:bold">(</span>resolveClass<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;defaultScriptingLanguage&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDefaultEnumTypeHandler</span><span style="color:#000;font-weight:bold">(</span>resolveClass<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;defaultEnumTypeHandler&#34;</span><span style="color:#000;font-weight:bold">)));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setCallSettersOnNulls</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;callSettersOnNulls&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setUseActualParamName</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;useActualParamName&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setReturnInstanceForEmptyRow</span><span style="color:#000;font-weight:bold">(</span>booleanValueOf<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;returnInstanceForEmptyRow&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setLogPrefix</span><span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;logPrefix&#34;</span><span style="color:#000;font-weight:bold">));</span>
  configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setConfigurationFactory</span><span style="color:#000;font-weight:bold">(</span>resolveClass<span style="color:#000;font-weight:bold">(</span>props<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;configurationFactory&#34;</span><span style="color:#000;font-weight:bold">)));</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 解析 environments 元素
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">environmentsElement</span><span style="color:#000;font-weight:bold">(</span>XNode context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>context <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>environment <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      environment <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;default&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 遍历 environments
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>XNode child <span style="color:#000;font-weight:bold">:</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildren</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 获取每个 environment 的 id
</span><span style="color:#998;font-style:italic"></span>      String id <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// 判断是否是指定的 id，就是配置中配置的
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>isSpecifiedEnvironment<span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 获取 TransactionFactory
</span><span style="color:#998;font-style:italic"></span>        TransactionFactory txFactory <span style="color:#000;font-weight:bold">=</span> transactionManagerElement<span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;transactionManager&#34;</span><span style="color:#000;font-weight:bold">));</span>
        <span style="color:#998;font-style:italic">// 根据 dataSource 的配置信息创建 DataSourceFactory，然后从 DataSourceFactory 中取出 DataSource
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">// 数据库的配置信息在这边读取
</span><span style="color:#998;font-style:italic"></span>        DataSourceFactory dsFactory <span style="color:#000;font-weight:bold">=</span> dataSourceElement<span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;dataSource&#34;</span><span style="color:#000;font-weight:bold">));</span>
        DataSource dataSource <span style="color:#000;font-weight:bold">=</span> dsFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDataSource</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#998;font-style:italic">// 生成 Environment.Builder 然后通过其创建 Environment 放到 config 上
</span><span style="color:#998;font-style:italic"></span>        Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Builder</span> environmentBuilder <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> Environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Builder</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">)</span>
          <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">transactionFactory</span><span style="color:#000;font-weight:bold">(</span>txFactory<span style="color:#000;font-weight:bold">)</span>
          <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">dataSource</span><span style="color:#000;font-weight:bold">(</span>dataSource<span style="color:#000;font-weight:bold">);</span>
        configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setEnvironment</span><span style="color:#000;font-weight:bold">(</span>environmentBuilder<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">());</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 处理 DatabaseProvider 
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">databaseIdProviderElement</span><span style="color:#000;font-weight:bold">(</span>XNode context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  DatabaseIdProvider databaseIdProvider <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>context <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    String type <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;type&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// awful patch to keep backward compatibility
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;VENDOR&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      type <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;DB_VENDOR&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 获取属性，就是数据库名称和别名对应
</span><span style="color:#998;font-style:italic"></span>    Properties properties <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildrenAsProperties</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 根据类型获取 databaseIdProvider 属性并设置属性
</span><span style="color:#998;font-style:italic"></span>    databaseIdProvider <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>DatabaseIdProvider<span style="color:#000;font-weight:bold">)</span> resolveClass<span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getDeclaredConstructor</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">newInstance</span><span style="color:#000;font-weight:bold">();</span>
    databaseIdProvider<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setProperties</span><span style="color:#000;font-weight:bold">(</span>properties<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  Environment environment <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEnvironment</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>environment <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> databaseIdProvider <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 连接数据库获取数据名称并和上面读取的属性对比返回数据库别名，放到 config 上
</span><span style="color:#998;font-style:italic"></span>    String databaseId <span style="color:#000;font-weight:bold">=</span> databaseIdProvider<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDatabaseId</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDataSource</span><span style="color:#000;font-weight:bold">());</span>
    configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setDatabaseId</span><span style="color:#000;font-weight:bold">(</span>databaseId<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 注册 TypeHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">typeHandlerElement</span><span style="color:#000;font-weight:bold">(</span>XNode parent<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parent <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>XNode child <span style="color:#000;font-weight:bold">:</span> parent<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildren</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 如果配置的是包则逐个扫描包
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;package&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
        String typeHandlerPackage <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">);</span>
        typeHandlerRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>typeHandlerPackage<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 获取相应的属性注册 typeHandler
</span><span style="color:#998;font-style:italic"></span>        String javaTypeName <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;javaType&#34;</span><span style="color:#000;font-weight:bold">);</span>
        String jdbcTypeName <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;jdbcType&#34;</span><span style="color:#000;font-weight:bold">);</span>
        String handlerTypeName <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;handler&#34;</span><span style="color:#000;font-weight:bold">);</span>
        Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> javaTypeClass <span style="color:#000;font-weight:bold">=</span> resolveClass<span style="color:#000;font-weight:bold">(</span>javaTypeName<span style="color:#000;font-weight:bold">);</span>
        JdbcType jdbcType <span style="color:#000;font-weight:bold">=</span> resolveJdbcType<span style="color:#000;font-weight:bold">(</span>jdbcTypeName<span style="color:#000;font-weight:bold">);</span>
        Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> typeHandlerClass <span style="color:#000;font-weight:bold">=</span> resolveClass<span style="color:#000;font-weight:bold">(</span>handlerTypeName<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>javaTypeClass <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>jdbcType <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            typeHandlerRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>javaTypeClass<span style="color:#000;font-weight:bold">,</span> typeHandlerClass<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            typeHandlerRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>javaTypeClass<span style="color:#000;font-weight:bold">,</span> jdbcType<span style="color:#000;font-weight:bold">,</span> typeHandlerClass<span style="color:#000;font-weight:bold">);</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
          typeHandlerRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">register</span><span style="color:#000;font-weight:bold">(</span>typeHandlerClass<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">mapperElement</span><span style="color:#000;font-weight:bold">(</span>XNode parent<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Exception <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parent <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>XNode child <span style="color:#000;font-weight:bold">:</span> parent<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildren</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 如果配置的是包则扫描包
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;package&#34;</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
        String mapperPackage <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;name&#34;</span><span style="color:#000;font-weight:bold">);</span>
        configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addMappers</span><span style="color:#000;font-weight:bold">(</span>mapperPackage<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 否则根据 resource， url 或 class 属性逐个解析配置
</span><span style="color:#998;font-style:italic"></span>        String resource <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;resource&#34;</span><span style="color:#000;font-weight:bold">);</span>
        String url <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;url&#34;</span><span style="color:#000;font-weight:bold">);</span>
        String mapperClass <span style="color:#000;font-weight:bold">=</span> child<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;class&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resource <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> mapperClass <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">resource</span><span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">);</span>
          InputStream inputStream <span style="color:#000;font-weight:bold">=</span> Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResourceAsStream</span><span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">);</span>
          XMLMapperBuilder mapperParser <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> XMLMapperBuilder<span style="color:#000;font-weight:bold">(</span>inputStream<span style="color:#000;font-weight:bold">,</span> configuration<span style="color:#000;font-weight:bold">,</span> resource<span style="color:#000;font-weight:bold">,</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSqlFragments</span><span style="color:#000;font-weight:bold">());</span>
          mapperParser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resource <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> url <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> mapperClass <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">resource</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
          InputStream inputStream <span style="color:#000;font-weight:bold">=</span> Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUrlAsStream</span><span style="color:#000;font-weight:bold">(</span>url<span style="color:#000;font-weight:bold">);</span>
          XMLMapperBuilder mapperParser <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> XMLMapperBuilder<span style="color:#000;font-weight:bold">(</span>inputStream<span style="color:#000;font-weight:bold">,</span> configuration<span style="color:#000;font-weight:bold">,</span> url<span style="color:#000;font-weight:bold">,</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSqlFragments</span><span style="color:#000;font-weight:bold">());</span>
          mapperParser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parse</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resource <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> url <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> mapperClass <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> mapperInterface <span style="color:#000;font-weight:bold">=</span> Resources<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">classForName</span><span style="color:#000;font-weight:bold">(</span>mapperClass<span style="color:#000;font-weight:bold">);</span>
          configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addMapper</span><span style="color:#000;font-weight:bold">(</span>mapperInterface<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;A mapper element may only specify a url, resource or class, but not more than one.&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#998;font-style:italic">// 上面最终会调用两个方法分别是 XMLMapperBuilder 和 MapperAnnotationBuilder 其实就是一个处理类一个处理 xml 文件
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#998;font-style:italic">// 两者处理过程类似。只不过是前者从 xml 读取信息，后者从 注解上获取信息
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// XMLMapperBuilder
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">parse</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 防止多次加载
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isResourceLoaded</span><span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 解析 Mapper
</span><span style="color:#998;font-style:italic"></span>    configurationElement<span style="color:#000;font-weight:bold">(</span>parser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/mapper&#34;</span><span style="color:#000;font-weight:bold">));</span>
    configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addLoadedResource</span><span style="color:#000;font-weight:bold">(</span>resource<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 绑定 Mapper 和 namespace
</span><span style="color:#998;font-style:italic"></span>    bindMapperForNamespace<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 解析因为异常没能完整解析的部分
</span><span style="color:#998;font-style:italic"></span>  parsePendingResultMaps<span style="color:#000;font-weight:bold">();</span>
  parsePendingCacheRefs<span style="color:#000;font-weight:bold">();</span>
  parsePendingStatements<span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">configurationElement</span><span style="color:#000;font-weight:bold">(</span>XNode context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 获取命名空间
</span><span style="color:#998;font-style:italic"></span>    String namespace <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>namespace <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> namespace<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Mapper&#39;s namespace cannot be empty&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    builderAssistant<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setCurrentNamespace</span><span style="color:#000;font-weight:bold">(</span>namespace<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 解析 cache-ref 多个 Mapper 共享 cache 的时候配置
</span><span style="color:#998;font-style:italic"></span>    cacheRefElement<span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;cache-ref&#34;</span><span style="color:#000;font-weight:bold">));</span>
    cacheElement<span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;cache&#34;</span><span style="color:#000;font-weight:bold">));</span>
    parameterMapElement<span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/mapper/parameterMap&#34;</span><span style="color:#000;font-weight:bold">));</span>
    resultMapElements<span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/mapper/resultMap&#34;</span><span style="color:#000;font-weight:bold">));</span>
    sqlElement<span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/mapper/sql&#34;</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#998;font-style:italic">// 生成 statement
</span><span style="color:#998;font-style:italic"></span>    buildStatementFromContext<span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">evalNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;select|insert|update|delete&#34;</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BuilderException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error parsing Mapper XML. The XML location is &#39;&#34;</span> <span style="color:#000;font-weight:bold">+</span> resource <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;&#39;. Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 获取 Cache 的属性并生成一个  Cache 放到 config 上，这里也可以看出 cache 属性的默认值
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">cacheElement</span><span style="color:#000;font-weight:bold">(</span>XNode context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>context <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    String type <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;type&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;PERPETUAL&#34;</span><span style="color:#000;font-weight:bold">);</span>
    Class<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> Cache<span style="color:#000;font-weight:bold">&gt;</span> typeClass <span style="color:#000;font-weight:bold">=</span> typeAliasRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">resolveAlias</span><span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">);</span>
    String eviction <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;eviction&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;LRU&#34;</span><span style="color:#000;font-weight:bold">);</span>
    Class<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> Cache<span style="color:#000;font-weight:bold">&gt;</span> evictionClass <span style="color:#000;font-weight:bold">=</span> typeAliasRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">resolveAlias</span><span style="color:#000;font-weight:bold">(</span>eviction<span style="color:#000;font-weight:bold">);</span>
    Long flushInterval <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLongAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;flushInterval&#34;</span><span style="color:#000;font-weight:bold">);</span>
    Integer size <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIntAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;size&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#458;font-weight:bold">boolean</span> readWrite <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">!</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBooleanAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;readOnly&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#458;font-weight:bold">boolean</span> blocking <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBooleanAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;blocking&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
    Properties props <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getChildrenAsProperties</span><span style="color:#000;font-weight:bold">();</span>
    builderAssistant<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">useNewCache</span><span style="color:#000;font-weight:bold">(</span>typeClass<span style="color:#000;font-weight:bold">,</span> evictionClass<span style="color:#000;font-weight:bold">,</span> flushInterval<span style="color:#000;font-weight:bold">,</span> size<span style="color:#000;font-weight:bold">,</span> readWrite<span style="color:#000;font-weight:bold">,</span> blocking<span style="color:#000;font-weight:bold">,</span> props<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#998;font-style:italic">// 生成 statement
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">buildStatementFromContext</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>XNode<span style="color:#000;font-weight:bold">&gt;</span> list<span style="color:#000;font-weight:bold">,</span> String requiredDatabaseId<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>XNode context <span style="color:#000;font-weight:bold">:</span> list<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">final</span> XMLStatementBuilder statementParser <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> XMLStatementBuilder<span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">,</span> builderAssistant<span style="color:#000;font-weight:bold">,</span> context<span style="color:#000;font-weight:bold">,</span> requiredDatabaseId<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      statementParser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parseStatementNode</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>IncompleteElementException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addIncompleteStatement</span><span style="color:#000;font-weight:bold">(</span>statementParser<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#998;font-style:italic">// 生成 statement
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">parseStatementNode</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  String id <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
  String databaseId <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;databaseId&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 判断数据是否匹配
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>databaseIdMatchesCurrent<span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span> databaseId<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">requiredDatabaseId</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// 获取相关的属性
</span><span style="color:#998;font-style:italic"></span>  String nodeName <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNode</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getNodeName</span><span style="color:#000;font-weight:bold">();</span>
  SqlCommandType sqlCommandType <span style="color:#000;font-weight:bold">=</span> SqlCommandType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>nodeName<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toUpperCase</span><span style="color:#000;font-weight:bold">(</span>Locale<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ENGLISH</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#458;font-weight:bold">boolean</span> isSelect <span style="color:#000;font-weight:bold">=</span> sqlCommandType <span style="color:#000;font-weight:bold">==</span> SqlCommandType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SELECT</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#458;font-weight:bold">boolean</span> flushCache <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBooleanAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;flushCache&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">!</span>isSelect<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#458;font-weight:bold">boolean</span> useCache <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBooleanAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;useCache&#34;</span><span style="color:#000;font-weight:bold">,</span> isSelect<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#458;font-weight:bold">boolean</span> resultOrdered <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBooleanAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;resultOrdered&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// Include Fragments before parsing
</span><span style="color:#998;font-style:italic"></span>  XMLIncludeTransformer includeParser <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> XMLIncludeTransformer<span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">,</span> builderAssistant<span style="color:#000;font-weight:bold">);</span>
  includeParser<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">applyIncludes</span><span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNode</span><span style="color:#000;font-weight:bold">());</span>

  String parameterType <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;parameterType&#34;</span><span style="color:#000;font-weight:bold">);</span>
  Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> parameterTypeClass <span style="color:#000;font-weight:bold">=</span> resolveClass<span style="color:#000;font-weight:bold">(</span>parameterType<span style="color:#000;font-weight:bold">);</span>

  String lang <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;lang&#34;</span><span style="color:#000;font-weight:bold">);</span>
  LanguageDriver langDriver <span style="color:#000;font-weight:bold">=</span> getLanguageDriver<span style="color:#000;font-weight:bold">(</span>lang<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// Parse selectKey after includes and remove them.
</span><span style="color:#998;font-style:italic"></span>  processSelectKeyNodes<span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span> parameterTypeClass<span style="color:#000;font-weight:bold">,</span> langDriver<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)
</span><span style="color:#998;font-style:italic"></span>  KeyGenerator keyGenerator<span style="color:#000;font-weight:bold">;</span>
  String keyStatementId <span style="color:#000;font-weight:bold">=</span> id <span style="color:#000;font-weight:bold">+</span> SelectKeyGenerator<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SELECT_KEY_SUFFIX</span><span style="color:#000;font-weight:bold">;</span>
  keyStatementId <span style="color:#000;font-weight:bold">=</span> builderAssistant<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">applyCurrentNamespace</span><span style="color:#000;font-weight:bold">(</span>keyStatementId<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasKeyGenerator</span><span style="color:#000;font-weight:bold">(</span>keyStatementId<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    keyGenerator <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKeyGenerator</span><span style="color:#000;font-weight:bold">(</span>keyStatementId<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    keyGenerator <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBooleanAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;useGeneratedKeys&#34;</span><span style="color:#000;font-weight:bold">,</span>
                                               configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isUseGeneratedKeys</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> SqlCommandType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INSERT</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>sqlCommandType<span style="color:#000;font-weight:bold">))</span>
      <span style="color:#000;font-weight:bold">?</span> Jdbc3KeyGenerator<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INSTANCE</span> <span style="color:#000;font-weight:bold">:</span> NoKeyGenerator<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INSTANCE</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  SqlSource sqlSource <span style="color:#000;font-weight:bold">=</span> langDriver<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createSqlSource</span><span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">,</span> context<span style="color:#000;font-weight:bold">,</span> parameterTypeClass<span style="color:#000;font-weight:bold">);</span>
  StatementType statementType <span style="color:#000;font-weight:bold">=</span> StatementType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">valueOf</span><span style="color:#000;font-weight:bold">(</span>context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;statementType&#34;</span><span style="color:#000;font-weight:bold">,</span> StatementType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">PREPARED</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">toString</span><span style="color:#000;font-weight:bold">()));</span>
  Integer fetchSize <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIntAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;fetchSize&#34;</span><span style="color:#000;font-weight:bold">);</span>
  Integer timeout <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getIntAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;timeout&#34;</span><span style="color:#000;font-weight:bold">);</span>
  String parameterMap <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;parameterMap&#34;</span><span style="color:#000;font-weight:bold">);</span>
  String resultType <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;resultType&#34;</span><span style="color:#000;font-weight:bold">);</span>
  Class<span style="color:#000;font-weight:bold">&lt;?&gt;</span> resultTypeClass <span style="color:#000;font-weight:bold">=</span> resolveClass<span style="color:#000;font-weight:bold">(</span>resultType<span style="color:#000;font-weight:bold">);</span>
  String resultMap <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;resultMap&#34;</span><span style="color:#000;font-weight:bold">);</span>
  String resultSetType <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;resultSetType&#34;</span><span style="color:#000;font-weight:bold">);</span>
  ResultSetType resultSetTypeEnum <span style="color:#000;font-weight:bold">=</span> resolveResultSetType<span style="color:#000;font-weight:bold">(</span>resultSetType<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultSetTypeEnum <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    resultSetTypeEnum <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDefaultResultSetType</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  String keyProperty <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;keyProperty&#34;</span><span style="color:#000;font-weight:bold">);</span>
  String keyColumn <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;keyColumn&#34;</span><span style="color:#000;font-weight:bold">);</span>
  String resultSets <span style="color:#000;font-weight:bold">=</span> context<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStringAttribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;resultSets&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 根据上面的配置生成一个 statement 并放到 config 上
</span><span style="color:#998;font-style:italic"></span>  builderAssistant<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addMappedStatement</span><span style="color:#000;font-weight:bold">(</span>id<span style="color:#000;font-weight:bold">,</span> sqlSource<span style="color:#000;font-weight:bold">,</span> statementType<span style="color:#000;font-weight:bold">,</span> sqlCommandType<span style="color:#000;font-weight:bold">,</span>
                                      fetchSize<span style="color:#000;font-weight:bold">,</span> timeout<span style="color:#000;font-weight:bold">,</span> parameterMap<span style="color:#000;font-weight:bold">,</span> parameterTypeClass<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> resultTypeClass<span style="color:#000;font-weight:bold">,</span>
                                      resultSetTypeEnum<span style="color:#000;font-weight:bold">,</span> flushCache<span style="color:#000;font-weight:bold">,</span> useCache<span style="color:#000;font-weight:bold">,</span> resultOrdered<span style="color:#000;font-weight:bold">,</span>
                                      keyGenerator<span style="color:#000;font-weight:bold">,</span> keyProperty<span style="color:#000;font-weight:bold">,</span> keyColumn<span style="color:#000;font-weight:bold">,</span> databaseId<span style="color:#000;font-weight:bold">,</span> langDriver<span style="color:#000;font-weight:bold">,</span> resultSets<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="获取-sqlsession">获取 <code>SqlSession</code></h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DefaultSqlSessionFactory
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> SqlSession <span style="color:#900;font-weight:bold">openSession</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">return</span> openSessionFromDataSource<span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDefaultExecutorType</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> SqlSession <span style="color:#900;font-weight:bold">openSessionFromDataSource</span><span style="color:#000;font-weight:bold">(</span>ExecutorType execType<span style="color:#000;font-weight:bold">,</span> TransactionIsolationLevel level<span style="color:#000;font-weight:bold">,</span> <span style="color:#458;font-weight:bold">boolean</span> autoCommit<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  Transaction tx <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 从 Config 中获胜 environment，根据 environment 创建一个新的事务
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">final</span> Environment environment <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getEnvironment</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">final</span> TransactionFactory transactionFactory <span style="color:#000;font-weight:bold">=</span> getTransactionFactoryFromEnvironment<span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">);</span>
    tx <span style="color:#000;font-weight:bold">=</span> transactionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newTransaction</span><span style="color:#000;font-weight:bold">(</span>environment<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDataSource</span><span style="color:#000;font-weight:bold">(),</span> level<span style="color:#000;font-weight:bold">,</span> autoCommit<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 根据 execType 获取 Executor，默认是 SIMPLE
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">final</span> Executor executor <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newExecutor</span><span style="color:#000;font-weight:bold">(</span>tx<span style="color:#000;font-weight:bold">,</span> execType<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 把上面的信息挂到一个 DefaultSqlSession 上返回
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> DefaultSqlSession<span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">,</span> executor<span style="color:#000;font-weight:bold">,</span> autoCommit<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    closeTransaction<span style="color:#000;font-weight:bold">(</span>tx<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// may have fetched a connection so lets call close()
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">throw</span> ExceptionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">wrapException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error opening session.  Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">reset</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">public</span> Executor <span style="color:#900;font-weight:bold">newExecutor</span><span style="color:#000;font-weight:bold">(</span>Transaction transaction<span style="color:#000;font-weight:bold">,</span> ExecutorType executorType<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  executorType <span style="color:#000;font-weight:bold">=</span> executorType <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> defaultExecutorType <span style="color:#000;font-weight:bold">:</span> executorType<span style="color:#000;font-weight:bold">;</span>
  executorType <span style="color:#000;font-weight:bold">=</span> executorType <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> ExecutorType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SIMPLE</span> <span style="color:#000;font-weight:bold">:</span> executorType<span style="color:#000;font-weight:bold">;</span>
  Executor executor<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 根据 Executor Type 获取不同的 Executor
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ExecutorType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">BATCH</span> <span style="color:#000;font-weight:bold">==</span> executorType<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    executor <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BatchExecutor<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> transaction<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ExecutorType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">REUSE</span> <span style="color:#000;font-weight:bold">==</span> executorType<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    executor <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ReuseExecutor<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> transaction<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    executor <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SimpleExecutor<span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> transaction<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 如果启用了 cache 则在原本的 Executor 上包装一层
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cacheEnabled<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    executor <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CachingExecutor<span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 调用 interceptor 链处理 Executor
</span><span style="color:#998;font-style:italic"></span>  executor <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>Executor<span style="color:#000;font-weight:bold">)</span> interceptorChain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">pluginAll</span><span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> executor<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="获取代理对象">获取代理对象</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DefaultSqlSession
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> T <span style="color:#900;font-weight:bold">getMapper</span><span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> type<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">return</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMapper</span><span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// Configuration
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> T <span style="color:#900;font-weight:bold">getMapper</span><span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> type<span style="color:#000;font-weight:bold">,</span> SqlSession sqlSession<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">return</span> mapperRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMapper</span><span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">,</span> sqlSession<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// MapperRegistry
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> T <span style="color:#900;font-weight:bold">getMapper</span><span style="color:#000;font-weight:bold">(</span>Class<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> type<span style="color:#000;font-weight:bold">,</span> SqlSession sqlSession<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 根据 mapper type 获取 MapperProxyFactory
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> MapperProxyFactory<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> mapperProxyFactory <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>MapperProxyFactory<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;)</span> knownMappers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>type<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>mapperProxyFactory <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BindingException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Type &#34;</span> <span style="color:#000;font-weight:bold">+</span> type <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; is not known to the MapperRegistry.&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> mapperProxyFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newInstance</span><span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BindingException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error getting mapper instance. Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// MapperProxyFactory
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> T <span style="color:#900;font-weight:bold">newInstance</span><span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 生成一个动态代理对象
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">final</span> MapperProxy<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> mapperProxy <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> MapperProxy<span style="color:#000;font-weight:bold">&lt;&gt;(</span>sqlSession<span style="color:#000;font-weight:bold">,</span> mapperInterface<span style="color:#000;font-weight:bold">,</span> methodCache<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> newInstance<span style="color:#000;font-weight:bold">(</span>mapperProxy<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">protected</span> T <span style="color:#900;font-weight:bold">newInstance</span><span style="color:#000;font-weight:bold">(</span>MapperProxy<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> mapperProxy<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 生成代理对象并返回
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span>T<span style="color:#000;font-weight:bold">)</span> Proxy<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newProxyInstance</span><span style="color:#000;font-weight:bold">(</span>mapperInterface<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClassLoader</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">new</span> Class<span style="color:#000;font-weight:bold">[]</span> <span style="color:#000;font-weight:bold">{</span> mapperInterface <span style="color:#000;font-weight:bold">},</span> mapperProxy<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="执行方法">执行方法</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// MapperProxy
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">invoke</span><span style="color:#000;font-weight:bold">(</span>Object proxy<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>Object<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDeclaringClass</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 如果是 Object 类中定义的方法则直接放行
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">return</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isDefault</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// 如果 interface 中定义的 default 方法同样放行
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>privateLookupInMethod <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">return</span> invokeDefaultMethodJava8<span style="color:#000;font-weight:bold">(</span>proxy<span style="color:#000;font-weight:bold">,</span> method<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">return</span> invokeDefaultMethodJava9<span style="color:#000;font-weight:bold">(</span>proxy<span style="color:#000;font-weight:bold">,</span> method<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">throw</span> ExceptionUtil<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">unwrapThrowable</span><span style="color:#000;font-weight:bold">(</span>t<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  	<span style="color:#998;font-style:italic">// 缓存方法
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">final</span> MapperMethod mapperMethod <span style="color:#000;font-weight:bold">=</span> cachedMapperMethod<span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> mapperMethod<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// MapperMethod
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Object <span style="color:#900;font-weight:bold">execute</span><span style="color:#000;font-weight:bold">(</span>SqlSession sqlSession<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  Object result<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span>command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">case</span> INSERT<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 转换参数。具体流程在 MyBaits 的 SQL 映射中分析过，此处不再赘述
</span><span style="color:#998;font-style:italic"></span>      Object param <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertArgsToSqlCommandParam</span><span style="color:#000;font-weight:bold">(</span>args<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#998;font-style:italic">// 调用插入方法
</span><span style="color:#998;font-style:italic"></span>      result <span style="color:#000;font-weight:bold">=</span> rowCountResult<span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">insert</span><span style="color:#000;font-weight:bold">(</span>command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">(),</span> param<span style="color:#000;font-weight:bold">));</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">case</span> UPDATE<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      Object param <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertArgsToSqlCommandParam</span><span style="color:#000;font-weight:bold">(</span>args<span style="color:#000;font-weight:bold">);</span>
      result <span style="color:#000;font-weight:bold">=</span> rowCountResult<span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">(),</span> param<span style="color:#000;font-weight:bold">));</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">case</span> DELETE<span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      Object param <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertArgsToSqlCommandParam</span><span style="color:#000;font-weight:bold">(</span>args<span style="color:#000;font-weight:bold">);</span>
      result <span style="color:#000;font-weight:bold">=</span> rowCountResult<span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">delete</span><span style="color:#000;font-weight:bold">(</span>command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">(),</span> param<span style="color:#000;font-weight:bold">));</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">case</span> SELECT<span style="color:#000;font-weight:bold">:</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">returnsVoid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasResultHandler</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        executeWithResultHandler<span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
        result <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">returnsMany</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        result <span style="color:#000;font-weight:bold">=</span> executeForMany<span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">returnsMap</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        result <span style="color:#000;font-weight:bold">=</span> executeForMap<span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">returnsCursor</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
        result <span style="color:#000;font-weight:bold">=</span> executeForCursor<span style="color:#000;font-weight:bold">(</span>sqlSession<span style="color:#000;font-weight:bold">,</span> args<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        Object param <span style="color:#000;font-weight:bold">=</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">convertArgsToSqlCommandParam</span><span style="color:#000;font-weight:bold">(</span>args<span style="color:#000;font-weight:bold">);</span>
        result <span style="color:#000;font-weight:bold">=</span> sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectOne</span><span style="color:#000;font-weight:bold">(</span>command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">(),</span> param<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">returnsOptional</span><span style="color:#000;font-weight:bold">()</span>
            <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getReturnType</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClass</span><span style="color:#000;font-weight:bold">())))</span> <span style="color:#000;font-weight:bold">{</span>
          result <span style="color:#000;font-weight:bold">=</span> Optional<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">ofNullable</span><span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">case</span> FLUSH<span style="color:#000;font-weight:bold">:</span>
      result <span style="color:#000;font-weight:bold">=</span> sqlSession<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">flushStatements</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BindingException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Unknown execution method for: &#34;</span> <span style="color:#000;font-weight:bold">+</span> command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>result <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getReturnType</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isPrimitive</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">returnsVoid</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> BindingException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Mapper method &#39;&#34;</span> <span style="color:#000;font-weight:bold">+</span> command<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getName</span><span style="color:#000;font-weight:bold">()</span>
                               <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34; attempted to return null from a method with a primitive return type (&#34;</span> <span style="color:#000;font-weight:bold">+</span> method<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getReturnType</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;).&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> result<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="更新方法">更新方法</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DefaultSqlSession
</span><span style="color:#998;font-style:italic">// 对于 insert update delete 最终都使用这个方法
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">update</span><span style="color:#000;font-weight:bold">(</span>String statement<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    dirty <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 从 config 中根据 ID 获取 MappedStatement
</span><span style="color:#998;font-style:italic"></span>    MappedStatement ms <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMappedStatement</span><span style="color:#000;font-weight:bold">(</span>statement<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> executor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> wrapCollection<span style="color:#000;font-weight:bold">(</span>parameter<span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> ExceptionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">wrapException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error updating database.  Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">reset</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#998;font-style:italic">// 对 Collection 参数进行封装
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">private</span> Object <span style="color:#900;font-weight:bold">wrapCollection</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> Object object<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>object <span style="color:#000;font-weight:bold">instanceof</span> Collection<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    StrictMap<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StrictMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
    map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;collection&#34;</span><span style="color:#000;font-weight:bold">,</span> object<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>object <span style="color:#000;font-weight:bold">instanceof</span> List<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span> object<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>object <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> object<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClass</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">isArray</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    StrictMap<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> map <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StrictMap<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
    map<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;array&#34;</span><span style="color:#000;font-weight:bold">,</span> object<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> map<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> object<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// CachingExecutor
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">update</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameterObject<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 刷新缓存
</span><span style="color:#998;font-style:italic"></span>  flushCacheIfRequired<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 使用 Executor 真正的去 update
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> delegate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameterObject<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// BaseExecutor
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">update</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">resource</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResource</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">activity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;executing an update&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">object</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>closed<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ExecutorException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Executor was closed.&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 清理一级缓存
</span><span style="color:#998;font-style:italic"></span>  clearLocalCache<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">return</span> doUpdate<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// SimpleExecutor
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">doUpdate</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  Statement stmt <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 获取 configuration
</span><span style="color:#998;font-style:italic"></span>    Configuration configuration <span style="color:#000;font-weight:bold">=</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConfiguration</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 获取 StatementHandler
</span><span style="color:#998;font-style:italic"></span>    StatementHandler handler <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newStatementHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> RowBounds<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// Prepare Statement
</span><span style="color:#998;font-style:italic"></span>    stmt <span style="color:#000;font-weight:bold">=</span> prepareStatement<span style="color:#000;font-weight:bold">(</span>handler<span style="color:#000;font-weight:bold">,</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatementLog</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">return</span> handler<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">update</span><span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    closeStatement<span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">private</span> Statement <span style="color:#900;font-weight:bold">prepareStatement</span><span style="color:#000;font-weight:bold">(</span>StatementHandler handler<span style="color:#000;font-weight:bold">,</span> Log statementLog<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  Statement stmt<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 获取连接
</span><span style="color:#998;font-style:italic"></span>  Connection connection <span style="color:#000;font-weight:bold">=</span> getConnection<span style="color:#000;font-weight:bold">(</span>statementLog<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// prepare statement
</span><span style="color:#998;font-style:italic"></span>  stmt <span style="color:#000;font-weight:bold">=</span> handler<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">prepare</span><span style="color:#000;font-weight:bold">(</span>connection<span style="color:#000;font-weight:bold">,</span> transaction<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTimeout</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#998;font-style:italic">// 设置参数
</span><span style="color:#998;font-style:italic"></span>  handler<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">parameterize</span><span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> stmt<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// Configuration
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> StatementHandler <span style="color:#900;font-weight:bold">newStatementHandler</span><span style="color:#000;font-weight:bold">(</span>Executor executor<span style="color:#000;font-weight:bold">,</span> MappedStatement mappedStatement<span style="color:#000;font-weight:bold">,</span> Object parameterObject<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">,</span> BoundSql boundSql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 新建一个 StatementHandler
</span><span style="color:#998;font-style:italic"></span>  StatementHandler statementHandler <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> RoutingStatementHandler<span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">,</span> mappedStatement<span style="color:#000;font-weight:bold">,</span> parameterObject<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 使用 interceptor 修改 statement
</span><span style="color:#998;font-style:italic"></span>  statementHandler <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>StatementHandler<span style="color:#000;font-weight:bold">)</span> interceptorChain<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">pluginAll</span><span style="color:#000;font-weight:bold">(</span>statementHandler<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> statementHandler<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// RoutingStatementHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">RoutingStatementHandler</span><span style="color:#000;font-weight:bold">(</span>Executor executor<span style="color:#000;font-weight:bold">,</span> MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">,</span> BoundSql boundSql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 根据 statement 的 type 创建不同的 StatementHandler
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatementType</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">case</span> STATEMENT<span style="color:#000;font-weight:bold">:</span>
      delegate <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> SimpleStatementHandler<span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">,</span> ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">case</span> PREPARED<span style="color:#000;font-weight:bold">:</span>
      delegate <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> PreparedStatementHandler<span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">,</span> ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">case</span> CALLABLE<span style="color:#000;font-weight:bold">:</span>
      delegate <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> CallableStatementHandler<span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">,</span> ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
      <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ExecutorException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Unknown statement type: &#34;</span> <span style="color:#000;font-weight:bold">+</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatementType</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// BaseStatementHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> Statement <span style="color:#900;font-weight:bold">prepare</span><span style="color:#000;font-weight:bold">(</span>Connection connection<span style="color:#000;font-weight:bold">,</span> Integer transactionTimeout<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">sql</span><span style="color:#000;font-weight:bold">(</span>boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSql</span><span style="color:#000;font-weight:bold">());</span>
  Statement statement <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 填充 statement
</span><span style="color:#998;font-style:italic"></span>    statement <span style="color:#000;font-weight:bold">=</span> instantiateStatement<span style="color:#000;font-weight:bold">(</span>connection<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 设置超时时间
</span><span style="color:#998;font-style:italic"></span>    setStatementTimeout<span style="color:#000;font-weight:bold">(</span>statement<span style="color:#000;font-weight:bold">,</span> transactionTimeout<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 设置获取 size
</span><span style="color:#998;font-style:italic"></span>    setFetchSize<span style="color:#000;font-weight:bold">(</span>statement<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">return</span> statement<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>SQLException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    closeStatement<span style="color:#000;font-weight:bold">(</span>statement<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">throw</span> e<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    closeStatement<span style="color:#000;font-weight:bold">(</span>statement<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ExecutorException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error preparing statement.  Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DefaultParameterHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">setParameters</span><span style="color:#000;font-weight:bold">(</span>PreparedStatement ps<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">activity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;setting parameters&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">object</span><span style="color:#000;font-weight:bold">(</span>mappedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterMap</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#998;font-style:italic">// 获取参数的列表
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>ParameterMapping<span style="color:#000;font-weight:bold">&gt;</span> parameterMappings <span style="color:#000;font-weight:bold">=</span> boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterMappings</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parameterMappings <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span> i <span style="color:#000;font-weight:bold">&lt;</span> parameterMappings<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">();</span> i<span style="color:#000;font-weight:bold">++)</span> <span style="color:#000;font-weight:bold">{</span>
      ParameterMapping parameterMapping <span style="color:#000;font-weight:bold">=</span> parameterMappings<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>i<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parameterMapping<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMode</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">!=</span> ParameterMode<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">OUT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        Object value<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#998;font-style:italic">// 获取属性名
</span><span style="color:#998;font-style:italic"></span>        String propertyName <span style="color:#000;font-weight:bold">=</span> parameterMapping<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getProperty</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasAdditionalParameter</span><span style="color:#000;font-weight:bold">(</span>propertyName<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#998;font-style:italic">// issue #448 ask first for additional params
</span><span style="color:#998;font-style:italic"></span>          value <span style="color:#000;font-weight:bold">=</span> boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getAdditionalParameter</span><span style="color:#000;font-weight:bold">(</span>propertyName<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parameterObject <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          value <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>typeHandlerRegistry<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasTypeHandler</span><span style="color:#000;font-weight:bold">(</span>parameterObject<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClass</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
          value <span style="color:#000;font-weight:bold">=</span> parameterObject<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#998;font-style:italic">// 从参数中获取 value
</span><span style="color:#998;font-style:italic"></span>          MetaObject metaObject <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newMetaObject</span><span style="color:#000;font-weight:bold">(</span>parameterObject<span style="color:#000;font-weight:bold">);</span>
          value <span style="color:#000;font-weight:bold">=</span> metaObject<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getValue</span><span style="color:#000;font-weight:bold">(</span>propertyName<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#998;font-style:italic">// 获取 TypeHandler
</span><span style="color:#998;font-style:italic"></span>        TypeHandler typeHandler <span style="color:#000;font-weight:bold">=</span> parameterMapping<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getTypeHandler</span><span style="color:#000;font-weight:bold">();</span>
        JdbcType jdbcType <span style="color:#000;font-weight:bold">=</span> parameterMapping<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getJdbcType</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#998;font-style:italic">// 获取为 null 的时候对应的 jdbcType
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>value <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> jdbcType <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          jdbcType <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getJdbcTypeForNull</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#998;font-style:italic">// 根据不同的 JDBC Type 调用各自的方法设置 value
</span><span style="color:#998;font-style:italic"></span>          typeHandler<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setParameter</span><span style="color:#000;font-weight:bold">(</span>ps<span style="color:#000;font-weight:bold">,</span> i <span style="color:#000;font-weight:bold">+</span> 1<span style="color:#000;font-weight:bold">,</span> value<span style="color:#000;font-weight:bold">,</span> jdbcType<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>TypeException <span style="color:#000;font-weight:bold">|</span> SQLException e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> TypeException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Could not set parameters for mapping: &#34;</span> <span style="color:#000;font-weight:bold">+</span> parameterMapping <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;. Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// PreparedStatementHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">update</span><span style="color:#000;font-weight:bold">(</span>Statement statement<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 转换 statement 并执行
</span><span style="color:#998;font-style:italic"></span>  PreparedStatement ps <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement<span style="color:#000;font-weight:bold">)</span> statement<span style="color:#000;font-weight:bold">;</span>
  ps<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 获取更新的 Count
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">int</span> rows <span style="color:#000;font-weight:bold">=</span> ps<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getUpdateCount</span><span style="color:#000;font-weight:bold">();</span>
  Object parameterObject <span style="color:#000;font-weight:bold">=</span> boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterObject</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 获取主键设置到参数对象上
</span><span style="color:#998;font-style:italic"></span>  KeyGenerator keyGenerator <span style="color:#000;font-weight:bold">=</span> mappedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getKeyGenerator</span><span style="color:#000;font-weight:bold">();</span>
  keyGenerator<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">processAfter</span><span style="color:#000;font-weight:bold">(</span>executor<span style="color:#000;font-weight:bold">,</span> mappedStatement<span style="color:#000;font-weight:bold">,</span> ps<span style="color:#000;font-weight:bold">,</span> parameterObject<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> rows<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="查询方法">查询方法</h4>
<p>返回单个元素和返回一个 List 的执行方法几乎一致，只是单个元素在返回前从 List 中 取出第一个返回。对于返回 Map 略有不同，主要区别是在 List  查询之后会根据设置的条件进行 List 转 Map的操作。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DefaultSqlSession
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> T <span style="color:#900;font-weight:bold">selectOne</span><span style="color:#000;font-weight:bold">(</span>String statement<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 调用 select list 取第一个返回，数量超过 1 则抛出异常
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> list <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">selectList</span><span style="color:#000;font-weight:bold">(</span>statement<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 1<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> TooManyResultsException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Expected one result (or null) to be returned by selectOne(), but found: &#34;</span> <span style="color:#000;font-weight:bold">+</span> list<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">selectList</span><span style="color:#000;font-weight:bold">(</span>String statement<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 从 config 中获取 MappedStatement
</span><span style="color:#998;font-style:italic"></span>    MappedStatement ms <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getMappedStatement</span><span style="color:#000;font-weight:bold">(</span>statement<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 执行查询方法
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> executor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> wrapCollection<span style="color:#000;font-weight:bold">(</span>parameter<span style="color:#000;font-weight:bold">),</span> rowBounds<span style="color:#000;font-weight:bold">,</span> Executor<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NO_RESULT_HANDLER</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> ExceptionFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">wrapException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Error querying database.  Cause: &#34;</span> <span style="color:#000;font-weight:bold">+</span> e<span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">reset</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// CachingExecutor
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">query</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameterObject<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 获取关联的 SQL
</span><span style="color:#998;font-style:italic"></span>  BoundSql boundSql <span style="color:#000;font-weight:bold">=</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBoundSql</span><span style="color:#000;font-weight:bold">(</span>parameterObject<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#998;font-style:italic">// 根据传入的参数生成一个 cacheKey
</span><span style="color:#998;font-style:italic"></span>  CacheKey key <span style="color:#000;font-weight:bold">=</span> createCacheKey<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameterObject<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> query<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameterObject<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">query</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameterObject<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">,</span> CacheKey key<span style="color:#000;font-weight:bold">,</span> BoundSql boundSql<span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 从 Statement 获取 cache
</span><span style="color:#998;font-style:italic"></span>  Cache cache <span style="color:#000;font-weight:bold">=</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCache</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>cache <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 刷新缓存
</span><span style="color:#998;font-style:italic"></span>    flushCacheIfRequired<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isUseCache</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> resultHandler <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      ensureNoOutParams<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#3c5d5d;font-weight:bold">@SuppressWarnings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;unchecked&#34;</span><span style="color:#000;font-weight:bold">)</span>
      <span style="color:#998;font-style:italic">// 从 TransactionalCacheManager 根据 cache 和 key 获取结果
</span><span style="color:#998;font-style:italic"></span>      List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> list <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;)</span> tcm<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getObject</span><span style="color:#000;font-weight:bold">(</span>cache<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>list <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        list <span style="color:#000;font-weight:bold">=</span> delegate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameterObject<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#998;font-style:italic">// 将查询结果放到 cache 中
</span><span style="color:#998;font-style:italic"></span>        tcm<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putObject</span><span style="color:#000;font-weight:bold">(</span>cache<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> list<span style="color:#000;font-weight:bold">);</span> <span style="color:#998;font-style:italic">// issue #578 and #116
</span><span style="color:#998;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">return</span> list<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> delegate<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameterObject<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// MappedStatement
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> BoundSql <span style="color:#900;font-weight:bold">getBoundSql</span><span style="color:#000;font-weight:bold">(</span>Object parameterObject<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#998;font-style:italic">// 根据参数信息生成 BoundSql
</span><span style="color:#998;font-style:italic"></span>  BoundSql boundSql <span style="color:#000;font-weight:bold">=</span> sqlSource<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getBoundSql</span><span style="color:#000;font-weight:bold">(</span>parameterObject<span style="color:#000;font-weight:bold">);</span>
  List<span style="color:#000;font-weight:bold">&lt;</span>ParameterMapping<span style="color:#000;font-weight:bold">&gt;</span> parameterMappings <span style="color:#000;font-weight:bold">=</span> boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterMappings</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parameterMappings <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">||</span> parameterMappings<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isEmpty</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    boundSql <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> BoundSql<span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getSql</span><span style="color:#000;font-weight:bold">(),</span> parameterMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterMappings</span><span style="color:#000;font-weight:bold">(),</span> parameterObject<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#998;font-style:italic">// check for nested result maps in parameter mappings (issue #30)
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>ParameterMapping pm <span style="color:#000;font-weight:bold">:</span> boundSql<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getParameterMappings</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    String rmId <span style="color:#000;font-weight:bold">=</span> pm<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultMapId</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>rmId <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      ResultMap rm <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultMap</span><span style="color:#000;font-weight:bold">(</span>rmId<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>rm <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        hasNestedResultMaps <span style="color:#000;font-weight:bold">|=</span> rm<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasNestedResultMaps</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">return</span> boundSql<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// BaseExecutor
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">query</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">,</span> CacheKey key<span style="color:#000;font-weight:bold">,</span> BoundSql boundSql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">resource</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResource</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">activity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;executing a query&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">object</span><span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>closed<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">throw</span> <span style="color:#000;font-weight:bold">new</span> ExecutorException<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Executor was closed.&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>queryStack <span style="color:#000;font-weight:bold">==</span> 0 <span style="color:#000;font-weight:bold">&amp;&amp;</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isFlushCacheRequired</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    clearLocalCache<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
  List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> list<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    queryStack<span style="color:#000;font-weight:bold">++;</span>
    <span style="color:#998;font-style:italic">// 尝试从 cache 中获取
</span><span style="color:#998;font-style:italic"></span>    list <span style="color:#000;font-weight:bold">=</span> resultHandler <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;)</span> localCache<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getObject</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>list <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// 处理从 cache 中获取的结果
</span><span style="color:#998;font-style:italic"></span>      handleLocallyCachedOutputParameters<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      list <span style="color:#000;font-weight:bold">=</span> queryFromDatabase<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> key<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    queryStack<span style="color:#000;font-weight:bold">--;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>queryStack <span style="color:#000;font-weight:bold">==</span> 0<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span>DeferredLoad deferredLoad <span style="color:#000;font-weight:bold">:</span> deferredLoads<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      deferredLoad<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">load</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// issue #601
</span><span style="color:#998;font-style:italic"></span>    deferredLoads<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">clear</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getLocalCacheScope</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> LocalCacheScope<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">STATEMENT</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#998;font-style:italic">// issue #482
</span><span style="color:#998;font-style:italic"></span>      clearLocalCache<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> list<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">queryFromDatabase</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">,</span> CacheKey key<span style="color:#000;font-weight:bold">,</span> BoundSql boundSql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> list
  localCache<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putObject</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> EXECUTION_PLACEHOLDER<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 执行 Query 方法
</span><span style="color:#998;font-style:italic"></span>    list <span style="color:#000;font-weight:bold">=</span> doQuery<span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    localCache<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">removeObject</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#998;font-style:italic">// 把结果放到缓存中
</span><span style="color:#998;font-style:italic"></span>  localCache<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putObject</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> list<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatementType</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">==</span> StatementType<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CALLABLE</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    localOutputParameterCache<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">putObject</span><span style="color:#000;font-weight:bold">(</span>key<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> list<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// SimpleExecutor
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">doQuery</span><span style="color:#000;font-weight:bold">(</span>MappedStatement ms<span style="color:#000;font-weight:bold">,</span> Object parameter<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">,</span> BoundSql boundSql<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  Statement stmt <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 获取 Config
</span><span style="color:#998;font-style:italic"></span>    Configuration configuration <span style="color:#000;font-weight:bold">=</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getConfiguration</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#998;font-style:italic">// 获取 StatementHandler
</span><span style="color:#998;font-style:italic"></span>    StatementHandler handler <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newStatementHandler</span><span style="color:#000;font-weight:bold">(</span>wrapper<span style="color:#000;font-weight:bold">,</span> ms<span style="color:#000;font-weight:bold">,</span> parameter<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> boundSql<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 准备 statement 设置参数
</span><span style="color:#998;font-style:italic"></span>    stmt <span style="color:#000;font-weight:bold">=</span> prepareStatement<span style="color:#000;font-weight:bold">(</span>handler<span style="color:#000;font-weight:bold">,</span> ms<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getStatementLog</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#998;font-style:italic">// 执行查询
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> handler<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">query</span><span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    closeStatement<span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// PreparedStatementHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> List<span style="color:#000;font-weight:bold">&lt;</span>E<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">query</span><span style="color:#000;font-weight:bold">(</span>Statement statement<span style="color:#000;font-weight:bold">,</span> ResultHandler resultHandler<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  PreparedStatement ps <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span>PreparedStatement<span style="color:#000;font-weight:bold">)</span> statement<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 执行 sql
</span><span style="color:#998;font-style:italic"></span>  ps<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">execute</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 处理结果
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">return</span> resultSetHandler<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">handleResultSets</span><span style="color:#000;font-weight:bold">(</span>ps<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// DefaultResultSetHandler
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">public</span> List<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">handleResultSets</span><span style="color:#000;font-weight:bold">(</span>Statement stmt<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  ErrorContext<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">instance</span><span style="color:#000;font-weight:bold">().</span><span style="color:#008080">activity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;handling results&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">object</span><span style="color:#000;font-weight:bold">(</span>mappedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getId</span><span style="color:#000;font-weight:bold">());</span>

  <span style="color:#000;font-weight:bold">final</span> List<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> multipleResults <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>

  <span style="color:#458;font-weight:bold">int</span> resultSetCount <span style="color:#000;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
  <span style="color:#998;font-style:italic">// 获取 result
</span><span style="color:#998;font-style:italic"></span>  ResultSetWrapper rsw <span style="color:#000;font-weight:bold">=</span> getFirstResultSet<span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">);</span>

  <span style="color:#998;font-style:italic">// 获取 result map
</span><span style="color:#998;font-style:italic"></span>  List<span style="color:#000;font-weight:bold">&lt;</span>ResultMap<span style="color:#000;font-weight:bold">&gt;</span> resultMaps <span style="color:#000;font-weight:bold">=</span> mappedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultMaps</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#458;font-weight:bold">int</span> resultMapCount <span style="color:#000;font-weight:bold">=</span> resultMaps<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">();</span>
  validateResultMapsCount<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMapCount<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>rsw <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> resultMapCount <span style="color:#000;font-weight:bold">&gt;</span> resultSetCount<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// 遍历获取 resultMap
</span><span style="color:#998;font-style:italic"></span>    ResultMap resultMap <span style="color:#000;font-weight:bold">=</span> resultMaps<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>resultSetCount<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 处理结果
</span><span style="color:#998;font-style:italic"></span>    handleResultSet<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> multipleResults<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
    rsw <span style="color:#000;font-weight:bold">=</span> getNextResultSet<span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">);</span>
    cleanUpAfterHandlingResultSet<span style="color:#000;font-weight:bold">();</span>
    resultSetCount<span style="color:#000;font-weight:bold">++;</span>
  <span style="color:#000;font-weight:bold">}</span>

  String<span style="color:#000;font-weight:bold">[]</span> resultSets <span style="color:#000;font-weight:bold">=</span> mappedStatement<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultSets</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultSets <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>rsw <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> resultSetCount <span style="color:#000;font-weight:bold">&lt;</span> resultSets<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      ResultMapping parentMapping <span style="color:#000;font-weight:bold">=</span> nextResultMaps<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>resultSets<span style="color:#000;font-weight:bold">[</span>resultSetCount<span style="color:#000;font-weight:bold">]);</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parentMapping <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        String nestedResultMapId <span style="color:#000;font-weight:bold">=</span> parentMapping<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getNestedResultMapId</span><span style="color:#000;font-weight:bold">();</span>
        ResultMap resultMap <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultMap</span><span style="color:#000;font-weight:bold">(</span>nestedResultMapId<span style="color:#000;font-weight:bold">);</span>
        handleResultSet<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> parentMapping<span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
      rsw <span style="color:#000;font-weight:bold">=</span> getNextResultSet<span style="color:#000;font-weight:bold">(</span>stmt<span style="color:#000;font-weight:bold">);</span>
      cleanUpAfterHandlingResultSet<span style="color:#000;font-weight:bold">();</span>
      resultSetCount<span style="color:#000;font-weight:bold">++;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000;font-weight:bold">return</span> collapseSingleResultList<span style="color:#000;font-weight:bold">(</span>multipleResults<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">handleResultSet</span><span style="color:#000;font-weight:bold">(</span>ResultSetWrapper rsw<span style="color:#000;font-weight:bold">,</span> ResultMap resultMap<span style="color:#000;font-weight:bold">,</span> List<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> multipleResults<span style="color:#000;font-weight:bold">,</span> ResultMapping parentMapping<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>parentMapping <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      handleRowValues<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> RowBounds<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">DEFAULT</span><span style="color:#000;font-weight:bold">,</span> parentMapping<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultHandler <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        DefaultResultHandler defaultResultHandler <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultResultHandler<span style="color:#000;font-weight:bold">(</span>objectFactory<span style="color:#000;font-weight:bold">);</span>
        handleRowValues<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> defaultResultHandler<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
        multipleResults<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>defaultResultHandler<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultList</span><span style="color:#000;font-weight:bold">());</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        handleRowValues<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// issue #228 (close resultsets)
</span><span style="color:#998;font-style:italic"></span>    closeResultSet<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultSet</span><span style="color:#000;font-weight:bold">());</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">handleRowValues</span><span style="color:#000;font-weight:bold">(</span>ResultSetWrapper rsw<span style="color:#000;font-weight:bold">,</span> ResultMap resultMap<span style="color:#000;font-weight:bold">,</span> ResultHandler<span style="color:#000;font-weight:bold">&lt;?&gt;</span> resultHandler<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultMapping parentMapping<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasNestedResultMaps</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    ensureNoRowBounds<span style="color:#000;font-weight:bold">();</span>
    checkResultHandler<span style="color:#000;font-weight:bold">();</span>
    handleRowValuesForNestedResultMap<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> parentMapping<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    handleRowValuesForSimpleResultMap<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> resultHandler<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">,</span> parentMapping<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">handleRowValuesForSimpleResultMap</span><span style="color:#000;font-weight:bold">(</span>ResultSetWrapper rsw<span style="color:#000;font-weight:bold">,</span> ResultMap resultMap<span style="color:#000;font-weight:bold">,</span> ResultHandler<span style="color:#000;font-weight:bold">&lt;?&gt;</span> resultHandler<span style="color:#000;font-weight:bold">,</span> RowBounds rowBounds<span style="color:#000;font-weight:bold">,</span> ResultMapping parentMapping<span style="color:#000;font-weight:bold">)</span>
      <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  DefaultResultContext<span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span> resultContext <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DefaultResultContext<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
  ResultSet resultSet <span style="color:#000;font-weight:bold">=</span> rsw<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getResultSet</span><span style="color:#000;font-weight:bold">();</span>
  skipRows<span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>shouldProcessMoreRows<span style="color:#000;font-weight:bold">(</span>resultContext<span style="color:#000;font-weight:bold">,</span> rowBounds<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isClosed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> resultSet<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">// Resolve Discriminated ResultMap
</span><span style="color:#998;font-style:italic"></span>    ResultMap discriminatedResultMap <span style="color:#000;font-weight:bold">=</span> resolveDiscriminatedResultMap<span style="color:#000;font-weight:bold">(</span>resultSet<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 获取结果
</span><span style="color:#998;font-style:italic"></span>    Object rowValue <span style="color:#000;font-weight:bold">=</span> getRowValue<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> discriminatedResultMap<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#998;font-style:italic">// 存储结果
</span><span style="color:#998;font-style:italic"></span>    storeObject<span style="color:#000;font-weight:bold">(</span>resultHandler<span style="color:#000;font-weight:bold">,</span> resultContext<span style="color:#000;font-weight:bold">,</span> rowValue<span style="color:#000;font-weight:bold">,</span> parentMapping<span style="color:#000;font-weight:bold">,</span> resultSet<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000;font-weight:bold">private</span> Object <span style="color:#900;font-weight:bold">getRowValue</span><span style="color:#000;font-weight:bold">(</span>ResultSetWrapper rsw<span style="color:#000;font-weight:bold">,</span> ResultMap resultMap<span style="color:#000;font-weight:bold">,</span> String columnPrefix<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> SQLException <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">final</span> ResultLoaderMap lazyLoader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ResultLoaderMap<span style="color:#000;font-weight:bold">();</span>
  <span style="color:#998;font-style:italic">// 创建结果对象
</span><span style="color:#998;font-style:italic"></span>  Object rowValue <span style="color:#000;font-weight:bold">=</span> createResultObject<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> lazyLoader<span style="color:#000;font-weight:bold">,</span> columnPrefix<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>rowValue <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>hasTypeHandlerForResultObject<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getType</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">final</span> MetaObject metaObject <span style="color:#000;font-weight:bold">=</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newMetaObject</span><span style="color:#000;font-weight:bold">(</span>rowValue<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#458;font-weight:bold">boolean</span> foundValues <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">useConstructorMappings</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#998;font-style:italic">// 自动赋值
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>shouldApplyAutomaticMappings<span style="color:#000;font-weight:bold">(</span>resultMap<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      foundValues <span style="color:#000;font-weight:bold">=</span> applyAutomaticMappings<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> metaObject<span style="color:#000;font-weight:bold">,</span> columnPrefix<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> foundValues<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#998;font-style:italic">// 根据自定义 mapping 中获取设置属性值
</span><span style="color:#998;font-style:italic"></span>    foundValues <span style="color:#000;font-weight:bold">=</span> applyPropertyMappings<span style="color:#000;font-weight:bold">(</span>rsw<span style="color:#000;font-weight:bold">,</span> resultMap<span style="color:#000;font-weight:bold">,</span> metaObject<span style="color:#000;font-weight:bold">,</span> lazyLoader<span style="color:#000;font-weight:bold">,</span> columnPrefix<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">||</span> foundValues<span style="color:#000;font-weight:bold">;</span>
    foundValues <span style="color:#000;font-weight:bold">=</span> lazyLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> 0 <span style="color:#000;font-weight:bold">||</span> foundValues<span style="color:#000;font-weight:bold">;</span>
    rowValue <span style="color:#000;font-weight:bold">=</span> foundValues <span style="color:#000;font-weight:bold">||</span> configuration<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">isReturnInstanceForEmptyRow</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">?</span> rowValue <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">return</span> rowValue<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div>
        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="http://programya.com/post/DataBase/MyBatis/MyBaits-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">MyBatis 配置文件</a></li>
        
        <li><a href="http://programya.com/post/DataBase/MyBatis/MyBaits-%E7%BC%93%E5%AD%98/">MyBatis 缓存</a></li>
        
        <li><a href="http://programya.com/post/DataBase/MyBatis/MyBaits-%E5%8A%A8%E6%80%81-SQL/">MyBatis 动态 SQL</a></li>
        
        <li><a href="http://programya.com/post/DataBase/MyBatis/MyBaits-%E6%8F%92%E4%BB%B6/">MyBaits 插件</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='http://programya.com/tags/MyBaits'>MyBaits</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://programya.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-JNDI/" title="Java JNDI">Java JNDI</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-JVM/" title="Java JVM">Java JVM</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-HotSpot-GC-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/" title="Java HotSpot GC 算法实现">Java HotSpot GC 算法实现</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-GC-2/" title="Java GC 2">Java GC 2</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-GC-1/" title="Java GC 1">Java GC 1</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" title="Java 虚拟机内存模型">Java 虚拟机内存模型</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90/" title="Java 逃逸分析">Java 逃逸分析</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Spring/Spring-Security/Spring-Security/" title="Spring Security">Spring Security</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/Java/JVM/Java-%E5%9B%9B%E7%A7%8D%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" title="Java 四种引用类型">Java 四种引用类型</a>
    </li>
    
    <li>
        <a href="http://programya.com/post/%E5%BE%AE%E6%9C%8D%E5%8A%A1/dubbo/Dubbo-%E5%8E%9F%E7%90%86/" title="Dubbo 原理">Dubbo 原理</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="http://programya.com/categories/Java/">Java (22)</a></li>
    
    <li><a href="http://programya.com/categories/MQ/">MQ (3)</a></li>
    
    <li><a href="http://programya.com/categories/MyBaits/">MyBaits (7)</a></li>
    
    <li><a href="http://programya.com/categories/MySQL/">MySQL (4)</a></li>
    
    <li><a href="http://programya.com/categories/Netty/">Netty (10)</a></li>
    
    <li><a href="http://programya.com/categories/Nginx/">Nginx (2)</a></li>
    
    <li><a href="http://programya.com/categories/Redis/">Redis (2)</a></li>
    
    <li><a href="http://programya.com/categories/Spring/">Spring (37)</a></li>
    
    <li><a href="http://programya.com/categories/%E5%85%B3%E4%BA%8E/">关于 (1)</a></li>
    
    <li><a href="http://programya.com/categories/%E5%85%B6%E4%BB%96/">其他 (8)</a></li>
    
    <li><a href="http://programya.com/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 (11)</a></li>
    
    <li><a href="http://programya.com/categories/%E7%AE%97%E6%B3%95/">算法 (3)</a></li>
    
    <li><a href="http://programya.com/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (7)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="http://programya.com/tags/Active-MQ/">Active MQ</a>
    
    <a href="http://programya.com/tags/Cookie/">Cookie</a>
    
    <a href="http://programya.com/tags/Debug/">Debug</a>
    
    <a href="http://programya.com/tags/Docker/">Docker</a>
    
    <a href="http://programya.com/tags/Dubbo/">Dubbo</a>
    
    <a href="http://programya.com/tags/Git/">Git</a>
    
    <a href="http://programya.com/tags/JDK8/">JDK8</a>
    
    <a href="http://programya.com/tags/JPA/">JPA</a>
    
    <a href="http://programya.com/tags/JUC/">JUC</a>
    
    <a href="http://programya.com/tags/JVM/">JVM</a>
    
    <a href="http://programya.com/tags/java/">java</a>
    
    <a href="http://programya.com/tags/Jenkins/">Jenkins</a>
    
    <a href="http://programya.com/tags/Kafka/">Kafka</a>
    
    <a href="http://programya.com/tags/Kubernetes/">Kubernetes</a>
    
    <a href="http://programya.com/tags/Linux/">Linux</a>
    
    <a href="http://programya.com/tags/Maven/">Maven</a>
    
    <a href="http://programya.com/tags/MyBaits/">MyBaits</a>
    
    <a href="http://programya.com/tags/MySQL/">MySQL</a>
    
    <a href="http://programya.com/tags/Netty/">Netty</a>
    
    <a href="http://programya.com/tags/Nginx/">Nginx</a>
    
    <a href="http://programya.com/tags/Rabbit-MQ/">Rabbit MQ</a>
    
    <a href="http://programya.com/tags/Redis/">Redis</a>
    
    <a href="http://programya.com/tags/Rocket-MQ/">Rocket MQ</a>
    
    <a href="http://programya.com/tags/Session/">Session</a>
    
    <a href="http://programya.com/tags/Spring/">Spring</a>
    
    <a href="http://programya.com/tags/Spring-Boot/">Spring Boot</a>
    
    <a href="http://programya.com/tags/Spring-Cloud/">Spring Cloud</a>
    
    <a href="http://programya.com/tags/Spring-Data/">Spring Data</a>
    
    <a href="http://programya.com/tags/Spring-MVC/">Spring MVC</a>
    
    <a href="http://programya.com/tags/Spring-Security/">Spring Security</a>
    
    <a href="http://programya.com/tags/Spring-%E6%B3%A8%E8%A7%A3/">Spring 注解</a>
    
    <a href="http://programya.com/tags/Tmux/">Tmux</a>
    
    <a href="http://programya.com/tags/Zookeeper/">Zookeeper</a>
    
    <a href="http://programya.com/tags/java/">java</a>
    
    <a href="http://programya.com/tags/%E4%BB%A3%E7%A0%81/">代码</a>
    
    <a href="http://programya.com/tags/%E5%85%B3%E4%BA%8E/">关于</a>
    
    <a href="http://programya.com/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>
    
    <a href="http://programya.com/tags/%E6%BA%90%E7%A0%81/">源码</a>
    
    <a href="http://programya.com/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
    <a href="http://programya.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
    
    <a href="http://programya.com/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a>
    
    <a href="http://programya.com/tags/%E9%9B%86%E5%90%88/">集合</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://programya.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="http://programya.com/">新月的博客 By 新月</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        Theme based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='http://programya.com/js/totop.js?v=0.0.0' async=""></script>






</body>

</html>